function Endpoint(){Emitter.call(this),this.vms=new FastMap,this.vms.set(system.name,system),this.initTimeout=null;var n=require("path"),e=require("fs");this.defaultConfig=require("./config.json"),log.info("Load internal config file");var t=n.resolve("./config.json");try{e.accessSync(t);var i=require(t),o=deepExtend({},this.defaultConfig);this.defaultConfig=deepExtend(o,i),log.info("Load external config file at ",t)}catch(s){log.info("Can not found external config file at %s.",t)}}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),FastMap=require("collections/fast-map"),deepExtend=require("deep-extend"),system=require("./lib/model/system")(),Exception=require("./lib/Exception"),blinkFactory=require("./lib/BlinkChannel"),dataFactory=require("./lib/DataChannel"),consts=require("./lib/utils/const"),extend=require("./lib/utils/extend"),curry=require("./lib/utils/curry"),fastGet=require("./lib/utils/pulldata").fastGet,parse3SectionStyleHost=require("./lib/utils/pulldata").parse3SectionStyleHost,netconnectivity=require("./lib/utils/netconnectivity"),log=require("./lib/utils/log")("Endpoint"),foundViewModelFiles=function(){log.info("Starting scan view-model files...");var n=[],e=require("path"),t=require("fs"),i=e.resolve(__dirname,"lib/model"),o=t.readdirSync(i);return o.forEach(function(t){if(".js"===e.extname(t))n.push(e.resolve(i,t)),log.info("Found view-model file %s",t)}),n}();inherits(Endpoint,Emitter),Endpoint.prototype.init=function(n,e,t){var i=Q.defer();this.initTimeout=setTimeout(function(){i.reject(new Exception(consts.MSG.E1000.code,consts.MSG.E1000.message,{}))},12e3);var o=this,s=function(){clearTimeout(o.initTimeout),o.removeListener(consts.EVENT_USER_LOGIN_FAILED,s),o.removeListener(consts.EVENT_SYSTEM_INIT,s)};return this.once(consts.EVENT_USER_LOGIN_FAILED,s),this.once(consts.EVENT_SYSTEM_INIT,s),log.info("[Endpoint]Init method %s with options %s",n,JSON.stringify(t)),this.username=n,this.config=extend({},this.defaultConfig,t,t.config||{}),netconnectivity.init(this.config.netconnectivityPing,this.config.netconnectivityCheckInterval).then(function(){return o._prepare()}).then(function(n){return o.config=extend({},o.config,n),o.config},function(n){return o.config}).then(function(t){o._init(n,e,t,i)}),i.promise},Endpoint.prototype._init=function(n,e,t,i){var o=this;log.info("Attach blink channel with options %s",JSON.stringify(t)),o.blinkChannel=blinkFactory(n,e,t),o.blinkChannel.once(consts.EVENT_USER_LOGIN_FAILED,function(e){var s=parse3SectionStyleHost(t.webip[0]);e.addAttribute("captchaHost",s),o.emit(consts.EVENT_USER_LOGIN_FAILED,e),log.error("%s fail to login because %s",n,JSON.stringify(e)),i.reject(e)}),o.blinkChannel.once(consts.EVENT_USER_LOGIN,function(e){log.info("Success to attach blink and starting attach data channel with options %s",JSON.stringify(t)),o.dataChannel=dataFactory(e.id,e.token,t),o.dataChannel.init().then(function(){o.emit(consts.EVENT_DATACHANNEL_CONNECT),log.info("Starting init view model registed %s",foundViewModelFiles);var s=[];foundViewModelFiles.forEach(function(n){var e=modelInitializer(n,o,t);s.push(e)}),Q.all(s).spread(function(){o.blinkChannel.emit(consts.EVENT_SYSTEM_INIT,e),o.dataChannel.emit(consts.EVENT_SYSTEM_INIT,e),o.emit(consts.EVENT_SYSTEM_INIT,e),log.info("Init operation has successful for user %s",n),e.domain=parse3SectionStyleHost(t.webip[0]),i.resolve(e)})},function(n){o.emit(consts.EVENT_USER_LOGIN_FAILED,n),log.error("Fail to attach data channel %s because %s",JSON.stringify(e),JSON.stringify(n)),i.reject(n)})})};var modelInitializer=function(n,e,t){var i=Q.defer();if(n.indexOf("$.js")>=0)log.warn("Ignore in-dev model file %s",n);else{log.info("Start init view model from %s with %s.",n,JSON.stringify(t));var o=require(n)(t);if(o){if(!e.vms.has(o.name))e.vms.set(o.name,o),e._monitor(o);log.info("Success for init view model %s",o.name)}log.info("End init view model from %s with %s.",n,JSON.stringify(t))}return i.resolve({}),i.promise};Endpoint.prototype._prepare=function(){log.warn("TODO: Need implement for read from local file.");var n=this.config.portalip||{};log.info("Starting getConfig from web server %s",JSON.stringify(n));var e="http://%s/web/getConfig";return fastGet(e,n,{clientVersion:this.config.clientVersion,proxyType:this.config.proxyType,userName:this.username},this.config)},Endpoint.prototype.action=function(n,e,t,i,o,s){var r=Q.defer();log.info("[Endpoint]Response action method calling with %s %s %s %s %s",n,e,t,i,o);var a=this.vms.get(n);if(!a)log.error("[Endpoint]View model %s is not exists.",n),r.reject(new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"name",n));else{var c=consts.UTILS_URL_MAPPING.nameActionPair.get(t),l=c[i],f=null;if(!l)log.warn("[Endpoint]Do nothing because unknown action %s on %s",i,t);else log.info("[Endpoint]Call action handler %s with %s %s",l,o,JSON.stringify(s)),f=a[l](e,t,o,s);if(f)f.then(function(n){log.info("[Endpoint]Publish action event of %s after handler.",i),a.emit(consts.EVENT_ACTION_PREFIX+i,{subViewName:e,dynamicViewName:t,id:o,options:s}),r.resolve(n)},function(n){r.reject(n)});else log.info("[Endpoint]Publish action event of %s after handler.",i),a.emit(consts.EVENT_ACTION_PREFIX+i,{subViewName:e,dynamicViewName:t,id:o,options:s}),r.resolve({})}return r.promise},Endpoint.prototype.data=function(n,e,t,i){var o=Q.defer();log.info("[Endpoint]Response data method calling with %s %s %s %s",n,e,t,JSON.stringify(i));var s=this.vms.get(n);if(!s)log.error("[Endpoint]View model %s %s %s is not exists.",n,e,t),o.reject(new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"name",n));else s.getDynamicViewData(e,t,i).then(function(n){log.info("[Endpoint]Return data of dynamic view %s, %s %s",JSON.stringify(n),e,t),o.resolve(n)},function(i){log.error("[Endpoint]Fail to return data with %s %s %s %s.",n,e,t,JSON.stringify(i)),o.reject(new Exception(consts.STATUS_VIEWMODEL_DYNAMIC_FAILED,"data",i))});return o.promise},Endpoint.prototype._monitor=function(n){var e=this;n.on("data",function(n){if(!n.mode||"internal"!=n.mode)setTimeout(function(){log.info('[Endpoint]Fire "data" event %s',JSON.stringify(n)),e.emit("data",n)},0);else log.info('[Endpoint]Ignore internal "data" event %s',JSON.stringify(n))}),log.info("Listening %s data event...",n.name)};var singletonEndpoint;module.exports=function(){if(!singletonEndpoint)singletonEndpoint=new Endpoint,log.info("A new endpoint instance has been created, and we will keep it only one."),process.on("uncaughtException",function(n){log.error("[Endpoint]Catch a uncaughtException on process %s.",n.toString())});return singletonEndpoint};