/**
 * @file test
 * @author cxl(chenxinle@baidu.com)
 */

var Core = require('../index');
var Long = require('long');

var now = Date.now();
console.log(now);
var a = Long.fromNumber(now);
console.log(a.toString());

var core = new Core({
    id: '7907842:251',
    eid: 7907842,
    debug: true
});
console.log('test');

function logout() {
    console.log('try to logout ...');
    core.logout().then(function () {
        console.log('logout success');
        process.exit(0);
    });
}

console.log('try to login ...');
core
    .login('zhanglizhi02:q', '123456')
    .then(
        function (userInfo) {
            console.log('login success');
            console.log(userInfo);
            //console.log(userInfo.nickname.toString('utf8'));
            //setTimeout(logout, 1000);
        },
        function (e) {
            console.log('login error:', e);
        }
    )
    .then(function () {
        console.log('bind events');
        core.on('enter', function (visitor) {
            console.log('visitor enter ' + JSON.stringify(visitor));
            
            // setTimeout(function() {
            //     core.invite(visitor.id);
            // }, 1000);
        });
        core.on('chat', function (visitor) {
            console.log('chat start ' + JSON.stringify(visitor));
            
            // setTimeout(function() {
            //     core.bye(visitor.id);
            // }, 2000);
        });
        core.on('chatover', function (id) {
            console.log('bye ~ ' + id);
        });
        core.on('message', function (id, msg) {
            console.log('receive message from ' + id);
            console.log(msg);

            console.log('try to send message to ' + id);
            core
                .send(id, 0, 'Hello World')
                .catch(function () {
                    console.log('send message fail');
                });
        });
        // Add by mengran at 2015-07-09
        core.on('update', function (visitor) {
            console.log('visitor update ' + JSON.stringify(visitor));
        });
        core.on('pageenter', function(visitor) {
            console.log('visitor pageenter ' + JSON.stringify(visitor));
        });
        core.on('leave', function (visitor) {
            console.log('leave ~ ' + JSON.stringify(visitor));
        });
        core.on('pageleave', function(visitor) {
            console.log('visitor pageleave ' + JSON.stringify(visitor));
        });
        core.on('reconnect', function(visitors) {
            console.log('visitors after reconnect ' + JSON.stringify(visitors));
        });
    })
    .then(function () {
        console.log('try to get user list');
        return core.getContactsList();
    })
    .then(
        function (data) {
            console.log('get user list success');
            console.log(data);
        },
        function (e) {
            console.log('get user list fail: %s', e);
        }
    )
    .then(function() {
        process.stdin.resume();
        process.stdin.on('data', function(d) {
            console.log('OK exit.');
            process.exit(100);
        })
    });
