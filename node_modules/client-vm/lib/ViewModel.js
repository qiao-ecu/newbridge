function ViewModel(e){var n=e[0],t=e[1];if(!n)throw new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"Argument is required.",n);Emitter.call(this),this.config=t,this.name=n,this.db={},this._init()}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,http=require("http"),Q=require("q"),deepExtend=require("deep-extend"),SortedMap=require("collections/sorted-map"),FastMap=require("collections/fast-map"),Sequelize=require("sequelize"),path=require("path"),dataChannelFactory=require("./DataChannel"),Exception=require("./Exception"),extend=require("./utils/extend"),curry=require("./utils/curry"),consts=require("./utils/const"),log=require("./utils/log")("ViewModel");inherits(ViewModel,Emitter),ViewModel.silenceSave=function(e,n,t){var i=e.db[n].table;ViewModel.save(e,i,t,!1,!0)},ViewModel.createOrUpdate=function(e,n,t){var i=e.db[n].table;ViewModel.save(e,i,t,!1,!1)},ViewModel["delete"]=function(e,n,t){var i=e.db[n].table;ViewModel.save(e,i,t,!0)},ViewModel.save=function(e,n,t,i,o){var s=n.get(t.id),r=e.db[n.name].indexMap;if(i&&s){if(n["delete"](t.id),log.info("Delete data %s fromo table %s",JSON.stringify(s),n.name),!o)e.emit(consts.EVENT_VIEWMODEL_SYNC_DELETE,n.name,s);return log.warn("TODO: Need update index when delete..."),null}if(s){var a=deepExtend({},s);if(a=deepExtend(a,t),n.set(t.id,a),log.info("Update data %s into table %s, original %s",JSON.stringify(a),n.name,JSON.stringify(s)),!o)e.emit(consts.EVENT_VIEWMODEL_SYNC_UPDATE,n.name,a,s);return r.forEach(function(e,n){if(t[n])e.set(t[n],t.id)}),a}else{if(n.set(t.id,t),log.info("Insert data %s into table %s",JSON.stringify(t),n.name),!o)e.emit(consts.EVENT_VIEWMODEL_SYNC_INSERT,n.name,t);return r.forEach(function(e,n){if("undefined"!=typeof t[n])e.set(t[n],t.id)}),t}},ViewModel.prototype._init=function(){if(this.config.ViewModel_persistent){var e=path.join(consts.UTILS_DATA_DIR(),this.name.replace(/:/,"_")+".db");this.persistent=new Sequelize(this.name,null,null,{dialect:"sqlite",storage:e})}if(!this.config.ViewModel_supportServerPush)if(!this.config.ViewModel_httpEndpoint)throw new Error("Disable server push mode must given a http endpoint",name);this.dataChannel=dataChannelFactory(),log.info("Data holder have initialized for %s",this.name)},ViewModel.prototype.createSubView=function(e,n){if(!e)throw log.error("Sub-view name is required."),new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"subViewName.",{});if(this.db[e])return void log.warn("SubView %s is exists, return the exist one directly.",e);var t=new FastMap;t.name=e,this.db[e]={table:t,viewMap:new FastMap,indexMap:new FastMap},log.info("Created a collection %s for store data with unique index[id]",e);var i=this,o=this.name+":"+e;if(this.dataChannel.on(o,curry(function(e,n,t){var s=[];t.forEach(function(e){var t=ViewModel.save(i,n,e);s.push(t)}),setTimeout(function(){e.emit(consts.EVENT_VIEWMODEL_SYNC_BATCH+":"+o,s)},0)},this.dataChannel,t)),log.info("Listening %s event...",o),n)log.info("Start load sub-view %s of %s into table with %s",this.name,e,JSON.stringify(this.config)),n(this.name,e,t,this.config);log.info("Sucess to create a sub-view %s",e)},ViewModel.prototype._generateDynamicViewName=function(e,n,t){t=t||{};var i=n;if(t.bid)i=t.bid;return i},ViewModel.prototype.createDynamicView=function(e,n,t){t=t||{};var i=this.db[e].table;if(!i)throw log.error("Sub-view %s is not exits.",e),new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"subViewName",e);var o=this._generateDynamicViewName(e,n,t),s=this.db[e].viewMap.get(o);if(s)return s;s={name:o,uiName:n,subViewName:e},this.db[e].viewMap.set(o,s);var r=t.filter,a=t.orderby;if(r&&a)s.data=new SortedMap,i.addMapChangeListener(function(e,n,t){Object.keys(r).forEach(function(t){if("undefined"==typeof e);else if(e[t]==r[t]&&e.hasOwnProperty(a))s.data.set(e[a],n)})}),log.info("We create a very fast dynamic view data  for %s",JSON.stringify(s));if(!r&&a){s.orderby=a;var c=this.db[e].indexMap;if(!c.has(a))c.set(a,new SortedMap);s.data=c.get(a),log.info("Apply sort %s.",JSON.stringify(a))}return s.dynamicViewNameMapFunc=t.map||function(e){return e},log.info("Success to create a new dynamic view %s with options %s",n,JSON.stringify(t)),s},ViewModel.prototype.getDynamicViewData=function(e,n,t){var i=Q.defer();t=t||{};var o=this.db[e].table;if(!o)return log.error("Sub-view %s is not exits.",e),i.reject(new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"subViewName",e)),i.promise;var s=this._generateDynamicViewName(e,n,t),r=this.db[e].viewMap.get(s);if(!r)return log.error("Dynamic view %s is not exists.",s),i.reject(new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"dynamicSubViewName",s)),i.promise;var a=deepExtend({},r.filter);a=deepExtend(a,t.filter);var c=deepExtend({},r.orderby);return c=deepExtend(c,t.orderby),this._filterSubViewData(o,r,a,c,t).then(function(e){var n=e.map(r.dynamicViewNameMapFunc);log.info("Retrieve dynamic view data %s of %s, before map %d",n.length>10?n.length+" count":JSON.stringify(e),s,e.length),i.resolve(n)},function(e){log.error("Error occurred when try to filter data %s %s %s.",o.name,r.name,JSON.stringify(t)),i.reject(new Exception(consts.STATUS_VIEWMODEL_DYNAMIC_FAILED,"dynamicSubViewName",r.name))}),i.promise},ViewModel.prototype.all=function(e){var n=this,t=null;return Object.getOwnPropertyNames(this.db).forEach(function(i){if(!t)if(!e||e==i)t=n.db[i].table}),t?t.entries():[]},ViewModel.prototype.get=function(e,n){var t=this,i=null;return Object.getOwnPropertyNames(this.db).forEach(function(o){if(!i)if(!n||n==o){var s=t.db[o].table,r=s.get(e);if(r)i=r}}),i},ViewModel.prototype.getDynamicView=function(e,n){var t=this.db[n].viewMap.get(e);return t},ViewModel.prototype.getByIndex=function(e,n,t){var i=this,o=null;if(t){var s=this.db[t].viewMap;s.forEach(function(e,s){if(!o)if(e.data){var r=e.data.get(n);o=i.get(r,t)}})}return Object.getOwnPropertyNames(this.db).forEach(function(s){if(!o)if(!t||t==s){var r=i.db[s].indexMap,a=r.get(e);if(a)o=i.get(a.get(n),t)}}),o},ViewModel.prototype.update=function(e){var n=this,t=null,i=null;if(Object.getOwnPropertyNames(this.db).forEach(function(o){if(!t){var s=n.db[o].table,r=s.get(e.id);if(r)t=r,i=s}}),t)return ViewModel.save(this,i,e),!0;else return!1},ViewModel.prototype._filterSubViewData=function(e,n,t,i){var o=Q.defer();return o.resolve([]),o.promise},module.exports=ViewModel;