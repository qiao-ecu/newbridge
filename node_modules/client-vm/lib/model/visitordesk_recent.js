var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),consts=require("../utils/const"),log=require("../utils/log")("visitrecent"),visitorDesk=require("./visitordesk")();module.exports=function(e){var t=consts.UTILS_DATA_DIR();return visitorDesk.recentDb=new DB({filename:path.join(t,"/visitordesk-recent.db"),autoload:!0}),blinkFactory().on(consts.EVENT_BLINKCHANNEL_VISITOR_CHAT,function(e){visitorDesk.recentDb.update({id:e.id},e,{upsert:!0})}),log.info("Start to listening chat event for recent."),visitorDesk.on("data",function(e){if(e.name==visitorDesk.name&&"insert"==e.type)e.value.forEach(function(e){visitorDesk.recentDb.find({id:e.id},function(t,n){if(!t&&n.length>0){var i={id:e.id,recent:!0};visitorDesk.update(i)}})})}),null};