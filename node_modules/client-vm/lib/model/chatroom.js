function Chatroom(e,t){var n=Array.prototype.slice.call(arguments,0);ViewModelClass.call(this,n),this.config=t}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),cheerio=require("cheerio"),Exception=require("../Exception"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),curry=require("../utils/curry"),netconnectivity=require("../utils/netconnectivity"),log=require("../utils/log")("chatroom");inherits(Chatroom,ViewModelClass),Chatroom.prototype._handleSendMsg=function(e,t,n,i){var o=Q.defer(),s=this._generateDynamicViewName(e,t,i),r=this.db[e].viewMap.get(s),a=i.content,c=this;if(!a)return o.reject(new Exception(consts.STATUS_ILLEGAL_ARGUMENT,"options.content",{})),o.promise;var l=blinkFactory();if(!netconnectivity.online)return o.reject(new Exception(consts.STATUS_ILLEGAL_NETWORK,"options.content",{})),o.promise;else return l.sendMessage(r.name,a).then(function(e){c.emit(consts.EVENT_BLINKCHANNEL_MESSAGE_SEND,{id:e.id,status:0})},function(e){log.info("Fail to send message %s",JSON.stringify(e)),c.emit(consts.EVENT_BLINKCHANNEL_MESSAGE_SEND_FAILED,e)}),o.resolve({}),o.promise},Chatroom.prototype._handleTemporarySave=function(e,t,n,i){var o={id:i.bid,content:i.content,bid:i.bid,timestamp:i.bid};log.info("Cache %s into %s",JSON.stringify(o),e),ViewModelClass.createOrUpdate(this,e,o)},Chatroom.prototype._handleImageNotify=function(e,t,n,i){var o=this;this.emit(consts.EVENT_BLINKCHANNEL_MESSAGE_IMAGE,i,function(e,t){var n=t.bcsName,i=t.status,s=!1;o.all(e.name).forEach(function(t){if(!s){var r=t[0],a=t[1],c=cheerio.load(a.content);c("img[data-bcsname="+n+"]").is(function(t){s=!0;var n=cheerio(this);if(0===i)n.attr("data-uploaded","1");else if(1==i)n.attr("data-uploaded","2");var a=c.html();ViewModelClass.createOrUpdate(o,e.name,{id:r,content:a})})}})})},Chatroom.prototype._filterSubViewData=function(e,t,n,i,o){var s=Q.defer(),r=[],a=consts.ACTION_INTERNAL_LOADER,c=consts.UTILS_URL_MAPPING.nameActionPair.get(t.uiName);if(c&&c[a]){var l=c[a];this[l](e,t,n,i,s)}else t.data.forEach(function(t,n){r.push(e.get(t))}),s.resolve(r);return s.promise};var fireEvent=function(e,t,n,i,o,s){var r={name:e.name,subViewName:t,dynamicViewName:n,type:o,mode:s};r.value=[i],e.emit("data",r)},takingLoader=function(e,t,n,i){blinkFactory().on(consts.EVENT_BLINKCHANNEL_MESSAGE_RECV,function(e){ViewModelClass.save(singletonChatroom,n,e)}),blinkFactory().on(consts.EVENT_BLINKCHANNEL_MESSAGE_PARSETHROUGH,function(e){fireEvent(singletonChatroom,t,e.bid,e,"insert","external")}),blinkFactory().on(consts.EVENT_BLINKCHANNEL_MESSAGE_SEND_DRAFT,function(e){ViewModelClass.save(singletonChatroom,n,e)}),singletonChatroom.on(consts.EVENT_BLINKCHANNEL_MESSAGE_IMAGE,function(e,t){if(t(n,e),e.bid)blinkFactory().sendImageNotify(e.bid,JSON.stringify(e)).then(function(t){log.info("Success to send image notify message %s",JSON.stringify(e))},function(t){log.error("Fail to send image notify message %s %s",JSON.stringify(e),JSON.stringify(t))})}),singletonChatroom.on(consts.EVENT_BLINKCHANNEL_MESSAGE_SEND,function(e){ViewModelClass.save(singletonChatroom,n,e)}),singletonChatroom.on(consts.EVENT_BLINKCHANNEL_MESSAGE_SEND_FAILED,function(e){var t=e.source,i=n.get(t.type);if(i)i.status=1,ViewModelClass.save(singletonChatroom,n,i);else log.error("Can not found failed message %s",JSON.stringify(e))}),log.info("Start listening message from blink for %s",t);var o=t,s=function(e,t,n){if(o==t){var i=n.bid;if(i){var s=singletonChatroom.db[t].viewMap.get(i);if(s)fireEvent(singletonChatroom,t,s.uiName,n,e);else log.error("Unknown message %s for %s, because dynamic view is not found",JSON.stringify(n),i)}else log.error('Uncomplete structure of %s, because not contains "bid" field.',JSON.stringify(n))}};singletonChatroom.on(consts.EVENT_VIEWMODEL_SYNC_INSERT,curry(s,"insert")),log.info("Start to listen %s on %s.",consts.EVENT_VIEWMODEL_SYNC_INSERT,t),singletonChatroom.on(consts.EVENT_VIEWMODEL_SYNC_UPDATE,curry(s,"update")),log.info("Start to listen %s on %s.",consts.EVENT_VIEWMODEL_SYNC_UPDATE,t)},typingLoader=function(e,t,n,i){singletonChatroom.on(consts.EVENT_BLINKCHANNEL_MESSAGE_IMAGE,function(e,t){t(n,e)})};Chatroom.prototype.dynamicViewCreator=function(e,t,n){var i={bid:n.id,filter:{bid:n.id},orderby:"timestamp"},o=singletonChatroom.createDynamicView(e,t,i);return o};var singletonChatroom,singletonVisitorDesk;module.exports=function(e){if(singletonChatroom)return singletonChatroom;else return singletonChatroom=new Chatroom("vm:chatroom",e||{}),log.info("Created a chatroom view model instance with %s, and keep it only one.",JSON.stringify(e)),log.info("Starting to create sub-view and dynamic-view on %s.",singletonChatroom.name),singletonChatroom.createSubView("talking",takingLoader),singletonChatroom.createSubView("typing",typingLoader),blinkFactory().on(consts.EVENT_BLINKCHANNEL_MESSAGE_IMAGE,function(e){singletonChatroom._handleImageNotify(null,null,null,e)}),singletonVisitorDesk=require("./visitordesk")(e),singletonVisitorDesk.on("data",function(e){if(e.name==singletonVisitorDesk.name&&(!e.mode||"external"!=e.mode))e.value.forEach(function(t){var n=singletonChatroom.dynamicViewCreator("talking","talking",t),i=singletonChatroom.dynamicViewCreator("typing","typing",t);if("insert"==e.type&&e.dynamicViewName==consts.MAPPING.CHATTING.name)setTimeout(function(){singletonChatroom.emit(consts.EVENT_CHATROOM_ANEW_CHAT,n,i)},0)})}),singletonChatroom};