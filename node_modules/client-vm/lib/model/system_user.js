function SystemUser(e,t){var n=Array.prototype.slice.call(arguments,0);ViewModelClass.call(this,n),this.config=t,this.currentLoginUserId=null}function systemUserLoader(e,t,n,i){var o=t;singtonSystemUser.on(consts.EVENT_VIEWMODEL_SYNC_UPDATE,function(e,t,n){if(o==e){var i={name:singtonSystemUser.name,type:"update"};i.subViewName=o,i.dynamicViewName=o,i.value=[{status:t.status}],singtonSystemUser.emit("data",i)}}),log.info("Start listening system user update event."),blinkFactory().on(consts.EVENT_SYSTEM_INIT,function(e){var t=deepExtend({},e);ViewModelClass.save(singtonSystemUser,n,e),log.info("Record login user into system user %s.",JSON.stringify(t)),singtonSystemUser.currentLoginUserId=e.id}),log.info("Start listening system init event."),blinkFactory().on(consts.EVENT_USER_LOGIN_KICKOUT,function(e){ViewModelClass.save(singtonSystemUser,n,e),log.info("Change system user status when connection losed %s.",JSON.stringify(e))}),log.info("Start listening blink kickout event."),blinkFactory().on(consts.EVENT_BLINKCHANNEL_CONNECT_RESUME,function(e){var t=blinkFactory().getCurrentLoginUser();ViewModelClass.save(singtonSystemUser,n,t),log.info("Change system user status when blink resumed %s.",JSON.stringify(t))}),log.info("Start listening blink kickout event."),netconnectivity.on("online",function(){var e=n.get(singtonSystemUser.currentLoginUserId);e.status=singtonSystemUser.config.status,ViewModelClass.save(singtonSystemUser,n,e)}),netconnectivity.on("losed",function(){var e=n.get(singtonSystemUser.currentLoginUserId);e.status=consts.STATUS_SYSTEM_USER.BLK_CSTAT_UNLOGIN,ViewModelClass.save(singtonSystemUser,n,e)}),log.info("Start listening netconnectivity event.")}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),path=require("path"),deepExtend=require("deep-extend"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),log=require("../utils/log")("systemuser"),netconnectivity=require("../utils/netconnectivity");inherits(SystemUser,ViewModelClass),SystemUser.prototype._filterSubViewData=function(e,t,n,i,o){var s=Q.defer(),r=singtonSystemUser.get(this.currentLoginUserId);return s.resolve([{status:r.status}]),s.promise},SystemUser.prototype._handleChangeStatus=function(e,t,n,i){blinkFactory().changeStatus(i.status).then(function(t){var n=blinkFactory().getCurrentLoginUser();ViewModelClass.silenceSave(singtonSystemUser,e,n)},function(t){var n=blinkFactory().getCurrentLoginUser();log.error("Error occurred when try to change status of blink to %d",i.status),ViewModelClass.createOrUpdate(singtonSystemUser,e,n)})};var singtonSystemUser;module.exports=function(e){if(singtonSystemUser)return singtonSystemUser;singtonSystemUser=new SystemUser("vm:user",e||{}),log.info("Created a visitor view model instance with %s, and keep it only one.",JSON.stringify(e)),log.info("Starting to create sub-view and dynamic-view on %s.",singtonSystemUser.name),singtonSystemUser.createSubView("info",systemUserLoader),singtonSystemUser.createDynamicView("info","info",{});var t=dataFactory();return log.on(consts.EVENT_SYSTEM_ATTENTION,function(e,n){var i={msg:e,meta:n};t.send(consts.COMMAND_DATACHANNEL_UP_ATTENTION,i)}),singtonSystemUser};