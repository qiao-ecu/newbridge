function leftLoader(e,t,n,i){var o=t;visitorDesk.on(consts.EVENT_VIEWMODEL_SYNC_INSERT,function(e,t){if(o==e)log.info("insert a element into db %s with %s",e,JSON.stringify(t)),visitorDesk.leftDb.update({id:t.id},t,{upsert:!0})}),visitorDesk.on(consts.EVENT_VIEWMODEL_SYNC_UPDATE,function(e,t,n){if(o==e){log.info("update a element into db %s with %s",e,JSON.stringify(t)),visitorDesk.leftDb.update({id:t.id},t,{upsert:!0});var i={name:visitorDesk.name,subViewName:e,dynamicViewName:e,mode:"external",type:"update",value:[visitorDesk.getVisitor(t.id)]};visitorDesk.emit("data",i)}}),visitorDesk.on("data-pre",function(e){if(e.name==visitorDesk.name&&e.subViewName==consts.MAPPING.CHATTING.type&&("update"==e.type||"insert"==e.type))e.value.forEach(function(e){if(visitorDesk.get(e.id,t))ViewModelClass.save(visitorDesk,n,e,!0)})}),visitorDesk.on(consts.EVENT_VIEWMODEL_SYNC_DELETE,function(e,t){if(o==e){log.info("Remove a element from db %s with %s",e,JSON.stringify(t)),visitorDesk.leftDb.remove({id:t.id});var n={name:visitorDesk.name,subViewName:e,dynamicViewName:e,mode:"external",type:"delete",value:[visitorDesk.getVisitor(t.id)]};visitorDesk.emit("data",n)}}),log.info("Start listening on insert/delete event on left")}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),FastMap=require("collections/fast-map"),ViewModelClass=require("../ViewModel"),dataFactory=require("../DataChannel"),blinkFactory=require("../BlinkChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),log=require("../utils/log")("visitinfo"),visitorDesk=require("./visitordesk")();visitorDesk.left_loader=function(e,t,n,i,o){log.info("Start loading left data from db.");var s=this;this.leftDb.find({},function(n,i){var r=s.config.leftUpLimit||200,a=i.length-r,c=i.slice(0-r);if(a>0){var l=i.slice(1,a);l.forEach(function(e){visitorDesk.leftDb.remove({id:e.id})}),log.info("Delete over-loaded left visitor %s",a)}if(n)log.error("Error occurred when try to load leftDb",n);else c.forEach(function(t){ViewModelClass.save(visitorDesk,e,t,!1,!0)}),visitorDesk.emit("data",{name:visitorDesk.name,subViewName:t.subViewName,dynamicViewName:t.name,type:"insert",mode:"internal",value:c});o.resolve(c||[])})},module.exports=function(e){log.info("Starting to create sub-view and dynamic-view on %s.",visitorDesk.name);var t=consts.UTILS_DATA_DIR();visitorDesk.leftDb=new DB({filename:path.join(t,"/visitordesk-left.db"),autoload:!0}),visitorDesk._subViewCreator(visitorDesk,"left",leftLoader);var n=function(e){log.info("check should be when connect resume and retrun visitors "+JSON.stringify(e));var t=new FastMap;e.forEach(function(e){t.set(e.id,e)}),visitorDesk.all(consts.MAPPING.VISITING.type).forEach(function(e){if(!t.has(e[0]))log.info("Emit a event for left. %s",JSON.stringify(e[1])),blinkFactory().emit(consts.EVENT_BLINKCHANNEL_VISITOR_LEAVE,{id:e[0],status:consts.MAPPING.LEFT.value})})};blinkFactory().on(consts.EVENT_BLINKCHANNEL_CONNECT_RESUME,n),log.info("Start to listening resume event for left.");var i=function(){blinkFactory().getOnsiteVisitors().then(function(e){n(e),setTimeout(i,6e4)},function(e){log.error("Error occurred when try to do left-visitor checker %s.",JSON.stringify(e))})};return setTimeout(i,6e4),visitorDesk.on(consts.EVENT_ACTION_PREFIX+"block",function(e){setTimeout(function(){blinkFactory().emit(consts.EVENT_BLINKCHANNEL_VISITOR_LEAVE,{id:e.id||e.options.bid,status:consts.MAPPING.LEFT.value})},0)}),null};