var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),path=require("path"),FastMap=require("collections/fast-map"),Sequelize=require("sequelize"),moment=require("moment"),blinkFactory=require("../BlinkChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),curry=require("../utils/curry"),log=require("../utils/log")("chatroomhistory"),chatroom=require("./chatroom")(),historyLoader=function(e,t,n,i){chatroom.on("data",function(e){if(e.name==chatroom.name&&(!e.mode||"external"!=e.mode)||e.subViewName==consts.MAPPING.TALKING.type)e.value.forEach(function(t){var n=chatroom.historyDb.models[t.bid];if(t.type!==consts.MESSAGE_TYPE.sysMessage)if("insert"==e.type)n.create(t);else if("update"==e.type)n.findAll({where:{id:t.id},limit:countPerPage}).then(function(e){e[0].update(t)})})}),log.info("Start to talking view data emit for %s .",t)},countPerPage=10;chatroom.history_loader=function(e,t,n,i,o){var s=chatroom.historyDb.models[t.name];s.count().then(function(e){var t=e,n=lastPage(t),i=Q.defer();doFetch4Pagination(s,i,t,n),i.promise.then(function(e){o.resolve([e])})})};var lastPage=function(e){var t=e>0?e%countPerPage===0?e/countPerPage:e/countPerPage+1:1;return t=parseInt(t.toString())};chatroom._handleHistoryFetch=function(e,t,n,i){var o=Q.defer(),s=chatroom.historyDb.models[n||i.bid];if(i.page)doFetch4Pagination(s,o,i.count,i.page);else if(i.date)doFetch4DateSelect(s,o,i.count,i.date);else if(i.id)doFetch4IdSelect(s,o,i.count,i.id);return o.promise};var doFetch4Pagination=function(e,t,n,i,o){var s={pager:{count:n,page:i},message:[],date:null},r=countPerPage*(i-1);e.findAll({offset:r,limit:countPerPage}).then(function(e){s.message=e,s.date=o?o:e.length?e[0].timestamp:Date.now(),t.resolve(s)})},doFetch4DateSelect=function(e,t,n,i){var o=moment(i).startOf("hour").valueOf();e.findOne({where:{timestamp:{gte:o}},order:"_id ASC"}).then(function(i){var o=null;if(i){var s=i._id;o=s/countPerPage+1,o=parseInt(o.toString())}else o=lastPage(n);doFetch4Pagination(e,t,n,o)})},doFetch4IdSelect=function(e,t,n,i){e.findAll({where:{id:i},limit:countPerPage}).then(function(i){var o=i[0]._id/countPerPage+1;o=parseInt(o.toString()),doFetch4Pagination(e,t,n,o)})};chatroom._handleHistorySearch=function(e,t,n,i){var o=Q.defer(),s=chatroom.historyDb.models[n||i.bid];return doFetch4SearchText(s,o,i.count,i.text),o.promise};var doFetch4SearchText=function(e,t,n,i){e.findAll({where:{content:{$like:"%"+i+"%"},_id:{$lte:n}},limit:countPerPage}).then(function(e){t.resolve(e)})};module.exports=function(e){chatroom.createSubView("history",historyLoader);var t=require("./visitordesk")(e);t.on("data",function(e){if(e.name==t.name&&(!e.mode||"external"!=e.mode))e.value.forEach(function(e){chatroom.dynamicViewCreator("history","all",e);var t=chatroom.historyDb.define(e.id,{_id:{type:Sequelize.INTEGER,autoIncrement:!0,primaryKey:!0},id:{type:Sequelize.STRING,allowNull:!1},from:{type:Sequelize.INTEGER,allowNull:!1},bid:{type:Sequelize.STRING,allowNull:!1},name:{type:Sequelize.STRING,allowNull:!1},type:{type:Sequelize.INTEGER,allowNull:!1},timestamp:{type:Sequelize.STRING,allowNull:!1},content:{type:Sequelize.STRING,allowNull:!1},status:{type:Sequelize.INTEGER,allowNull:!1}},{indexes:[{unique:!0,fields:["id"]},{unique:!0,fields:["timestamp"]},{unique:!1,fields:["bid"]}]});t.sync()})}),log.info("Start to listen visitor-desk event for create history view");var n=path.join(consts.UTILS_DATA_DIR(),"/chatroom-history.db");return chatroom.historyDb=new Sequelize("chatroom-history",null,null,{dialect:"sqlite",storage:n,logging:e.debug?console.log:!1}),null};