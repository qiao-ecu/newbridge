function VisitorDesk(e,t){var n=Array.prototype.slice.call(arguments,0);ViewModelClass.call(this,n),this.config=t}function onsiteLoader(e,t,n,i){log.info("Loading data %s %s",e,t);var o=require("./visitordesk_onsite_event_utils$")(i);o.listenSystemInit(singtonVisitor);var s=t;singtonVisitor.on(consts.EVENT_VIEWMODEL_SYNC_UPDATE,function(e,t,n){if(s==e){var i=o.fireDeleteEventWhenUpdate(singtonVisitor,e,n,t),r=o.fireInsertEventWhenUpdate(singtonVisitor,e,n,t),a=o.fireUpdateEventWhenUpdate(singtonVisitor,e,n,t);if(!i&&!r&&!a)log.info("Do nothing on %s update",e)}}),log.info("Start to listen %s on %s.",consts.EVENT_VIEWMODEL_SYNC_UPDATE,s);var r=[consts.EVENT_BLINKCHANNEL_VISITOR_ENTER,consts.EVENT_BLINKCHANNEL_VISITOR_QUEUE,consts.EVENT_BLINKCHANNEL_VISITOR_LEAVE,consts.EVENT_BLINKCHANNEL_VISITOR_CHAT,consts.EVENT_BLINKCHANNEL_VISITOR_INVITE,consts.EVENT_BLINKCHANNEL_VISITOR_BACKTOENTER,consts.EVENT_BLINKCHANNEL_VISITOR_LOCK];blinkFactory().listening(r,function(e){ViewModelClass.save(singtonVisitor,n,e)}),log.info("Start to listen visitor events "+JSON.stringify(r));var a=function(i){var o=[];i.forEach(function(e){ViewModelClass.save(singtonVisitor,n,e),o.push(e.id)}),setTimeout(function(){dataFactory().send(consts.COMMAND_DATACHANNEL_SYNC_START,{viewName:e,subViewName:t,data:o})},500)};blinkFactory().on(consts.EVENT_BLINKCHANNEL_CONNECT_RESUME,function(e){log.info("connect resume and retrun visitors "+JSON.stringify(e)),a(e||[])}),blinkFactory().getOnsiteVisitors().then(function(e){log.info("Starting to handl onsite visitors %s.",JSON.stringify(e)),a(e)},function(e){log.error("Error occurred when try to load onsite visitors",e)})}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),log=require("../utils/log")("visitor");inherits(VisitorDesk,ViewModelClass),VisitorDesk.prototype._filterSubViewData=function(e,t,n,i,o){var s=Q.defer(),r=consts.ACTION_INTERNAL_LOADER,a=consts.UTILS_URL_MAPPING.nameActionPair.get(t.uiName);if(a&&a[r]){var c=a[r];singtonVisitor[c](e,t,n,i,s)}else s.resolve([]);return s.promise},VisitorDesk.prototype.onsite_loader=function(e,t,n,i,o){log.warn("TODO: Make sure order. Start loading onsite data from view model.");var s=[],r=this;e.forEach(function(e,n){var i=r.getVisitorInView(n);if(i&&i.name==t.name)s.push(e)}),o.resolve(s)};var dynamicViewMapFunction=function(e){if(e.__)return e;if(e.basicInfo&&e.basicInfo.hasOwnProperty("fstVisit")){var t={};t.__=!0,t.status=e.status,t.bid=e.basicInfo.bid,t.id=e.id,t.siteId=e.basicInfo.siteId,t.eid=e.basicInfo.eid,t.fstVisit=e.basicInfo.fstVisit,t.clientType=e.currentClientInfo.clientType,t.visitPages=e.currentVisitInfo.visitPages,t.ipArea=e.currentVisitInfo.ipArea,t.ip=e.currentVisitInfo.ip,t.unread=e.unread||0,t.block=e.block||!1,t.recent=e.recent||!1;var n=(e.currentVisitInfo.fromEngine||"").split(":");return t.fromEngine=n.length>1?n[0]:"",t.keyWord=e.currentVisitInfo.keyWord||"",t.queryWord=e.currentVisitInfo.queryWord||"",t.name=e.basicInfo.name||e.id.slice(-4)+t.ipArea+"шо┐хов",t.time=0,t}};VisitorDesk.prototype.getVisitor=function(e){var t=this,n=t.get(e,"onsite");if(!n)n=t.get(e,"left");if(!n)n=t.get(e,"recent");if(n)return dynamicViewMapFunction(n);else return log.info("Can not find visitor on %s %s",t.name,e),null},VisitorDesk.prototype.getVisitorInView=function(e){var t=this.getVisitor(e);if(!t)return null;var n=consts.UTILS_URL_MAPPING.statusTypePair.get(t.status),i=this.db[n].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(t.status));return i},VisitorDesk.prototype._subViewCreator=function(e,t,n){e.createSubView(t,n),consts.UTILS_URL_MAPPING.valueNamePair.forEach(function(n,i){if(consts.UTILS_URL_MAPPING.nameTypePair.get(n)==t)e.createDynamicView(t,n,{filter:{status:i},orderby:"sessionId",map:dynamicViewMapFunction}),log.info("Created a dynamic view %s on %s.",n,t)})};var singtonVisitor;module.exports=function(e){if(singtonVisitor)return singtonVisitor;else return singtonVisitor=new VisitorDesk("vm:visitor",e||{}),log.info("Created a visitor view model instance with %s, and keep it only one.",JSON.stringify(e)),log.info("Starting to create sub-view and dynamic-view on %s.",singtonVisitor.name),singtonVisitor._subViewCreator(singtonVisitor,"onsite",onsiteLoader),log.warn("TODO: recent"),singtonVisitor._subViewCreator(singtonVisitor,"recent"),singtonVisitor};