var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),curry=require("../utils/curry"),fastGet=require("../utils/pulldata").fastGet,log=require("../utils/log")("chatroomassistant"),chatroom=require("./chatroom")(),visitorDesk=require("./visitordesk")(),welcomeLoader=function(e,t,n,i){chatroom.on(consts.EVENT_CHATROOM_ANEW_CHAT,function(e,n){printHistorySplitMessage(e).then(function(){var e=blinkFactory().getCurrentLoginUser(),i=chatroom.get(e.id,t)||{dataList:[]};if(i.dataList.length<1)return void log.info("No found any persional auto reply settings for %s.",e.id);var o=require("./visitordesk")(),s=o.get(n.name),r=null;if(i.dataList.forEach(function(e){var t=JSON.parse(e.welcomeWords);if(e.siteId==s.siteId&&t.isActive)return void(r=t.content);else return void 0}),!r)return void log.info("No found welcome words in persional auto reply settings for %s %s %s.",e.id,s.siteId,s.id);var a={bid:s.id,content:r};log.info("Send welcome words for %s %s %s",e.id,s.siteId,JSON.stringify(a)),chatroom._handleSendMsg(n.subViewName,n.uiName,"",a)})}),log.info("Start listening chat room created event.");var o=chatroom.config.webip,s="http://%s/autoReply/personalAutoReplyInfoList.action",r=fastGet(s,o,{reqParam:{notneed:"notneed"}},chatroom.config);r.then(function(e){var t=blinkFactory().getCurrentLoginUser();e.id=t.id,ViewModelClass.save(chatroom,n,e)}),log.warn("Do not apply change on this version, maybe feature.")},printHistorySplitMessage=function(e){var t=Q.defer(),n={};n.id=Date.now(),n.from=0,n.bid=e.name,n.name="",n.type=consts.MESSAGE_TYPE.sysMessage;var i=Date.now();n.timestamp=i.toString();var o=require("./system_settings")(),s=o.getMessage(99,!0);if(s)n.content=s.message;else n.content=consts.MSG.E9001.message;return log.info("Push history message split message %s",JSON.stringify(n)),ViewModelClass.createOrUpdate(chatroom,e.subViewName,n),t.resolve(n),t.promise},chatOverHandler=function(){blinkFactory().on(consts.EVENT_BLINKCHANNEL_VISITOR_CHATOVER,function(e){log.info("Send visitor chatover message "+JSON.stringify(e));var t=e.id,n=visitorDesk.get(t);if(!n)n=visitorDesk.getByIndex("sessionId",e.sessionId,consts.MAPPING.CHATTING.type),t=n?n.id:"unkown bid",log.error("Can not send a chatover message for %s",JSON.stringify(e));else{var i=visitorDesk.getVisitorInView(t);if(i.name!==consts.MAPPING.CHATTING.name)return void log.info("Do not do chat-over logic on %s because support blink's bad design.",JSON.stringify(n))}var o=require("./system_settings")(),s=Date.now(),r={messageId:s,bid:t,userType:"service",userName:"",messageDetail:o.getMessage(142).message,occurTime:s,messageType:consts.MESSAGE_TYPE.sysMessage};log.warn("Send bye words %s for %s",JSON.stringify(r),n);var a=consts.UTILS_MESSAGESTYLE_WEB_TO_CLIENT(r);log.info("Record chat over message into talking table %s.",a),ViewModelClass.createOrUpdate(chatroom,consts.MAPPING.TALKING.type,a)}),visitorDesk.on(consts.EVENT_ACTION_PREFIX+"block",function(e){var t=e.id||e.options.bid,n=visitorDesk.getVisitorInView(t);if(n.name==consts.MAPPING.CHATTING.name)blinkFactory().closeChat(t)})};module.exports=function(e){return chatroom.createSubView("personalAutoReplyInfoList",welcomeLoader),chatOverHandler(),null};