function roomsLoader(e,t,i,n){log.info("Loading data %s %s",e,t),visitorDesk.createDynamicView(t,"front",{}),blinkFactory().on(consts.EVENT_BLINKCHANNEL_MESSAGE_RECV,function(e){var i=visitorDesk.get(e.bid,t);if(!i){var n=visitorDesk.getVisitor(e.bid);visitorDesk.unreadFieldProcessor(n,!0),log.info("Increase unread filed %s in %s",JSON.stringify(n),t)}}),visitorDesk.on(consts.EVENT_ACTION_PREFIX+"select",function(e){i.clear();var t=this.getVisitor(e.id);ViewModelClass.save(this,i,t),log.info("Record %s to rooms number",JSON.stringify(t))})}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),ViewModelClass=require("../ViewModel"),dataFactory=require("../DataChannel"),blinkFactory=require("../BlinkChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),fastGet=require("../utils/pulldata").fastGet,log=require("../utils/log")("visitroom"),visitorDesk=require("./visitordesk")();visitorDesk.unreadFieldProcessor=function(e,t){if(e){if(t){var i=e.unread||0;e.unread=i+1}else e.unread=0;setTimeout(function(){var t=visitorDesk.getVisitorInView(e.id);ViewModelClass.createOrUpdate(visitorDesk,t.subViewName||consts.MAPPING.VISITING.type,e),log.info("Save unread field change into table %s %s.",t.subViewName,JSON.stringify(e))},0)}},visitorDesk._handleVisitorSelect=function(e,t,i,n){var o=this.getVisitor(i);if(o)this.unreadFieldProcessor(o,!1),log.info("Clear unread field for %s on %s - %s when chat window actived.",i,e,t)},visitorDesk._handleVisitorInvite=function(e,t,i,n){var o=this.getVisitor(i);if(o)blinkFactory().sendInvite(i),log.info("Send a invite to %s on %s %s.",i,e,t)},visitorDesk._handleVisitorPickup=function(e,t,i,n){var o=this.getVisitor(i);if(o)blinkFactory().pickup(i),log.info("Pickup a visitor in %s %s.",i,t)},visitorDesk._handleVisitorForceChat=function(e,t,i,n){var o=this.getVisitor(i);if(o)blinkFactory().sendForceChat(i),log.info("Send a force chat to %s on %s %s.",i,e,t)},visitorDesk._handleActiveChatClose=function(e,t,i,n){var o=this.getVisitor(i);if(o)blinkFactory().closeChat(i),log.info("Send a chat close to %s on %s %s.",i,e,t)},visitorDesk._handleVisitorBlock=function(e,t,i,n){var o=Q.defer(),s=this.getVisitor(i);if(s){var r=this.config.webip,a="http://%s/visitorBlock/block.action",l=fastGet(a,r,{bid:s.id,siteId:s.siteId},this.config);l.then(function(e){var t=visitorDesk.getVisitorInView(s.id);s.block=!0,ViewModelClass.createOrUpdate(visitorDesk,t.subViewName,s),log.info("Success block request. %s %s",i,JSON.stringify(e)),o.resolve({})},function(e){log.error("Fail to block request, %s %s",i,JSON.stringify(e)),o.reject({})})}return o.promise},visitorDesk._handleActiveChatScene=function(e,t,i,n){this._handleVisitorSelect(e,t,i,n)},visitorDesk.frontrooms_loader=function(e,t,i,n,o){var s=e.keys();log.info("Start loading front rooms %s.",JSON.stringify(s)),o.resolve(s)},module.exports=function(e){return log.info("Starting to create sub-view and dynamic-view on %s.",visitorDesk.name),visitorDesk.createSubView("rooms",roomsLoader),null};