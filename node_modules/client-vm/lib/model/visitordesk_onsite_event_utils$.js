var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),path=require("path"),blinkFactory=require("../BlinkChannel"),ViewModelClass=require("../ViewModel"),consts=require("../utils/const"),extend=require("../utils/extend"),log=require("../utils/log")("visitordesk_onsite_event"),beforeSystemInitBuffer=[],beforeSystemInitFlag=!0,singleton={},emitData=function(e,t){if(beforeSystemInitFlag)beforeSystemInitBuffer.push(t);else e.emit("data-pre",t),setTimeout(function(){e.emit("data",t)},0),setTimeout(function(){e.emit("data-post",t)},0)};singleton.fireInsertEventWhenUpdate=function(e,t,n,i){var o={name:e.name,type:"insert"};if(n.hasOwnProperty("status")&&i.hasOwnProperty("status")&&n.status!=i.status){var s=consts.UTILS_URL_MAPPING.statusTypePair.get(n.status),r=e.db[s].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(n.status)),a=r.dynamicViewNameMapFunc(n),c=consts.UTILS_URL_MAPPING.statusTypePair.get(i.status),l=e.db[c].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(i.status)),u=l.dynamicViewNameMapFunc(i);if(a&&a.hasOwnProperty("fstVisit")&&u&&u.hasOwnProperty("fstVisit")){if(s!=c)ViewModelClass.createOrUpdate(e,c,i);return o.subViewName=c,o.dynamicViewName=l.name,o.value=[u],emitData(e,o),!0}}if(!n.hasOwnProperty("status")&&i.hasOwnProperty("status")){var d=consts.UTILS_URL_MAPPING.statusTypePair.get(i.status),f=e.db[d].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(i.status)),g=f.dynamicViewNameMapFunc(i);return o.subViewName=d,o.dynamicViewName=f.name,o.value=[g],emitData(e,o),!0}if(n.hasOwnProperty("status")&&i.hasOwnProperty("status")&&n.status==i.status){var m=consts.UTILS_URL_MAPPING.statusTypePair.get(n.status),h=e.db[m].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(n.status)),v=h.dynamicViewNameMapFunc(n),E=consts.UTILS_URL_MAPPING.statusTypePair.get(i.status),N=e.db[E].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(i.status)),p=N.dynamicViewNameMapFunc(i);if((!v||!v.hasOwnProperty("fstVisit"))&&p&&p.hasOwnProperty("fstVisit"))return o.subViewName=E,o.dynamicViewName=N.name,o.value=[p],emitData(e,o),!0}return!1},singleton.fireDeleteEventWhenUpdate=function(e,t,n,i){var o={name:e.name,type:"delete"};if(n.hasOwnProperty("status")&&i.hasOwnProperty("status")&&n.status!=i.status){var s=consts.UTILS_URL_MAPPING.statusTypePair.get(n.status),r=e.db[s].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(n.status)),a=r.dynamicViewNameMapFunc(n),c=consts.UTILS_URL_MAPPING.statusTypePair.get(i.status),l=e.db[c].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(i.status)),u=l.dynamicViewNameMapFunc(i);if(a&&a.hasOwnProperty("fstVisit")&&u.hasOwnProperty("fstVisit")){if(s!=c)ViewModelClass["delete"](e,s,n);return o.subViewName=s,o.dynamicViewName=r.name,o.value=[a],emitData(e,o),!0}}return!1},singleton.fireUpdateEventWhenUpdate=function(e,t,n,i){var o={name:e.name,type:"update"};if(n.hasOwnProperty("status")&&i.hasOwnProperty("status")&&n.status==i.status){var s=consts.UTILS_URL_MAPPING.statusTypePair.get(n.status),r=e.db[s].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(n.status)),a=r.dynamicViewNameMapFunc(n),c=consts.UTILS_URL_MAPPING.statusTypePair.get(i.status),l=e.db[c].viewMap.get(consts.UTILS_URL_MAPPING.valueNamePair.get(i.status)),u=l.dynamicViewNameMapFunc(i);if(a&&a.hasOwnProperty("fstVisit")&&u&&u.hasOwnProperty("fstVisit"))return o.subViewName=c,o.dynamicViewName=l.name,o.value=[u],emitData(e,o),!0}return!1},singleton.listenSystemInit=function(e){blinkFactory().once(consts.EVENT_SYSTEM_INIT,function(){beforeSystemInitFlag=!1,beforeSystemInitBuffer.forEach(function(t){emitData(e,t)})})},module.exports=function(e){return singleton};