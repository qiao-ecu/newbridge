var os=require("os"),path=require("path"),cp=require("child_process"),log=require("../utils/log")("agent"),consts=require("../utils/const"),dataFactory=require("../DataChannel"),commandExecutor=function(e,n,t){var i=os.platform();if("darwin"!==i){log.error("Can not execute command %s",e);var o=new Error("Can not execute command %s on %s",e,i);return void t(null,o)}var s=[];(n||[]).forEach(function(e){var n=consts.UTILS_DATA_DIR(),t=path.resolve(process.cwd(),"log"),i=e.replace("%datadir%",n).replace("%logdir%",t);s.push(i)});var r,a=cp.spawn(e,s);a.on("error",function(n){var i=new Error("commandExecutor: there was an error while executing the "+e+" program. check the path or permissions...");t(null,i)}),a.stdout.on("data",function(e){r+=String(e)}),a.stderr.on("data",function(e){}),a.on("exit",function(e){var n=0===e?!0:!1;if(t&&n)t(r,null)})};module.exports=function(e){return dataFactory().on(consts.EVENT_DATACHANNEL_AGENTTASK,function(e){var n=new Buffer(e,"base64").toString(),t=JSON.parse(n);log.info("Accept a task and try to run it %s.",t.id);var i=t.id;commandExecutor(t.command,t.args,function(e,n){log.error("Task %s have executed, result is %s, error is %s",i,e,n?"":JSON.stringify(n))})}),null};