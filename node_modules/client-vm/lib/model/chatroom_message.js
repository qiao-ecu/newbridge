var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),curry=require("../utils/curry"),log=require("../utils/log")("chatroommessage"),chatroom=require("./chatroom")(),messageLoader=function(e,t,n,i){var o=require("./visitordesk")(i);o.on("data",function(n){if(n.name==o.name&&(!n.mode||"external"!=n.mode)){var i=[];n.value.forEach(function(e){var t=chatroom.getDynamicView(e.bid,consts.MAPPING.TALKING.type);if(!t||!t.lastChat)i.push(e.bid)}),setTimeout(function(){dataFactory().send(consts.COMMAND_DATACHANNEL_SYNC_START,{viewName:e,subViewName:t,data:i})},100),log.info("Regist sync of %s %s",t,JSON.stringify(i))}});var s=t,r=chatroom.name+":"+t;dataFactory().on(consts.EVENT_VIEWMODEL_SYNC_BATCH+":"+r,function(e){e.forEach(function(e){var t=JSON.parse(e.lastChat),n=chatroom.getDynamicView(t.bid,consts.MAPPING.TALKING.type);if(!n||!n.lastChat){n.lastChat=!0;var i=0;t.data.forEach(function(e){i++,e.bid=t.bid;var n=consts.UTILS_MESSAGESTYLE_WEB_TO_CLIENT(e);ViewModelClass.silenceSave(chatroom,consts.MAPPING.TALKING.type,n)}),log.info("Load room history messages %d into talking table. %s",i,t.bid)}})}),log.info("Start to listen data channel.",s)};module.exports=function(e){return chatroom.createSubView("message",messageLoader),null};