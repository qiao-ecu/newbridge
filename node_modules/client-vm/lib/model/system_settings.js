function Settings(e,t){var n=Array.prototype.slice.call(arguments,0);ViewModelClass.call(this,n),this.config=t}function messageLoader(e,t,n,i){var o=consts.UTILS_DATA_DIR(),s=new DB({filename:path.join(o,"/settings-message.db"),autoload:!0});s.find({},function(e,t){if(e)log.error("Error occurred when try to load messageDb",e);else{var i=t||[];i.forEach(function(e){ViewModelClass.save(singtonSettings,n,e,!1,!0)})}Object.getOwnPropertyNames(consts.MSG).forEach(function(e){var t=consts.MSG[e];t.id=t.code,ViewModelClass.save(singtonSettings,n,t,!1,!0)}),log.info("Load hard-code message success.")});var r=i.webip,a="http://%s/message/template.action",c=fastGet(a,r,{reqParam:{notneed:"notneed"}},i);c.then(function(e){e.forEach(function(e){e.id=e.code,ViewModelClass.save(singtonSettings,n,e),s.update({code:e.code},e,{upsert:!0})}),log.info("Load mesage from web server success.")})}function commonwordLoader(e,t,n,i){var o=consts.UTILS_DATA_DIR(),s=new DB({filename:path.join(o,"/settings-commonword.db"),autoload:!0}),r=function(e){s.find({}).sort({_seq:1}).exec(function(n,i){if(n)log.error("Error occurred when try to load commonwordDb",n);else{var o=i||[];o.forEach(function(e){ViewModelClass.silenceSave(singtonSettings,t,e)})}e.resolve({})})},a=function(){var e=Q.defer(),n=i.webip,o="http://%s/commonWords/list.action",a=fastGet(o,n,{reqParam:{notneed:"notneed"}},i);return a.then(function(n){var i=n.dataList&&n.dataList.length>0;if(i)s.remove({},{multi:!0},function(i,o){if(i)r(e);else log.info("Remove local-cached common words %d",o),n.dataList.forEach(function(e,n){var i=extend(e,{_seq:n});ViewModelClass.createOrUpdate(singtonSettings,t,i),s.update({id:i.id},i,{upsert:!0})}),log.info("Load common-words from web server success %d.",n.dataList.length),e.resolve({})});else r(e)},function(t){r(e)}),e.promise};a();var c=singtonSettings.name+":"+t;dataFactory().on(consts.EVENT_VIEWMODEL_SYNC_BATCH+":"+c,function(e){a().then(function(){var e={name:singtonSettings.name,subViewName:t,dynamicViewName:t,type:"update",mode:"external"};e.value=[],singtonSettings.emit("data",e)})})}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),ViewModelClass=require("../ViewModel"),blinkFactory=require("../BlinkChannel"),dataFactory=require("../DataChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),fastGet=require("../utils/pulldata").fastGet,log=require("../utils/log")("settings");inherits(Settings,ViewModelClass),Settings.prototype.getMessage=function(e,t){var n=this.get(e,"message");if(!n&&!t){var i={};i.message="未知！（"+e+"）",i.code=e,i.id=i.code,n=i,log.error("Can not find message for %s",e)}return n},Settings.prototype._filterSubViewData=function(e,t,n,i,o){var s=Q.defer(),r=[];return t.data.forEach(function(t,n){r.push(e.get(t))}),s.resolve(r),s.promise};var singtonSettings;module.exports=function(e){if(singtonSettings)return singtonSettings;singtonSettings=new Settings("vm:settings",e||{}),log.info("Created a visitor view model instance with %s, and keep it only one.",JSON.stringify(e)),log.info("Starting to create sub-view and dynamic-view on %s.",singtonSettings.name),singtonSettings.createSubView("message",messageLoader),log.info("Starting to create sub-view and dynamic-view on %s.",singtonSettings.name),singtonSettings.createSubView("commonword",commonwordLoader);var t={orderby:"_seq"};return singtonSettings.createDynamicView("commonword","commonword",t),singtonSettings};