var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),DB=require("nedb"),path=require("path"),ViewModelClass=require("../ViewModel"),dataFactory=require("../DataChannel"),blinkFactory=require("../BlinkChannel"),consts=require("../utils/const"),extend=require("../utils/extend"),log=require("../utils/log")("visitinfo"),visitorDesk=require("./visitordesk")(),notifyCreator=function(e,t,n){e.createSubView(t,n);var i=e.createDynamicView(t,t,{});blinkFactory().on(consts.EVENT_BLINKCHANNEL_VISITOR_ENTER,function(n){log.info("visitor enter and need notify."+JSON.stringify(n)),log.warn("TODO: Need apply site auth filter"),ViewModelClass.createOrUpdate(e,t,n)}),e.on("data",function(n){if(!(n.mode&&"external"==n.mode||n.name!=e.name||"onsite"!=n.subViewName||"update"!=n.type&&"insert"!=n.type))n.value.forEach(function(n){var o=visitorDesk.get(n.id,t);if(o){var s={name:e.name,subViewName:i.subViewName,dynamicViewName:i.uiName,mode:"external",type:"insert",value:[n]};ViewModelClass["delete"](e,t,n),setTimeout(function(){e.emit("data",s)},0)}})})};module.exports=function(e){return log.info("Starting to create sub-view and dynamic-view on %s.",visitorDesk.name),notifyCreator(visitorDesk,"notify"),null};