var FastMap=require("collections/fast-map"),path=require("path"),fs=require("fs"),mkdirp=require("mkdirp");exports.EVENT_SYSTEM_INIT="systemInitEvent",exports.EVENT_SYSTEM_ATTENTION="systemAttentionEvent",exports.EVENT_USER_LOGIN="userLoginEvent",exports.EVENT_USER_LOGIN_FAILED="userLoginEvent:failed",exports.EVENT_USER_LOGIN_KICKOUT="userLoginEvent:kickout",exports.EVENT_DATACHANNEL_AGENTTASK="dataChannel4AgentTask",exports.EVENT_DATACHANNEL_CONNECT="dataChannelConnectEvent",exports.EVENT_DATACHANNEL_CONNECT_FAILED="dataChannelConnectEvent:failed",exports.EVENT_BLINKCHANNEL_CONNECT_RESUME="blinkChannelConnectEvent:resume",exports.EVENT_BLINKCHANNEL_GETONSITEVISITORS_FAILED="blinkChannelGetOnsiteVisitorsEvent:failed",exports.EVENT_BLINKCHANNEL_VISITOR_ENTER="blinkChannelVisitorEvent:enter",exports.EVENT_BLINKCHANNEL_VISITOR_LEAVE="blinkChannelVisitorEvent:leave",exports.EVENT_BLINKCHANNEL_VISITOR_QUEUE="blinkChannelVisitorEvent:queue",exports.EVENT_BLINKCHANNEL_VISITOR_CHAT="blinkChannelVisitorEvent:chat",exports.EVENT_BLINKCHANNEL_VISITOR_INVITE="blinkChannelVisitorEvent:invite",exports.EVENT_BLINKCHANNEL_VISITOR_INVITE_REJECT="blinkChannelVisitorEvent:invite:reject",exports.EVENT_BLINKCHANNEL_VISITOR_CHATOVER="blinkChannelVisitorEvent:chatover",exports.EVENT_BLINKCHANNEL_VISITOR_BACKTOENTER="blinkChannelVisitorEvent:backtoenter",exports.EVENT_BLINKCHANNEL_VISITOR_LOCK="blinkChannelVisitorEvent:lock",exports.EVENT_BLINKCHANNEL_MESSAGE_RECV="blinkChannelMessageEvent:recv",exports.EVENT_BLINKCHANNEL_MESSAGE_SEND_FAILED="blinkChannelMessageEvent:send:failed",exports.EVENT_BLINKCHANNEL_MESSAGE_SEND_DRAFT="blinkChannelMessageEvent:send:draft",exports.EVENT_BLINKCHANNEL_MESSAGE_SEND="blinkChannelMessageEvent:send",exports.EVENT_BLINKCHANNEL_MESSAGE_IMAGE="blinkChannelMessageEvent:image",exports.EVENT_BLINKCHANNEL_MESSAGE_PARSETHROUGH="blinkChannelMessageEvent:parseThrough",exports.EVENT_VIEWMODEL_SYNC="viewModelSyncEvent",exports.EVENT_VIEWMODEL_SYNC_BATCH="viewModelSyncEvent:batch",exports.EVENT_VIEWMODEL_SYNC_UPDATE="viewModelSyncEvent:update",exports.EVENT_VIEWMODEL_SYNC_INSERT="viewModelSyncEvent:insert",exports.EVENT_VIEWMODEL_SYNC_DELETE="viewModelSyncEvent:delete",exports.EVENT_CHATROOM_ANEW_CHAT="chatroomEvent:anew:chat",exports.EVENT_CHATROOM_ANEW_ROOM="chatroomEvent:anew:room",exports.EVENT_ACTION_PREFIX="action:",exports.STATUS_ILLEGAL_ARGUMENT=1,exports.STATUS_ILLEGAL_NETWORK=2,exports.STATUS_LOGIN_FAILED=1e3,exports.STATUS_DATACHANNEL_CONNECT_FAILED=2e3,exports.STATUS_VIEWMODEL_DYNAMIC_FAILED=3e3,exports.STATUS_SYSTEM_USER={BLK_STAT_INVALID:255,BLK_CSTAT_READY:0,BLK_CSTAT_BUSY:1,BLK_CSTAT_LEAVE:2,BLK_CSTAT_UNLOGIN:3,CLIENT_CSTAT_KICKOUT:99},exports.MSG={E1000:{code:1e3,message:"登录失败：超时！"},E1001:{code:1001,message:"失败：用户名密码错误！"},E1002:{code:1002,message:"失败：无法连接到沟通服务器！"},E1003:{code:1003,message:"失败：无法连接到数据服务器！"},E1004:{code:1004,message:"失败：被踢出！"},E1005:{code:1005,message:"失败：当前网络不可用！"},E2001:{code:2001,message:"发送失败！"},E9001:{code:9001,message:"以上为该访客的历史对话内容！"}},exports.MAPPING={LOCKING:{type:"onsite",name:"locking",value:-1},VISITING:{type:"onsite",name:"visiting",value:0,action:{_loader:"onsite_loader",select:"_handleVisitorSelect",dblclick:"_handleVisitorInvite",forcechat:"_handleVisitorForceChat",block:"_handleVisitorBlock"}},CHATTING:{type:"onsite",name:"chatting",value:4,action:{_loader:"onsite_loader",select:"_handleActiveChatScene",close:"_handleActiveChatClose",block:"_handleVisitorBlock"}},INVITING:{type:"onsite",name:"inviting",value:3,action:{_loader:"onsite_loader"}},QUEUEING:{type:"onsite",name:"queueing",value:2,action:{_loader:"onsite_loader",dblclick:"_handleVisitorPickup"}},ROBOTING:{type:"onsite",name:"roboting",value:97},RECENT:{type:"recent",name:"recent",value:1e5},LEFT:{type:"left",name:"left",value:5,action:{_loader:"left_loader",select:"_handleVisitorSelect"}},TYPING:{type:"typing",name:"typing",value:1e3,action:{send:"_handleSendMsg",cache:"_handleTemporarySave",imagenotify:"_handleImageNotify"}},TALKING:{type:"talking",name:"talking",value:5e3,action:{resend:"_handleResendMsg"}},HISTORY:{type:"history",name:"all",value:6e3,action:{_loader:"history_loader",fetch:"_handleHistoryFetch",search:"_handleHistorySearch"}},ACTIVEROOM:{type:"rooms",name:"front",value:2e3,action:{_loader:"frontrooms_loader"}},TIPS:{type:"visitinfo",name:"tips",value:3e3,action:{_loader:"tips_loader"}},USER_STATUS:{type:"info",name:"info",value:4e3,action:{change:"_handleChangeStatus","delete":"_handleDelete"}},LOCALCACHE:{type:"user",name:"localcache",value:7e3,action:{}},SETTINGS_COMMONWORD:{type:"commonword",name:"commonword",value:8e3,action:{}}},exports.ACTION_INTERNAL_LOADER="_loader",exports.UTILS_URL_MAPPING=function(){var e=new FastMap,t=new FastMap,n=new FastMap,i=new FastMap,o=new FastMap;return Object.getOwnPropertyNames(exports.MAPPING).forEach(function(s){if(e.set(exports.MAPPING[s].value,exports.MAPPING[s].name),t.set(exports.MAPPING[s].name,exports.MAPPING[s].value),exports.MAPPING[s].action)n.set(exports.MAPPING[s].name,exports.MAPPING[s].action);i.set(exports.MAPPING[s].name,exports.MAPPING[s].type),o.set(exports.MAPPING[s].value,exports.MAPPING[s].type)}),{valueNamePair:e,nameValuePair:t,nameActionPair:n,nameTypePair:i,statusTypePair:o}}(),exports.UTILS_DATA_DIR=function(e){var t=process.env.HOME||process.env.HOMEDRIVE+process.env.HOMEPATH||process.env.LOCALAPPDATA||__dirname,n=path.join(t,"nb-data",((e||exports.UTILS_LOGIN_USER.id)+"").replace(/:/,"_"));try{fs.statSync(n)}catch(i){mkdirp.sync(n)}return n},exports.UTILS_COOKIE_KEY="__cookies_token__",exports.UTILS_LOGIN_USER={},exports.UTILS_MESSAGESTYLE_BLINK_TO_CLIENT=function(e){var t={},n=e.body;t.id=e.id,t.from=n.fromtype,t.bid=e.bid?e.bid:0===t.from?n.to.id:n.from.id;var i=require("../model/visitordesk")(),o=i.getVisitor(t.bid);t.name=0===t.from?"我":o?o.name:"访客";var s=n.content[0];return t.type=s.type,t.timestamp=s.timestamp.toString(),t.content=s.content,t.status=0,t},exports.UTILS_MESSAGESTYLE_WEB_TO_CLIENT=function(e){if(e.__)return e;var t={id:e.messageId,bid:e.bid,body:{content:[{}]}};if("customer"==e.userType)t.body.fromtype=1;else if("service"==e.userType)t.body.fromtype=0;var n=t.body.content[0];n.content=e.messageDetail,n.timestamp=e.occurTime;var i=exports.MESSAGE_TYPE[e.messageType];n.type=("undefined"==typeof i?e.messageType:i)||0;var o=exports.UTILS_MESSAGESTYLE_BLINK_TO_CLIENT(t);return o},exports.MESSAGE_TYPE={chatMessage:0,voiceMessage:1,sysMessage:99},exports.COMMAND_DATACHANNEL_SYNC_START="dataChannelSyncStartCommand",exports.COMMAND_DATACHANNEL_SYNC_PING="dataChannelSyncPingCommand",exports.COMMAND_DATACHANNEL_UP_ATTENTION="dataChannelUpAttentionCommand";