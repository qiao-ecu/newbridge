var request=require("request"),Q=require("q"),FastMap=require("collections/fast-map"),format=require("util").format,consts=require("./const"),netconnectivity=require("./netconnectivity"),log=require("./log")("Utils.PullData");exports.parse3SectionStyleHost=function(e){var t=e.split(",");if(3==t.length)return t[0]+":"+t[1];else return t},exports.fastGet=function(e,t,n,i){var o=Q.defer(),s=[];if(t=t||[],t.forEach(function(e){s.push(exports.parse3SectionStyleHost(e))}),0===s.length)return log.warn("ip is empty for %s.",e),void o.reject({});var r=consts.UTILS_LOGIN_USER||{token:"notoken",eid:0};n.userId=r.eid,i=i||{};var a=e.indexOf("?")<0?"?":"&";if(n)Object.getOwnPropertyNames(n).forEach(function(e){var t=n[e];if("object"==typeof t)t=JSON.stringify(t);a+=e+"="+encodeURIComponent(t)+"&"});var l,c=-1,u=function(){if(c++,c<s.length)return l=format(e,s[c])+a,log.info("[%d/%d] Try to get data from web server %s",c+1,s.length,l),l;else;},d=consts.UTILS_COOKIE_KEY+"="+r.token,f=request.jar(),g=null,m=null,E=function(e,t,n){var s=!1;if(e)log.warn("Error occurred when try to get data from web server from url %s %s",l,e),s=!0;else if(200!=t.statusCode)if(log.info("Try next one to get data from web server because response status.",l,t.statusCode,t.statusCode),s=!0,t.elapsedTime>(i.requestSlowLog||3e3))log.error("Url %s request is too slow %d",l,t.elapsedTime);if(s)if(u())g=request.cookie(d),f.setCookie(g,l),m=request({url:l,headers:{"user-agent":i.userAgent||"client-vm(baidu) on nodejs"},timeout:i.syncRequestTimeout||3e3,gzip:i.syncRequestApplyGzip||!0,forever:!1,json:!0,time:!0,jar:f},E);else o.reject({});else if(0===n.status)log.info("Success to get data from web server url %s %s.",l,JSON.stringify(n)),o.resolve(n.data);else log.error("Fail to get data from web server because error business status %s %s.",l,JSON.stringify(n)),o.reject({})};if(netconnectivity.online)u(),g=request.cookie(d),f.setCookie(g,l),m=request({url:l,headers:{Cookie:d,"user-agent":i.userAgent||"client-vm(baidu) on nodejs"},timeout:i.syncRequestTimeout||3e3,gzip:i.syncRequestApplyGzip||!0,forever:!1,json:!0,time:!0,jar:f},E);else log.warn("Do not send request because offline."),o.reject({});return o.promise};