var ping=require("ping"),Q=require("q"),Emitter=require("events").EventEmitter,log=require("./log")("netconnectivity"),check=function(e,t,n){e.forEach(function(e){ping.sys.probe(e,function(i){var o=i?"host "+e+" is alive":"host "+e+" is dead";if(!network.online&&i)if(log.info("Net connectivity has resume, %s",o),network.online=!0,restartHowlong(),!t)network.emit("online");if(network.online&&!i)if(log.info("Net connectivity has losed, %s",o),network.online=!1,restartHowlong(),!t)network.emit("offline");if(!network.online&&network.howLong/network.checkInterval%5===0&&network.howLong/network.checkInterval/5>1)if(!t)network.emit("losed");if(n)n.resolve()})})},howlongCalcHandler=null,restartHowlong=function(){network.howLong=0,clearInterval(howlongCalcHandler),howlongCalcHandler=setInterval(function(){network.howLong+=1e3},1e3)},network=new Emitter;network.online=!1,network.howLong=0,network._hasInit=!1,network.init=function(e,t){var n=Q.defer();if(!network._hasInit){network.checkInterval=t;var i=[e];log.warn("TODO: Pick a host at this version."),check(i,!0,n),setInterval(check,network.checkInterval,i),network._hasInit=!0}else n.resolve();return n.promise},module.exports=network;