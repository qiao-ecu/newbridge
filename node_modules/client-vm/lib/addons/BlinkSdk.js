function Blink(e){Emitter.call(this),this.config=e;var t=path.resolve(__dirname,"./libblkClientSdk.dylib");this.sdk=FFI.Library(t,{BlkJsonInit:["int",["string","int",BLKCALLBACK]],BlkGetLastError:["void",[ref.refType("int"),ref.refType("char"),"int32"]],BlkLogin:["int",[BlkLoginReq,ref.refType(BlkLoginInfo),uint64Ptr]],BlkUnInit:["void",[]],BlkLogout:["int",["uint64",ref.refType("uint64")]]})}var Emitter=require("events").EventEmitter,inherits=require("util").inherits,Q=require("q"),path=require("path"),FFI=require("ffi"),ref=require("ref"),Struct=require("ref-struct"),ArrayType=require("ref-array"),Exception=require("../Exception"),consts=require("../utils/const"),log=require("../utils/log")("BlinkSdk"),char=ref.types["char"],int=ref.types["int"],uint32=ref.types.uint32,uint64=ref.types.uint64,uint64Ptr=ref.refType(uint64),CharArray=ArrayType(char),BlkAuthType={BLK_AUTH_LOCAL:0,BLK_AUTH_UC:1,BLK_AUTH_PAST:2,BLK_AUTH_UUAP:3,BLK_AUTH_BRG:4,BLK_AUTH_DUZHAN:5},BlkSerType={BLK_SERTYPE_TIEXIN:0,BLK_SERTYPE_DUZHAN:1,BLK_SERTYPE_NB:2},BlkStatus={BLK_STAT_INVALID:255,BLK_CSTAT_READY:0,BLK_CSTAT_BUSY:1,BLK_CSTAT_LEAVE:2,BLK_CSTAT_UNLOGIN:3,BLK_VSTAT_ENTER:256,BLK_VSTAT_ROUTING:257,BLK_VSTAT_QUEUEING:258,BLK_VSTAT_ALERTING:259,BLK_VSTAT_TALKING:260,BLK_VSTAT_LEAVE:261,BLK_VSTAT_TRANSFERING:262},BlkUser=Struct({userName:ArrayType(char,128),authType:ref.types["int"]}),BlkLoginReq=Struct({passwd:ArrayType(char,512),eid:uint32,serType:ref.types["int"],status:ref.types["int"]}),BlkLoginInfo=Struct({token:ArrayType(char,512),nickname:ArrayType(char,128),loginid:uint64}),BlkIpAddr=Struct({ip:ArrayType(char,16),port:uint32}),voidType=ref.types["void"],BLKCALLBACK=FFI.Function(voidType,["int",ref.refType(BlkUser),uint64,ref.refType(voidType)]),BlkProxyProto={BLK_PROXY_BGCC:0,BLK_PROXY_TCP:1,BLK_PROXY_SSL_TCP:2},BlkEncodeProto={BLK_GBK:0,BLK_UTF8:1},BlkPoxyStra={BLK_PXSTRA_SEQUENCE:0,BLK_PXSTRA_RANDOM:1,BLK_PXSTRA_PICKBEST:2},BlkRes={BLK_RES_SUCCESS:0,BLK_RES_CONNECT_ERROR:1,BLK_RES_INVAIID_PARAM:2,BLK_RES_SPACK_INSFFU:3,BLK_RES_REQ_TMO:4,BLK_RES_PROXY_FAIL:4097};inherits(Blink,Emitter),Blink.prototype.login=function(e,t){var n=Q.defer();log.info("Starting to login onto blink of %s",e);var i=this._init();if(i!=BlkRes.BLK_RES_SUCCESS){var o=this._getLastError(),s=new Exception(consts.MSG.E1002.code,consts.MSG.E1002.message,{code:o.code,message:o.message});n.reject(s)}else{var r=this._login(e,t);if(r.err){var a=new Exception(consts.MSG.E1002.code,consts.MSG.E1002.message,{code:o.code,message:o.message});n.reject(a)}else n.resolve(r)}return n.promise},Blink.prototype._init=function(){var e={},t=this.config.tcpServerip,n=[];t.forEach(function(e){var t=e.split(","),i={};if(3==t.length)i.ip=t[0],i.port=parseInt(t[1]);else t=e.split(":"),i.ip=t[0],i.port=parseInt(t[1]);n.push(i)}),e.addr=n,e.addrSize=t.length,e.proto=BlkProxyProto.BLK_PROXY_TCP,e.state=BlkPoxyStra.BLK_PXSTRA_RANDOM,e.encode=BlkEncodeProto.BLK_UTF8,e.reqTmo=this.config.blinkReqTmo||1e4,e.delayTm=this.config.blinkDelayTm||300,e.confPath=path.resolve(__dirname,"./bgcc.conf"),e.byeBeforeLogout=!0;var i=this._ntfDispatch;log.info("Before call sdk's init %s",JSON.stringify(e));var o=JSON.stringify(e),s=this.sdk.BlkJsonInit(o,o.length,i);return log.info("After call sdk's init return %s",s),s},Blink.prototype._getLastError=function(){var e=ref.alloc("int"),t=ArrayType("char",1e3),n=ref.alloc(t);return n.fill(0),this.sdk.BlkGetLastError(e,n,1e3),{code:e.deref(),message:n.deref()}},Blink.prototype._login=function(e,t){var n=this.config.eid,i=BlkAuthType.BLK_AUTH_BRG,o=new BlkLoginReq;o.eid=n,o.serType=i,o.passwd=t,o.status=BlkStatus.BLK_CSTAT_READY;var s=new BlkUser;s.authType=i,s.userName=e;var r=ref.alloc(BlkLoginInfo),a=ref.alloc("uint64");log.info("Before call sdk's login %s %s",JSON.stringify(s),JSON.stringify(o));var c=this.sdk.BlkLogin(s,o,r,a),l={username:e,eid:n};if(c!=BlkRes.BLK_RES_SUCCESS){var f=this._getLastError();l.err=f}else{var u=r.deref(),d=a.deref();log.info("After call sdk's login return %s %s",JSON.stringify(u),JSON.stringify(d)),l.reqid=d}return l},Blink.prototype._ntfDispatch=function(){var e=Array.prototype.slice.call(arguments,0);console.log(e)},module.exports=Blink;