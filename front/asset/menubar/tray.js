define(function(require){function e(e){return function(){exports.switchTray(e),c.action.apply(c,["vm:user","info","info","change","",{status:e}])}}function t(e,n,i){var r=e instanceof Array&&e.length;if(r)return d.each(e,function(e){var i={label:e.label};e.click&&(i.click=e.click),e.type&&(i.type=e.type),e.children&&(i.submenu=t(e.children,new f.Menu,e.id));var r=new f.MenuItem(i);m[e.id]=r,n.append(r)}),n}function n(){for(var e,t=0;e=g[t];t++)if("status"===e.id){u=e.children;break}}function i(e){for(var t,n,i=!1,r=0;n=u[r];r++)if(d.contains(n.value,e)){t=n,i=!0;break}return!i&&(t=u[3]),t}function r(e){var t=i(e);m[t.id].checked=!0,o.icon=s=p+t.icon,o.title=t.label}function a(){d.each(u,function(e){m[e.id].checked=!1})}var o,s,l,u,exports={},d=require("underscore"),c=requireNode("client-vm")(),f=requireNode("nw.gui"),h=f.Window.get(),p="resource/",m={},g=[{id:"open",label:"打开",click:function(){h.show(),h.focus()}},{id:"status",label:"状态",children:[{id:"online",label:"在线",type:"checkbox",value:[0],icon:"status_online.tif",click:e(0)},{id:"busy",label:"忙碌",type:"checkbox",value:[1],icon:"status_busy.tif",click:e(1)},{id:"leave",label:"离开",type:"checkbox",value:[2],icon:"status_leave.tif",click:e(2)},{id:"offline",label:"离线",type:"checkbox",value:[3,99],icon:"status_offline.tif",click:e(3)}]}];return exports.create=function(){l=t(g,new f.Menu,"tray"),c.data("vm:user","info","info").then(function(e){o=new f.Tray({title:"",menu:l,tooltip:"新商桥",iconsAreTemplates:!0});var t=e[0].status;n(),r(t)})},exports.switchTray=function(e){a(),r(e)},exports.trayFlash=function(){var e=0,t=0;setTimeout(function(){if(t++,0===e)o.icon=p+"flash.tif",e=1;else o.icon=s,e=0;if(16>t)setTimeout(arguments.callee,100)},100)},exports});