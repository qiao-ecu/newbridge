define(function(require){function e(e,n){function i(){if(I.hasOwnProperty(P))delete I[P];E=null}function r(){var e=0;for(var t in E.tables)if(E.tables.hasOwnProperty(t))e++;return e}function a(e){return E.tables[e].fields}function o(e){return E.tables[e]?!0:!1}function s(e){if(!o(e))L("The table '"+e+"' does not exist")}function l(e,t){var n=!1,i=E.tables[e].fields;for(var r in i)if(i[r]==t){n=!0;break}return n}function u(e,t){E.tables[e]={fields:t,auto_increment:1},E.data[e]={}}function d(e){delete E.tables[e],delete E.data[e]}function c(e){E.tables[e].auto_increment=1,E.data[e]={}}function f(e,t,n){if(E.tables[e].fields=E.tables[e].fields.concat(t),"undefined"!=typeof n)for(var i in E.data[e])if(E.data[e].hasOwnProperty(i))for(var r in t)if("object"==typeof n)E.data[e][i][t[r]]=n[t[r]];else E.data[e][i][t[r]]=n;else;}function h(e){var t=0;for(var n in E.data[e])if(E.data[e].hasOwnProperty(n))t++;return t}function p(e,t){return t.ID=E.tables[e].auto_increment,E.data[e][E.tables[e].auto_increment]=t,E.tables[e].auto_increment++,t.ID}function m(e,t,n,i,r,a){for(var o=null,s=[],l=null,u=0;u<t.length;u++)o=t[u],l=E.data[e][o],s.push(T(l));if(r&&r instanceof Array)for(var u=0;u<r.length;u++)s.sort(g(r[u][0],r[u].length>1?r[u][1]:null));if(a&&a instanceof Array){for(var d=0;d<a.length;d++)for(var c={},f=a[d],u=0;u<s.length;u++)if(void 0!==s[u])if(s[u].hasOwnProperty(f)&&c.hasOwnProperty(s[u][f]))delete s[u];else c[s[u][f]]=1;else;for(var h=[],u=0;u<s.length;u++)if(void 0!==s[u])h.push(s[u]);s=h}if(n=n&&"number"==typeof n?n:null,i=i&&"number"==typeof i?i:null,n&&i)s=s.slice(n,n+i);else if(n)s=s.slice(n);else if(i)s=s.slice(n,i);return s}function g(e,t){return function(n,i){var r="string"==typeof n[e]?n[e].toLowerCase():n[e],a="string"==typeof i[e]?i[e].toLowerCase():i[e];if("DESC"===t)return r==a?0:a>r?1:-1;else return r==a?0:r>a?1:-1}}function v(e,t){var n=[],i=!1,r=null;for(var a in E.data[e])if(E.data[e].hasOwnProperty(a)){r=E.data[e][a],i=!0;for(var o in t)if(t.hasOwnProperty(o)){if("string"==typeof t[o]){if(null===r[o]||r[o].toString().toLowerCase()!=t[o].toString().toLowerCase()){i=!1;break}}else if(r[o]!=t[o]){i=!1;break}}else;if(i)n.push(a)}else;return n}function y(e,t){var n=[],i=null;for(var r in E.data[e])if(E.data[e].hasOwnProperty(r)){if(i=E.data[e][r],1==t(T(i)))n.push(r)}else;return n}function _(e){var t=[];for(var n in E.data[e])if(E.data[e].hasOwnProperty(n))t.push(n);return t}function b(e,t){for(var n=0;n<t.length;n++)if(E.data[e].hasOwnProperty(t[n]))delete E.data[e][t[n]];return t.length}function w(e,t,n){for(var i="",r=0,a=0;a<t.length;a++){i=t[a];var o=n(T(E.data[e][i]));if(o){delete o.ID;var s=E.data[e][i];for(var l in o)if(o.hasOwnProperty(l))s[l]=o[l];E.data[e][i]=D(e,s),r++}}return r}function x(){try{return I.setItem(P,t.encode(JSON.stringify(E))),!0}catch(e){return!1}}function M(){return JSON.stringify(E)}function L(e){throw new Error(e)}function T(e){var t={};for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n];return t}function C(e){return e.toString().match(/[^a-z_0-9]/gi)?!1:!0}function D(e,t){for(var n="",i={},r=0;r<E.tables[e].fields.length;r++)if(n=E.tables[e].fields[r],void 0!==t[n])i[n]=t[n];return i}function k(e,t){for(var n="",i={},r=0;r<E.tables[e].fields.length;r++)n=E.tables[e].fields[r],i[n]=null===t[n]||void 0===t[n]?null:t[n];return i}var Y="db_",P=Y+e,S=!1,E=null;try{var I=n==sessionStorage?sessionStorage:localStorage}catch(N){var I=n}if(E=I[P],!(E&&(E=JSON.parse(t.decode(E)))&&E.tables&&E.data))if(!C(e))L("The name '"+e+"' contains invalid characters");else E={tables:{},data:{}},x(),S=!0;return{commit:function(){return x()},isNew:function(){return S},drop:function(){i()},serialize:function(){return M()},tableExists:function(e){return o(e)},tableFields:function(e){return a(e)},tableCount:function(){return r()},columnExists:function(e,t){return l(e,t)},createTable:function(e,t){var n=!1;if(!C(e))L("The database name '"+e+"' contains invalid characters.");else if(this.tableExists(e))L("The table name '"+e+"' already exists.");else{for(var i=!0,r=0;r<t.length;r++)if(!C(t[r])){i=!1;break}if(i){for(var a={},r=0;r<t.length;r++)a[t[r]]=!0;delete a.ID,t=["ID"];for(var o in a)if(a.hasOwnProperty(o))t.push(o);u(e,t),n=!0}else L("One or more field names in the table definition contains invalid characters")}return n},createTableWithData:function(e,t){if("object"!=typeof t||!t.length||t.length<1)L("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]");var n=Object.keys(t[0]);if(this.createTable(e,n)){this.commit();for(var i=0;i<t.length;i++)if(!p(e,t[i]))L("Failed to insert record: ["+JSON.stringify(t[i])+"]");this.commit()}return!0},dropTable:function(e){s(e),d(e)},truncate:function(e){s(e),c(e)},alterTable:function(e,t,n){var i=!1;if(!C(e))L("The database name '"+e+"' contains invalid characters");else if("object"==typeof t){for(var r=!0,a=0;a<t.length;a++)if(!C(t[a])){r=!1;break}if(r){for(var o={},a=0;a<t.length;a++)o[t[a]]=!0;delete o.ID,t=[];for(var s in o)if(o.hasOwnProperty(s))t.push(s);f(e,t,n),i=!0}else L("One or more field names in the table definition contains invalid characters")}else if("string"==typeof t)if(C(t)){var l=[];l.push(t),f(e,l,n),i=!0}else L("One or more field names in the table definition contains invalid characters");return i},rowCount:function(e){return s(e),h(e)},insert:function(e,t){return s(e),p(e,k(e,t))},insertOrUpdate:function(e,t,n){s(e);var i=[];if(!t)i=_(e);else if("object"==typeof t)i=v(e,D(e,t));else if("function"==typeof t)i=y(e,t);if(0==i.length)return p(e,k(e,n));else{for(var r=[],a=0;a<i.length;a++)w(e,i,function(e){return r.push(e.ID),n});return r}},update:function(e,t,n){s(e);var i=[];if(!t)i=_(e);else if("object"==typeof t)i=v(e,D(e,t));else if("function"==typeof t)i=y(e,t);return w(e,i,n)},query:function(e,t,n,i,r,a){s(e);var o=[];if(!t)o=_(e,n,i);else if("object"==typeof t)o=v(e,D(e,t),n,i);else if("function"==typeof t)o=y(e,t,n,i);return m(e,o,i,n,r,a)},queryAll:function(e,t){if(!t)return this.query(e);else return this.query(e,t.hasOwnProperty("query")?t.query:null,t.hasOwnProperty("limit")?t.limit:null,t.hasOwnProperty("start")?t.start:null,t.hasOwnProperty("sort")?t.sort:null,t.hasOwnProperty("distinct")?t.distinct:null)},deleteRows:function(e,t){s(e);var n=[];if(!t)n=_(e);else if("object"==typeof t)n=v(e,D(e,t));else if("function"==typeof t)n=y(e,t);return b(e,n)}}}var t=require("./crypto");return e});