define(function(require){var e=window.require,exports={},t="./cache",n=require("./globalData"),i=require("jquery"),r=e("fs"),a=e("mkdirp"),o=e("needle");return exports.READONLY=1,exports.WRITABLE=2,exports.cacheFile=function(e,t){var n=i.Deferred();if(!r.existsSync(e))return n.reject("文件不存在"),n.promise();var a=exports.getFilePathByBcsName(t,exports.WRITABLE),o=r.createReadStream(e),s=r.createWriteStream(a);return o.pipe(s),o.on("end",function(){n.resolve(t)}),n.promise()},exports.selectFile=function(e){e=e||{};var t=i.Deferred(),n='<input type="file" style="display:none;" ';if(e.multiple)n+="multiple ";if(e.directory)n+="nwdirectory ";if(e.path)n+='nwworkingdir="'+e.path+'" ';if(e.filter)n+='accept="'+e.filter.join(",")+'" ';n+="/>";var r=i(n);return console.log(n),r.on("change",function(){var e=i(this).val();t.resolve(e.split(";")),i(this).val("")}),r.click(),t.promise()},exports.exist=function(e){var t=exports.getFilePathByBcsName(e,exports.READONLY);return r.existsSync(t)},exports.saveBlob=function(e,t,n){var i=exports.getFilePathByBcsName(e,exports.WRITABLE),a=new FileReader;a.onload=function(t){var a=t.target.result;r.writeFile(i,a,"binary",function(){n({bcsName:e})})},a.readAsBinaryString(t)},exports.getFilePathByBcsName=function(e,n){if(e=e||"",e.length<3)return"";var i=e.substring(0,2),r=e.substring(2),o=t+"/"+i;if(n===exports.WRITABLE)a.sync(o);return o+="/"+r},exports.getUploadPath=function(e){var t=n.get("token"),i=n.get("serviceId"),r=n.get("domain");return"http://"+r+"/upload/"+e+"/"+t+"/"+i+"/4"},exports.getDownloadPath=function(e){var t=n.get("token"),i=n.get("serviceId"),r=n.get("domain");return"http://"+r+"/download/"+e+"/"+t+"/"+i+"/4/"+e},exports.upload=function(e){var t=require("jquery"),n=t.Deferred(),i=exports.getUploadPath(e),r=exports.getFilePathByBcsName(e,exports.READONLY),a={file:{file:r,content_type:"application/octet-stream"}};return o.post(i,a,{multipart:!0},function(t,i,r){if(t)n.reject(t);else n.resolve({bcsName:e})}),n.promise()},exports.download=function(e){var t=require("jquery"),n=t.Deferred(),i=exports.getDownloadPath(e),r=exports.getFilePathByBcsName(e,exports.WRITABLE);return o.get(i,{output:r},function(t,i,r){if(t)n.reject(t);else n.resolve({bcsName:e})}),n.promise()},exports});