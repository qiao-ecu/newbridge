define(function(require){function e(){i.apply(this,arguments)}function t(e){var t=document.createElement("div");if(e){var n=[];for(var i in e)if(e.hasOwnProperty(i))n.push(i+":"+e[i]+";");t.dataset.ui=n.join("")}return t}require("common/esuix/ActionPanelX");var n=require("esui/lib"),i=require("esui/Control"),r=require("er/Deferred"),a=require("esui/main"),o=require("underscore");return require("esui/controlHelper"),e.prototype.type="Layout",e.prototype.addFoldHandler=function(e,t){var i=document.createElement("div");this.helper.addPartClasses("fold",i),this.helper.addPartClasses("fold-"+t.fold,i),i.onclick=function(){n.toggleClass(e,"ui-layout-fold-zip"),n.toggleClass(e,"ui-layout-fold-zip-"+t.fold)},e.appendChild(i)},e.prototype.addDragHandler=function(e,t){function i(i){if(d){var r=t.drag,c={};if(c.x=i.pageX-u.x,c.y=i.pageY-u.y,o.map(a.classList,function(e){if(/^dragging/.test(e))a.classList.remove(e)}),o.map(f.classList,function(e){if(/^dragging/.test(e))f.classList.remove(e)}),"top"===r){var p=l-c.y;if(p<t.minHeight)p=t.minHeight,n.addClass(a,"dragging-top-min"),n.addClass(f,"dragging-top-min");else if(p>t.maxHeight)p=t.maxHeight,n.addClass(a,"dragging-top-max"),n.addClass(f,"dragging-top-max");e.style.height=p+"px"}else if("bottom"===r){var p=l+c.y;if(p<t.minHeight)p=t.minHeight,n.addClass(a,"dragging-bottom-min"),n.addClass(f,"dragging-bottom-min");else if(p>t.maxHeight)p=t.maxHeight,n.addClass(a,"dragging-bottom-max"),n.addClass(f,"dragging-bottom-max");e.style.height=p+"px"}else if("left"===r){var h=s-c.x;if(h<t.minWidth)h=t.minWidth,n.addClass(a,"dragging-left-min"),n.addClass(f,"dragging-left-min");else if(h>t.maxWidth)h=t.maxWidth,n.addClass(a,"dragging-left-max"),n.addClass(f,"dragging-left-max");e.style.width=h+"px"}else if("right"===r){var h=s+c.x;if(h<t.minWidth)h=t.minWidth,n.addClass(a,"dragging-right-min"),n.addClass(f,"dragging-right-min");else if(h>t.maxWidth)h=t.maxWidth,n.addClass(a,"dragging-right-max"),n.addClass(f,"dragging-right-max");e.style.width=h+"px"}}}function r(){d=!1,u={},n.removeClass(e,"layout-dragging"),f.style.display="none"}var a=document.createElement("div");this.helper.addPartClasses("drag",a),this.helper.addPartClasses("drag-"+t.drag,a),t.maxHeight=t.maxHeight||1/0,t.minHeight=t.minHeight||0,t.maxWidth=t.maxWidth||1/0,t.minWidth=t.minWidth||0;var s,l,u={},d=!1,f=document.createElement("div");f.className="mask-dragging",f.style.display="none",document.body.appendChild(f),this.helper.addPartClasses("mask-dragging-"+t.drag,f),a.onmousedown=function(t){s=parseInt(e.style.width,10),l=parseInt(e.style.height,10),d=!0,u.x=t.pageX,u.y=t.pageY,n.addClass(e,"layout-dragging"),f.style.display=""},this.moveHandler=i,this.upHandler=r,window.addEventListener("mousemove",i,!1),window.addEventListener("mouseup",r,!1),e.appendChild(a)},e.prototype.buildWrapper=function(e){e=e||{};var t=document.createElement("div");if(e.fold){var n=e.fold;if(("left"===n||"right"===n)&&"width"in e||("top"===n||"bottom"===n)&&"height"in e)this.addFoldHandler(t,e);else console.log("只有具有width属性的容器可以左右折叠"),console.log("只有具有height属性的容器可以上下折叠"),console.log("有问题的容器id: "+e.id)}if(e.drag){var n=e.drag;if(("left"===n||"right"===n)&&"width"in e||("top"===n||"bottom"===n)&&"height"in e)this.addDragHandler(t,e);else console.log("只有具有width属性的容器可以左右拖拽"),console.log("只有具有height属性的容器可以上下拖拽"),console.log("有问题的容器id: "+e.id)}if("width"in e)t.style.width=e.width+"px",t.style.flex="none",delete e.width;if("height"in e)t.style.height=e.height+"px",t.style.flex="none",delete e.height;return t},e.prototype.buildDom=function(e,n){if(e){if("container"===e.type)for(var i=e.row||e.column,r=e.row?"row":"column",a=0;a<i.length;a++){var o=this.buildWrapper(i[a]);this.helper.addPartClasses(r,n),n.appendChild(o),this.buildDom(i[a],o)}else n.appendChild(t(e)),this.helper.addPartClasses("item",n);return n}},e.prototype.repaintEvent=function(){var e=this,t=this.children;r.all(o.pluck(t,"promise")).then(function(){e.fire("ready")},function(){e.fire("fail")})},e.prototype.repaint=require("esui/painters").createRepaint(i.prototype.repaint,{name:["layoutOptions"],paint:function(e,t){e.helper.disposeChildren(),e.main.innerHTML="",e.buildDom(t,e.main),e.helper.initChildren(e.main),e.repaintEvent()}}),e.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED"))window.removeEventListener(this.upHandler),window.removeEventListener(this.moveHandler),i.prototype.dispose.apply(this,arguments)},n.inherits(e,i),a.register(e),e});