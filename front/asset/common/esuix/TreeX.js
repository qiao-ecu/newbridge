define(function(require){function e(){v.apply(this,arguments)}function t(){p.apply(this,arguments)}function n(e,t,n,i,r){var a=r-i,o=0===a?"current":1===a?"previous":"far-previous",s=[].concat(g.getPartClasses(e,"node-indicator"),g.getPartClasses(e,"node-indicator-"+n),g.getPartClasses(e,"node-indicator-level-"+i),g.getPartClasses(e,"node-indicator-"+o)),l=0===a?y[n||"collapsed"]:"第"+i+"级",u="<span ";if(0===a)u+='id="'+g.getId(e,"indicator-"+t.id)+'" ';return u+='class="'+s.join(" ")+'">'+l+"</span>"}function i(e,t,i,r){var o=g.getPartClasses(e,"content-wrapper");if(e.selectedNodeIndex[t.id])o=o.concat(g.getPartClasses(e,"content-wrapper-selected"));if(e.strategy.isLeafNode(t))o.push("leaf-node");else o.push("folder-node");o=o.join(" ");for(var s=g.getId(e,"content-wrapper-"+t.id),l='<div id="'+s+'" class="'+o+'">',u=e.strategy.isLeafNode(t)?"empty":r?"expanded":"collapsed",d=0;i>=d;d++)l+=n(e,t,u,d,i);var c=g.getPartClasses(e,"item-content");if(r&&e.strategy.isLeafNode(t))c.push("leaf-node");if(l+='<div class="'+c.join(" ")+'">'+e.getItemHTML(t)+"</div>",l+="</div>",r&&!e.strategy.isLeafNode(t)){var f=[].concat(g.getPartClasses(e,"sub-root"),g.getPartClasses(e,"sub-root-"+u));l+='<ul class="'+f.join(" ")+'">';for(var d=0;d<t.children.length;d++){var h=t.children[d];l+=a(e,h,i+1,e.strategy.shouldExpand(h))}l+="</ul>"}return l}function r(e,t,n,i){var r=e.strategy.isLeafNode(t)?"empty":i?"expanded":"collapsed",a=[].concat(g.getPartClasses(e,"node"),g.getPartClasses(e,"node-"+r),g.getPartClasses(e,"node-level-"+n));if(t===e.datasource)a=[].concat(g.getPartClasses(e,"root"),g.getPartClasses(e,"root-"+r),a);return a}function a(e,t,n,a,o){o=o||"li";var s=r(e,t,n,a),l="<"+o+' class="'+s.join(" ")+'" id="'+g.getId(e,"node-"+t.id)+'" data-id="'+t.id+'" data-level="'+n+'">';return l+=i(e,t,n,a),l+="</"+o+">"}function o(e){var t=e.target,n=g.getPartClasses(this,"node-indicator")[0],i=m.hasClass(t,n),r=!i,a=!1;if(m.hasClass(t,"group"))a=!0;if(!i){for(var o=g.getPartClasses(this,"content-wrapper")[0];t&&t!==this.main&&!m.hasClass(t,o);)t=t.parentNode;if(m.hasClass(t,o))i=this.wideToggleArea,r=r&&!0}if(i||r){for(;t&&t!==this.main&&!m.hasAttribute(t,"data-id");)t=t.parentNode;if(m.hasClass(t.firstChild,"folder-node"))i=!0,r=!1;else i=!1,r=!0;var s=t.getAttribute("data-id");if(a)r=!0,i=!1;if(i)this.triggerToggleStrategy(s);if(r)this.triggerSelectStrategy(s)}}function s(e){for(var t=e.target;t&&t!==this.main&&!m.hasAttribute(t,"data-id");)t=t.parentNode;var n=t.getAttribute("data-id");if(m.hasClass(t.firstChild,"leaf-node")){var i=this.nodeIndex[n];this.fire("dbclickLeafNode",{node:i})}}function l(e,t){if(t=t||{},t[e.id]=e,e.children)for(var n=0;n<e.children.length;n++)l(e.children[n],t);return t}function u(e,t){if(e.selectedNodeIndex[t.id])return!1;else return e.selectedNodes.push(t),e.selectedNodeIndex[t.id]=t,!0}function d(e,t){if(e.selectedNodeIndex[t.id]){delete e.selectedNodeIndex[t.id];for(var n=0;n<e.selectedNodes.length;n++)if(e.selectedNodes[n]===t)e.selectedNodes.splice(n,1);return!0}return!1}function c(e,t,n){if(n.force||e.allowUnselectNode){var i=e.nodeIndex[t];if(i){var r=d(e,i);if(r){if(n.modifyDOM){var a=m.g(g.getId(e,"content-wrapper-"+t));g.removePartClasses(e,"content-wrapper-selected",a)}if(!n.silent)e.fire("unselectnode",{node:i}),e.fire("selectionchange")}}}}function f(e,t){var n=g.getPartClasses(e,"node-empty")[0];return m.hasClass(t,n)}function h(e,t){var n=g.getPartClasses(e,"node-expanded")[0];return m.hasClass(t,n)}var p=require("esui/Control"),m=require("esui/lib"),g=require("esui/controlHelper"),v=require("esui/TreeStrategy");e.prototype.attachTo=function(){},m.inherits(e,v),t.prototype.type="Tree",t.defaultProperties={selectMode:"single",hideRoot:!1},t.prototype.initOptions=function(n){var i={datasource:{},strategy:new e,selectedNodes:[],selectedNodeIndex:{}},r=m.extend(i,t.defaultProperties,n);if(null==r.allowUnselectNode)r.allowUnselectNode="single"!==r.selectMode;this.setProperties(r)},t.prototype.itemTemplate="<span>${text}</span>",t.prototype.getItemHTML=function(e){var t={id:m.encodeHTML(e.id),text:m.encodeHTML(e.text)};return m.format(this.itemTemplate,t)};var y={collapsed:"展开",expanded:"收起",busy:"加载中",empty:"无内容"};return t.prototype.clickNode=function(e){o.apply(this,arguments)},t.prototype.dbclickNode=function(e){s.apply(this,arguments)},t.prototype.initStructure=function(){this.strategy.attachTo(this)},t.prototype.initEvents=function(){g.addDOMEvent(this,this.main,"click",this.clickNode),g.addDOMEvent(this,this.main,"dblclick",this.dbclickNode)},t.prototype.repaint=g.createRepaint(p.prototype.repaint,{name:"datasource",paint:function(e,t){e.selectedNodes=[],e.selectedNodeIndex={},e.nodeIndex=l(t),e.main.innerHTML=a(e,t,0,!0,"div")}},{name:"hideRoot",paint:function(e,t){var n=t?"addState":"removeState";e[n]("hide-root")}}),t.prototype.triggerSelectStrategy=function(e){var t=this.nodeIndex[e];if(t)if(this.selectedNodeIndex[e])this.fire("unselect",{node:t});else this.fire("select",{node:t})},t.prototype.getSelectedNodes=function(){return this.selectedNodes.slice()},t.prototype.toggleNodeSelection=function(e){var t=this.selectedNodeIndex[e]?"unselectNode":"selectNode";this[t](e)},t.prototype.selectNode=function(e,t){var n=this.nodeIndex[e];if(n){var i=u(this,n);if(i){if("single"===this.selectMode&&this.selectedNodes.length>1)c(this,this.selectedNodes[0].id,{force:!0,silent:!0,modifyDOM:!0});var r=m.g(g.getId(this,"content-wrapper-"+e));if(g.addPartClasses(this,"content-wrapper-selected",r),!t)this.fire("selectnode",{node:n}),this.fire("selectionchange")}}},t.prototype.unselectNode=function(e){c(this,e,{force:!0,silent:!1,modifyDOM:!0})},t.prototype.expandNode=function(e,t){var n=m.g(g.getId(this,"node-"+e));if(n){var a=+m.getAttribute(n,"data-level");if(t||"ul"!==n.lastChild.nodeName.toLowerCase()){var o=this.nodeIndex[e];if(!o)return;if(t){if(o.children)for(var s=0;s<o.children.length;s++)c(this,o.children[s].id,{force:!0,silent:!0,modifyDOM:!1}),this.nodeIndex[o.children[s].id]=void 0;o.children=t,l(o,this.nodeIndex)}n.innerHTML=i(this,o,a,!0)}else{var u=m.g(g.getId(this,"indicator-"+e));u.innerHTML=y.expanded;var d=[].concat(g.getPartClasses(this,"node-indicator"),g.getPartClasses(this,"node-indicator-level-"+a),g.getPartClasses(this,"node-indicator-current"),g.getPartClasses(this,"node-indicator-expanded"));u.className=d.join(" ");var f=[].concat(g.getPartClasses(this,"sub-root"),g.getPartClasses(this,"sub-root-expanded"));n.lastChild.className=f.join(" ")}var o=this.nodeIndex[e],h=r(this,o,a,!0);n.className=h.join(" ")}},t.prototype.collapseNode=function(e,t){var n=m.g(g.getId(this,"node-"+e));if(n){var i=this.nodeIndex[e],a=n.getElementsByTagName("ul")[0];if(a)if(t){if(a.parentNode.removeChild(a),i.children)for(var o=0;o<i.children.length;o++)c(this,i.children[o].id,{force:!0,silent:!1,modifyDOM:!1})}else{var s=[].concat(g.getPartClasses(this,"sub-root"),g.getPartClasses(this,"sub-root-collapsed"));a.className=s.join(" ")}var l=+m.getAttribute(n,"data-level"),u=r(this,i,l,!1);n.className=u.join(" ");var d=m.g(g.getId(this,"indicator-"+e)),f=[].concat(g.getPartClasses(this,"node-indicator"),g.getPartClasses(this,"node-indicator-level-"+l),g.getPartClasses(this,"node-indicator-current"),g.getPartClasses(this,"node-indicator-collapsed"));d.className=f.join(" "),d.innerHTML=y.collapsed}},t.prototype.toggleNode=function(e,t,n){if(this.nodeIndex[e]){var i=m.g(g.getId(this,"node-"+e));if(i)if(!f(this,i))if(h(this,i))this.collapseNode(e,n);else this.expandNode(e,t)}},t.prototype.triggerToggleStrategy=function(e){var t=this.nodeIndex[e];if(t){var n=m.g(g.getId(this,"node-"+e));if(n)if(!f(this,n))if(h(this,n))this.fire("collapse",{node:t});else this.fire("expand",{node:t})}},t.prototype.indicateNodeLoading=function(e){var t=m.g(g.getId(this,"node-"+e));if(t){for(var n=m.getChildren(t),i=0;!this.helper.isPart(n[i],"item-content");)i++;var r=n[i];r.innerHTML=y.busy;var a=[].concat(g.getPartClasses(this,"node-indicator"),g.getPartClasses(this,"node-indicator-level-"+i),g.getPartClasses(this,"node-indicator-current"),g.getPartClasses(this,"node-indicator-busy"));r.className=a.join(" ")}},t.prototype.dispose=function(){p.prototype.dispose.apply(this,arguments),this.nodeIndex=null,this.selectedNodes=null,this.selectedNodeIndex=null},require("esui/main").register(t),m.inherits(t,p),t});