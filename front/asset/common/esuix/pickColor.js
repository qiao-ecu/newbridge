define(function(require){function e(){p.apply(this,arguments)}function t(e){var t=e.target,n=t.className;switch(n){case"ui-button-ok":this.saveColorCode();break;case"ui-button-circle":this.hide();break;case"ui-pickcolor-handel":this.setPanelColor(e);break;case"ui-pickcolor-handel-bg":this.setPanelColor(e)}}function n(e){var t=e.target,n=t.className;switch(n){case"ui-pickcolor-value":this.inputColorCode(e)}}function i(t){h.apply(this,arguments),this.colorCode=null,this.hsv={h:0,s:0,v:1},this.targetEles=null,this.targetElesData={},this.layer=new e(this),this.view={panel:null,codeValue:null,preview:null,btnOk:null,btnCancel:null,dot:null,pointer:null},this.init(t)}function r(e){e=e.replace("#","");var t,n=e.split("");if(6===n.length)t="#"+n.join("");else{for(var i=6-n.length;i;)n.unshift(0),i--;t="#"+n.join("")}return t}function a(e){for(var t=/^[0-9a-fA-F]$/,n=!0,i=e.split(""),r=0,a=i.length;a>r;r++)if(!t.test(i[r])){n=!1;break}return n}function o(e){e=e.replace("#","");var t=parseInt(e.substr(0,2),16),n=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16);return{r:t,g:n,b:i}}function s(e,t,n){var i,r,a=e/255,o=t/255,s=n/255,l=Math.max(Math.max(a,o),s),u=Math.min(Math.min(a,o),s),d=l;if(u===l)i=0,r=0;else{var c=l-u;if(r=c/l,a===l)i=(o-s)/c;else if(o===l)i=2+(s-a)/c;else i=4+(a-o)/c;if(i/=6,0>i)i+=1;if(i>1)i-=1}return{h:Math.floor(1e3*i)/1e3,s:Math.floor(1e3*r)/1e3,v:Math.floor(1e3*d)/1e3}}function l(e){var t=this.getPanelColor(e.top);d(100,this,this.setPanelBackColor)(t),d(100,this,this.updataViewContent)(this.getColorCode()),d(100,this,this.updataColorCode)()}function u(e){var t=e.left,n=e.top;this.hsv.s=t/255,this.hsv.v=(255-n)/255,d(100,this,this.updataViewContent)(this.getColorCode()),d(100,this,this.updataColorCode)()}function d(e,t,n){var i=null;if(!n.throttleOld)n.throttleOld=(new Date).getTime(),i=function(){n.apply(t,arguments)};else i=function(){var i=(new Date).getTime();if(i-n.throttleOld>e)n.apply(t,arguments),n.throttleOld=i};return i}var c=require("esui/main"),f=require("esui/lib"),h=require("esui/Control"),p=require("esui/Layer"),m=require("mini-event/EventTarget"),g=require("jquery");return f.inherits(e,p),e.prototype.itemTemplate='<div class="${main}"><div class="${head}"><div class="${panel}"><span class="${dot}"></span></div><div class="${handel}"><div class="${handelBg}"></div><span class="${pointer}"></span></div></div><div class="${cont}"><span class="${tip}">#</span><input class="${value}" maxlength="6"><div class="${view}"></div><span class="ui-button-circle">取消</span><span class="ui-button-ok">确定</span></div></div>',e.prototype.render=function(e){var t={main:this.control.helper.getPartClasses("main"),head:this.control.helper.getPartClasses("head"),panel:this.control.helper.getPartClasses("panel"),dot:this.control.helper.getPartClasses("dot"),handel:this.control.helper.getPartClasses("handel"),handelBg:this.control.helper.getPartClasses("handel-bg"),pointer:this.control.helper.getPartClasses("pointer"),cont:this.control.helper.getPartClasses("cont"),tip:this.control.helper.getPartClasses("tip"),value:this.control.helper.getPartClasses("value"),view:this.control.helper.getPartClasses("view"),okId:this.control.helper.getId("ok"),cancelId:this.control.helper.getId("cancelId")},n=f.format(this.itemTemplate,t);e.innerHTML=n},e.prototype.initBehavior=function(e){this.control.helper.addDOMEvent(e,"click",t),this.control.helper.addDOMEvent(e,"keyup",n)},e.prototype.hide=function(e){if(!e&&this.control.active)this.control.cancelColorCode();p.prototype.hide.call(this)},i.prototype.dragHandler=function(e){var t=e.bar,n=e.target,i=e.maxHeight,r=e.maxWidth,a=e.callBack,o=e.withMouse,s=n.height()/2,l=n.width()/2,u=this.view.panel,d=g(document),c=null,f=null,h={},p=this;t.dragFlag=!1,t.on("mousedown",function(e){if(t.dragFlag=!0,h.left=e.clientX,h.top=e.clientY,h.tagTop=parseInt(n.css("top"),10),h.tagLeft=parseInt(n.css("left"),10),o){var i=e.clientX-u.offset().left,r=e.clientY-u.offset().top;h.tagTop=r,h.tagLeft=i,p.setDotPos(i,r);var s=i>255?255:i,l=r>255?255:r;s=0>s?0:s,l=0>l?0:l,a.apply(p,[{left:s,top:l}])}}),d.on("mousemove",function(e){if(t.dragFlag){var o=e.clientX-h.left,u=e.clientY-h.top;c=h.tagTop+u,f=h.tagLeft+o;var d,m;if(i){if(-s>c)d=-s;else if(c>i)d=i-s;else d=c;n.css("top",d)}if(r){if(-l>f)m=-l;else if(f>r)m=r-l;else m=f;n.css("left",m)}var g=f>255?255:f,v=c>255?255:c;g=0>g?0:g,v=0>v?0:v,a&&a.apply(p,[{left:g,top:v}]),e.preventDefault()}}),d.on("mouseup",function(e){t.dragFlag=!1})},i.prototype.type="pickColor",m.enable(i),i.prototype.inputColorCode=function(e){var t=this.view.codeValue.val();if(a(t)){var n=r(t),i=o(n),l=s(i.r,i.g,i.b);this.hsv=l,this.setColorPos(),this.setPreview(n),this.colorCode=n,this.updataColorCode()}},i.prototype.saveColorCode=function(){this.callBackFunc&&this.callBackFunc(),this.targetElesData[this.targetEles].color=this.colorCode,this.fire("ok",{data:{ele:this.targetElesData[this.targetEles].ele,color:this.targetElesData[this.targetEles].color}}),this.hide(!0)},i.prototype.cancelColorCode=function(){this.fire("cancel",{data:{ele:this.targetElesData[this.targetEles].ele,color:this.targetElesData[this.targetEles].color}})},i.prototype.updataColorCode=function(){this.fire("update",{data:{ele:this.targetElesData[this.targetEles].ele,color:this.colorCode}})},i.prototype.getPanelColor=function(e){if(0>e)e=0;if(e>255)e=255;this.hsv.h=(255-e)/255;var t=this.getColorCode({h:this.hsv.h,s:1,v:1});return t},i.prototype.setPanelColor=function(e){var t=e.offsetY,n=this.getPanelColor(t);this.setPanelBackColor(n),this.setPointerPos(t-this.view.pointer.height()/2),this.updataViewContent(n)},i.prototype.setPanelBackColor=function(e){this.view.panel.css("backgroundColor",e)},i.prototype.setPointerPos=function(e){this.view.pointer.css("top",e)},i.prototype.getColorPos=function(e){var t=e.offsetX,n=e.offsetY;this.hsv.s=t/255,this.hsv.v=(255-n)/255;var i=this.getColorCode();this.setDotPos(t,n),this.updataViewContent(i)},i.prototype.setColorPos=function(e){var t=Math.floor(255*this.hsv.s-this.view.dot.width()/2),n=Math.floor(255-255*this.hsv.v-this.view.dot.height()/2);this.setDotPos(t,n);var i=Math.floor(255-255*this.hsv.h-this.view.pointer.height()/2);if(i>255)i=255-this.view.pointer.height()/2;this.setPointerPos(i);var r=this.getColorCode({h:this.hsv.h,s:1,v:1});this.setPanelBackColor(r)},i.prototype.setDotPos=function(e,t){var n=this.view.dot,i=this.dotPosHandler({x:e-n.width()/2,y:t-n.height()/2});n.css({left:i.left,top:i.top}),n.show()},i.prototype.dotPosHandler=function(e){var t,n,i=this.view.dot,r=255-i.width(),a=0,o=255-i.height(),s=0;if(e.x<a)t=a;else if(e.x>r)t=r;else t=e.x;if(e.y<s)n=s;else if(e.y>o)n=o;else n=e.y;return{left:t,top:n}},i.prototype.updataView=function(){this.view.main=g(".ui-pickcolor-main").last(),this.view.panel=g(".ui-pickcolor-panel").last(),this.view.pointer=g(".ui-pickcolor-pointer").last(),this.view.codeValue=g(".ui-pickcolor-value").last(),this.view.preview=g(".ui-pickcolor-view").last(),this.view.btnOk=g(".ui-button-ok").last(),this.view.btnCancel=g(".ui-button-circle").last(),this.view.dot=g(".ui-pickcolor-dot").last(),this.view.handel=g(".ui-pickcolor-handel").last()},i.prototype.updataViewContent=function(e){this.view.codeValue.val(e.replace("#","")),this.setPreview(e),this.colorCode=e},i.prototype.setPreview=function(e){this.view.preview.css("background",e)},i.prototype.setColor=function(e,t){this.colorCode=t,this.setTargetElesData(e,t)},i.prototype.getColorCode=function(e){e=e||{};var t=this.hsv,n=e.h||t.h,i=e.s||t.s,r=e.v||t.v,a=this.hsv2rgb(n,i,r);return"#"+this.rgb2hex(a.r)+this.rgb2hex(a.g)+this.rgb2hex(a.b)},i.prototype.rgb2hex=function(e){if(e=e.toString(16),1===e.length)e="0"+e;return e},i.prototype.hsv2rgb=function(e,t,n){var i,r,a;if(0===t)i=255*n,r=255*n,a=255*n;else{var o=6*e;if(6===o)o=0;var s=Math.floor(o),l=n*(1-t),u=n*(1-t*(o-s)),d=n*(1-t*(1-(o-s)));switch(s){case 0:i=n,r=d,a=l;break;case 1:i=u,r=n,a=l;break;case 2:i=l,r=n,a=d;break;case 3:i=l,r=u,a=n;break;case 4:i=d,r=l,a=n;break;default:i=n,r=l,a=u}i=255*i,a=255*a,r=255*r}return{r:Math.ceil(i),g:Math.ceil(r),b:Math.ceil(a)}},i.prototype.setTargetElesData=function(e,t){this.targetElesData[e]={ele:e,color:t}},i.prototype.render=function(e){this.targetEles=e.ele,this.callBackFunc=e.callBackFunc;var t=this.targetElesData[e.ele]?this.targetElesData[e.ele].color:e.color;this.setTargetElesData(e.ele,t),this.show(e);var n=this.getPos(e);this.setPos(n)},i.prototype.show=function(e){if(e=e||{},this.view.codeValue){var t=this.targetElesData[e.ele]?this.targetElesData[e.ele].color:e.color,n=r(t);this.updataViewContent(n);var i=o(n),a=s(i.r,i.g,i.b);this.hsv=a,this.setColorPos(e)}this.layer.show()},i.prototype.hide=function(e){if(this.view.pointer)this.view.pointer.dragFlag=!1,this.view.panel.dragFlag=!1;this.layer.hide(e)},i.prototype.getPos=function(e){var t=this.getPosHandler(e);return{left:t.left,top:t.top}},i.prototype.getPosHandler=function(e){var t=g(e.ele),n=t.offset().left,i=t.offset().top,r=t.outerWidth(),a=t.outerHeight(),o=g(window).width(),s=g(window).height(),l=this.view.main.outerWidth(),u=this.view.main.outerHeight(),d=g(document).scrollTop(),c=g(document).scrollLeft(),f=o-(n-c+r),h=s-(i-d+a),p=null,m=null;if(f>l+e.left)p=n+r+e.left;else p=n-l-e.left;if(h>u+e.top)m=i+e.top;else m=s-u+d;return{left:p,top:m}},i.prototype.setPos=function(e){var t=this.layer.getElement();t.style.left=e.left+"px",t.style.top=e.top+"px"},i.prototype.init=function(e){function t(t){i.callBackFunc=null,n.render(g.extend(i,e[t.data]))}var n=this,i={left:0,top:0,color:"#ffffff",callBackFunc:null};this.show(),this.hide(!0),this.updataView(),this.dragHandler({target:this.view.pointer,bar:this.view.pointer,maxHeight:this.view.handel.height(),callBack:l}),this.dragHandler({target:this.view.dot,bar:this.view.panel,maxHeight:this.view.panel.height(),maxWidth:this.view.panel.width(),callBack:u,withMouse:!0});for(var r=0,a=e.length;a>r;r++)g(e[r].ele).bind("click",r,t);g(window).on("resize.PickColor",function(){n.hide()})},i.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;g(window).off("resize.PickColor"),h.prototype.dispose.apply(this,arguments)}},f.inherits(i,h),c.register(i),i});