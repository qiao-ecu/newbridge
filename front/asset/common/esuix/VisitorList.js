define(function(require){function e(){n.apply(this,arguments)}var t=require("esui/lib"),n=(require("esui/controlHelper"),require("esui/Control")),i=(require("er/Deferred"),require("esui/main"),require("underscore"));require("common/esuix/Accordion"),e.prototype.type="VisitorList",e.prototype.initStructure=function(){this.main.innerHTML='<div data-ui="type:Accordion;childName:waitingList;">    <div data-title="<div class=&quot;accordion-waiting-#{count}&quot;><div class=&quot;accordion-nowaiting&quot;>无访客等待开始</div><div class=&quot;accordion-waiting&quot;>#{count}位访客等待开始</div></div>">    </div>    <div data-ui="type:Accordion;childName:talkList;skin:visitor;" data-title="我的访客">        <div data-title="对话中 #{count}">        </div>        <div data-title="邀请中 #{count}">        </div>    </div>    <div data-ui="type:Accordion;childName:visitList;skin:visitor;" data-title="全部访客">        <div data-title="访问中 #{count}">        </div>        <div data-title="机器人接待 #{count}">        </div>        <div data-title="已离开 #{count}">        </div>    </div></div>',this.helper.initChildren(),this.waitingList=this.getChild("waitingList"),this.talkList=this.waitingList.getChild("talkList"),this.visitList=this.waitingList.getChild("visitList");var e="<div "+this.indexKey+'="#{'+this.indexKey+'}" class="visitor-list-wrapper">    <span class="visitor-list-name">#{name}</span>    <span class="visitor-list-unread visitor-list-unread-#{unread}">#{unread}</span>    <div class="visitor-list-icons">        <div class="visitor-list-fst-visit-#{fstVisit}" title="熟客"></div>        <div class="visitor-list-recent-#{recent}" title="您与访客最近沟通过"></div>        <div class="visitor-list-unread-#{fstVisit}"></div>        <div class="visitor-list-from-engine-#{fromEngine}" title="访客来源"></div>        <div class="visitor-list-device-#{clientType}" title="访问设备"></div>        <div class="visitor-list-block-#{block}" title="访客被屏蔽"></div>',t='        <div class="visitor-list-time" waiting="#{time}"></div>',n="    </div></div>";this.talkList.itemTemplate=e+n,this.visitList.itemTemplate=e+n,this.waitingList.itemTemplate=e+t+n};var r={talking:{list:"talkList",index:0},inviting:{list:"talkList",index:1},visiting:{list:"visitList",index:0},robot:{list:"visitList",index:1},leave:{list:"visitList",index:2},waiting:{list:"waitingList",index:0}};e.prototype.normalizeData=function(e){e.unread=e.unread||0,e.fromEngine=e.fromEngine||0,e.time=e.time||0},e.prototype.add=function(e){this.normalizeData(e);var t=r[e.type];if(t){var n=this[t.list].insertBefore(e,t.index);if(n.data=e,this.selectedBid){var i=n.getAttribute("bid");if(i===this.selectedBid)this.selectedType=e.type,this.selectedData=e,this.helper.addPartClasses("selected",n)}}},e.prototype.edit=function(e){this.normalizeData(e);var t=r[e.type],n=this[t.list].getIndex(this.indexKey,e[this.indexKey]),i=this[t.list].editItem(e,t.index,n);if(i.data=e,i&&this.selectedBid){var a=i.getAttribute("bid");if(a===this.selectedBid)this.selectedType=e.type,this.selectedData=e,this.helper.addPartClasses("selected",i)}},e.prototype.remove=function(e){this.normalizeData(e);var t=r[e.type],n=this[t.list].getIndex(this.indexKey,e[this.indexKey]),i=this[t.list].remove(t.index,n);if(i&&this.selectedBid){var a=i.getAttribute("bid");if(a===this.selectedBid)this.selectedType="",this.selectedData=null}},e.prototype.updateWaitingTimePerSecond=function(){var e=this.getChild("waitingList");setInterval(function(){i.map(e.getList(0),function(e){dom=e.getElementsByClassName("visitor-list-time")[0];var t=dom.getAttribute("waiting")-0+1,n=parseInt(t/60,10),i=t-60*n,r="";if(n)r+=n+"分";if(i)r+=i+"秒";dom.innerHTML=r,dom.setAttribute("waiting",t)})},1e3)},e.prototype.select=function(e){if(e){this.selectedBid=e.getAttribute("bid");var t=this,n=this.main.getElementsByClassName("visitor-list-wrapper");i.map(n,function(e){t.helper.removePartClasses("selected",e)}),t.helper.addPartClasses("selected",e)}},e.prototype.initEvents=function(){var e=this,t=e.getChild("waitingList"),n=t.getChild("talkList"),i=t.getChild("visitList");t.on("select",function(t){var n=t.element;if(n){var i=n.getAttribute(e.indexKey);if(0===t.index){if(e.selectVisitor===i)return;else e.selectVisitor=i;e.selectedType="waiting",e.selectedData=n.data,e.fire("select",{visitorType:"waiting",id:i,element:n})}}}),t.on("dblclick",function(t){var n=t.element;if(n){var i=n.getAttribute(e.indexKey);if(0===t.index)e.selectedType="waiting",e.selectedData=n.data,e.fire("dblclick",{visitorType:"waiting",id:i,element:n})}}),n.on("select",function(t){var n=t.element,i=n.getAttribute(e.indexKey);if(e.selectVisitor!==i){e.selectVisitor=i;var r="";switch(t.index){case 0:r="talking";break;case 1:r="inviting"}e.selectedType=r,e.selectedData=n.data,e.fire("select",{visitorType:r,id:i,element:n})}}),n.on("dblclick",function(t){var n=t.element,i=n.getAttribute(e.indexKey),r="";switch(t.index){case 0:r="talking";break;case 1:r="inviting"}e.selectedType=r,e.fire("dblclick",{visitorType:r,id:i,element:n})}),i.on("select",function(t){var n=t.element,i=n.getAttribute(e.indexKey);if(e.selectVisitor!==i){e.selectVisitor=i;var r="";switch(t.index){case 0:r="visiting";break;case 1:r="robot";break;case 2:r="leave"}e.selectedType=r,e.fire("select",{visitorType:r,id:i,element:n})}}),i.on("dblclick",function(t){var n=t.element,i=n.getAttribute(e.indexKey),r="";switch(t.index){case 0:r="visiting";break;case 1:r="robot";break;case 2:r="leave"}e.selectedType=r,e.fire("dblclick",{visitorType:r,id:i,element:n})}),e.on("select",function(t){e.select(t.element)}),e.updateWaitingTimePerSecond()},t.inherits(e,n),require("esui/main").register(e)});