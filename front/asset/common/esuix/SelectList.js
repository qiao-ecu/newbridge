define(function(require){function e(e){for(var t=o.event.getTarget(e),n=this.layer.getElement();t&&t!==n&&!o.hasAttribute(t,"data-index");)t=t.parentNode;if(t&&!this.helper.isPart(t,"item-disabled")){var i=t.getAttribute("data-index");this.set("selectedIndex",+i),this.layer.hide()}}function t(){l.apply(this,arguments)}function n(e){s.apply(this,arguments),this.layer=new t(this)}function i(e){if(null==e.selectedIndex&&null==e.rawValue&&null==e.value)e.selectedIndex=-1;if(null!=e.rawValue)e.value=null,e.selectedIndex=null;else if(null!=e.value)e.selectedIndex=null;if(null==e.selectedIndex&&(null!=e.value||null!=e.rawValue)){e.selectedIndex=-1;for(var t=e.rawValue||e.value,n=0;n<e.datasource.length;n++)if(e.datasource[n].value===t){e.selectedIndex=n;break}delete e.value,delete e.rawValue}if(e.selectedIndex<0||e.selectedIndex>=e.datasource.length)if(e.emptyText)e.selectedIndex=-1;else for(e.selectedIndex=-1,n=0;n<e.datasource.length;n++)if(!e.datasource[n].disabled){e.selectedIndex=n;break}}function r(e){var t=e.helper.getPart("text"),n=-1===e.selectedIndex?null:e.datasource[e.selectedIndex];t.innerHTML=e.getDisplayHTML(n);var i=e.layer.getElement(!1);if(i)e.layer.syncState(i)}var a=require("underscore"),o=require("esui/lib"),s=require("esui/InputControl"),l=require("common/esuix/LayerX");o.inherits(t,l),t.prototype.nodeName="div",t.prototype.render=function(e){for(var t='<div class="select-list-content"><ol>',n=0;n<this.control.datasource.length;n++){var i=this.control.datasource[n],r=this.control.helper.getPartClasses("item");if(i.disabled)r.push.apply(r,this.control.helper.getPartClasses("item-disabled"));t+='<li data-index="'+n+'" class="'+r.join(" ")+'">',t+=this.control.getItemHTML(i),t+="</li>"}t+="</ol></div>",e.innerHTML=t},t.prototype.initBehavior=function(t){this.control.helper.addDOMEvent(t,"click",e)},t.prototype.syncState=function(e){for(var t=this.control.helper.getPartClasses("item-selected"),n=o.getChildren(e.getElementsByTagName("ol")[0]),i=n.length-1;i>=0;i--){var r=n[i];if(i===this.control.selectedIndex)o.addClasses(r,t);else o.removeClasses(r,t)}},t.prototype.dock={strictWidth:!0,width:!0},n.prototype.type="SelectList",n.prototype.initOptions=function(e){var t={datasource:[]},n={};if(a.extend(n,t,e),"select"===this.main.nodeName.toLowerCase()){n.datasource=[];for(var i=this.main.getElementsByTagName("option"),r=0,o=i.length;o>r;r++){var s=i[r],l={name:s.name||s.text,value:s.value};if(s.disabled)l.disabled=!0;if(n.datasource.push(l),s.selected&&null==n.selectedIndex&&null==n.value&&null==n.rawValue)n.selectedIndex=s.value?r:0}this.helper.extractOptionsFromInput(this.main,n)}if("string"==typeof n.selectedIndex)n.selectedIndex=+n.selectedIndex;this.setProperties(n)},n.prototype.itemTemplate="<span>${text}</span>",n.prototype.getItemHTML=function(e){var t={text:a.escape(e.name||e.text),value:a.escape(e.value)};return o.extend(t,e),o.format(this.itemTemplate,t)},n.prototype.displayTemplate="${text}",n.prototype.getDisplayHTML=function(e){if(!e)return a.escape(this.emptyText||"");var t={text:a.escape(e.name||e.text),value:a.escape(e.value)};return o.extend(t,e),o.format(this.displayTemplate,t)},n.prototype.initStructure=function(){if("select"===this.main.nodeName.toLowerCase())this.helper.replaceMain();this.main.tabIndex=0,this.main.innerHTML=this.helper.getPartHTML("text","span")},n.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"click",a.bind(this.layer.toggle,this.layer))},n.prototype.getRawValue=function(){if(this.selectedIndex<0)return null;var e=this.datasource[this.selectedIndex];return e?e.value:null};var u=require("esui/painters");return n.prototype.repaint=u.createRepaint(s.prototype.repaint,u.style("width"),u.style("height"),{name:"datasource",paint:function(e){e.layer.repaint()}},{name:["selectedIndex","emptyText","datasource"],paint:r},{name:["disabled","hidden","readOnly"],paint:function(e,t,n,i){if(t||n||i)e.layer.hide()}}),n.prototype.updateDatasource=function(e){if(!e)e=this.datasource;this.datasource=e;var t={name:"datasource"};this.repaint([t],{datasource:t})},n.prototype.setProperties=function(e){if(null==e.datasource)e.datasource=this.datasource;if(null==e.value&&null==e.rawValue&&null==e.selectedIndex&&e.datasource===this.datasource)e.selectedIndex=this.selectedIndex;if(!e.hasOwnProperty("emptyText"))e.emptyText=this.emptyText;i(e);var t=s.prototype.setProperties.apply(this,arguments);if(t.hasOwnProperty("selectedIndex"))this.fire("change");return t},n.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;s.prototype.dispose.apply(this,arguments)}},n.prototype.getSelectedItem=function(){return this.get("datasource")[this.get("selectedIndex")]},o.inherits(n,s),require("esui/main").register(n),n});