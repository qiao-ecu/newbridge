define(function(require){function e(){E.apply(this,arguments)}function t(e){var t=e.parent().prev(),n=t.html().split("-");n=n[2]?n[2]:"";var i=+n===(new Date).getDate();return i}function n(e){var t=e.prev(),n=O(t).val(),i=+n===(new Date).getHours();return i}function i(e){var t;if(10>e)t="0"+e;else t=e;return t}function r(e,t){var n=new Date(e),i=new Date,r=e.split(" ")[0],a=null;if(n+""=="Invalid Date"){if(-1===i.toJSON().indexOf(r))a=new Date(r+" 23:59:59");else a=new Date;if("begin"===t)a=new Date(r+" 00:00:00")}else a=n;return a}function a(e,t){e.view.begin=t.begin,e.view.end=t.end,e.value=e.convertToParam(t),x(e,"begin",t.begin),x(e,"end",t.end);var n=_(e,e.view);b(e,n);var i;if(!t.end)i=!0;else i=!1;e.setProperties({isEndless:i})}function o(t){this.now=new Date,S.apply(this,arguments),this.layer=new e(this)}function s(e){var t='<div class="${shortCutClass}" id="${shortcutId}">${shortCut}</div><div class="${bodyClass}">${beginCalendar}${endCalendar}</div><div class="${footClass}"><div class="${okBtnClass}" data-ui="type:Button;childName:okBtn;">确定</div><div class="${cancelBtnClass}" data-ui="type:Button;childName:cancelBtn;">取消</div></div><div data-ui="type:Button;childName:closeBtn;skin:layerClose;height:12;">X</div>';return Y.format(t,{bodyClass:e.helper.getPartClassName("body"),shortcutId:e.helper.getId("shortcut"),shortCutClass:e.helper.getPartClassName("shortcut"),shortCut:c(e),beginCalendar:f(e,"begin"),endCalendar:f(e,"end"),footClass:e.helper.getPartClassName("foot"),okBtnClass:e.helper.getPartClassName("okBtn"),cancelBtnClass:e.helper.getPartClassName("cancelBtn")})}function l(e){return N(e).startOf("day").toDate()}function u(e){return N(e).endOf("day").toDate()}function d(e,t){var n=e.range,i=t.getValue.call(e);if(l(n.begin)>l(n.begin)||u(i.end)<u(i.end))return!0;else return!1}function c(e){for(var t=e.shownShortCut.split(","),n={},i=0;i<t.length;i++)n[t[i]]=!0;for(var r='<span data-index="${shortIndex}" class="'+e.helper.getPartClassName("shortcut-item")+' ${shortClass}" id="${shortId}">${shortName}</span>',a=e.shortCutItems,o=a.length,s=[],l=0;o>l;l++){var u=a[l];if(n[u.name]){var c=u.name,f=[];if(0===l)f=f.concat(e.helper.getPartClasses("shortcut-item-first"));var h=d(e,u);if(h)f=f.concat(e.helper.getPartClasses("shortcut-item-disabled"));var p=e.helper.getId("shortcut-item"+l);s.push(Y.format(r,{shortIndex:l,shortClass:f.join(" "),shortId:p,shortName:c}))}}return s.join("")}function f(e,t){var n="";if(e.endlessCheck&&"end"===t)n='<input type="checkbox" title="不限结束" data-ui-type="CheckBox" data-ui-child-name="endlessCheck" />';var i='<div class="${frameClass}"><div class="${labelClass}"><h3>${labelTitle}</h3>'+n+'</div><div class="${calClass}"><div data-ui="type:MonthView;childName:${calName}"></div></div>${timeContent}</div>';return Y.format(i,{frameClass:e.helper.getPartClassName(t),labelClass:e.helper.getPartClassName("label"),labelTitle:"begin"===t?"开始日期":"结束日期",titleId:e.helper.getId(t+"Label"),calClass:e.helper.getPartClassName(t+"-cal"),calName:t+"Cal",timeContent:h(e,t)})}function h(e,t){var n=e.dateFormat,i="";if("YYYY-MM-DD"!==n){var r=p(e),a='<div class="${contentClass}" data-type="${type}"><span class="${dateClass}" data-type="${type}">${dateVaule}</span><span class="${timeClass}"><input class="${minuteClass}" type="text" value="${minuteValue}"maxlength="${maxlength}" data-type="${type}">:<input class="${secondsClass}" type="text" value="${secondsValue}"maxlength="${maxlength}" data-type="${type}"></span></div>';i=Y.format(a,{contentClass:e.helper.getPartClasses("date-time"),dateClass:e.helper.getPartClasses("date"),timeClass:e.helper.getPartClasses("time"),minuteClass:e.helper.getPartClasses("minute"),secondsClass:e.helper.getPartClasses("seconds"),dateVaule:"begin"===t?r.beginDate:r.endDate,minuteValue:"begin"===t?r.beginMinute:r.endMinute,secondsValue:"begin"===t?r.beginSeconds:r.endSeconds,maxlength:2,type:t})}return i}function p(e,t){t=t||e.getRawValue();var n=t.begin,i=t.end,r=e.dateFormat,a=n?N(n).format(r):"";a=a.split(" ");var o=a[0]||"",s=a[1]?a[1].split(":"):"",l=s[0]||"",u=s[1]||"",d=i?N(i).format(r):"";d=d.split(" ");var c=d[0]||"",f=d[1]?d[1].split(":"):"",h=f[0]||"",p=f[1]||"";return{beginDate:o,beginMinute:l,beginSeconds:u,endDate:c,endMinute:h,endSeconds:p}}function m(e){var t,n=e.calendar,i=e.commit;if(e.time)t=e.time;else t=i?p(n):n.dateTime.newTime;var r=O("."+n.helper.getPartClassName("date"));if(g(r,"Date",t,"html"),i){var a=O("."+n.helper.getPartClassName("minute"));g(a,"Minute",t,"val");var o=O("."+n.helper.getPartClassName("seconds"));g(o,"Seconds",t,"val"),n.dateTime.oldTime=t,n.dateTime.newTime=t}}function g(e,t,n,i){for(var r=0,a=e.length;a>r;r++){var o="begin"===e.eq(r).attr("data-type")?n["begin"+t]:n["end"+t];e.eq(r)[i](o)}}function v(e){var t=e.getChild("endCal"),n=e.helper.getPart("shortcut");if(this.isChecked())e.isEndless=!0,t.disable(),e.view.end=null,e.helper.addPartClasses("shortcut-disabled",n);else e.isEndless=!1,t.enable(),L.apply(e,[t,"end"]),e.helper.removePartClasses("shortcut-disabled",n)}function y(e,t){if(!e&&t||e&&!t)return!1;else if(!e&&!t)return!0;return N(e).isSame(t,"day")}function _(e,t){for(var n=e.shortCutItems,i=n.length,r=0;i>r;r++){var a=n[r],o=a.getValue.call(e);if(y(t.begin,o.begin)&&y(t.end,o.end))return r}return-1}function w(e,t){var n=e,i=e.shortCutItems;if(!(0>t||t>=i.length)){var r=i[t].getValue.call(n),a=r.begin,o=r.end;e.view={begin:a,end:o},x(e,"begin",a),x(e,"end",o),b(n,t)}}function b(e,t){var n=e.shortCutItems,i=e.miniMode;if(null!==i&&i!==t)e.helper.removePartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+i));if(e.miniMode=t,t>=0)e.helper.addPartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+t)),e.curMiniName=n[t].name;else e.curMiniName=null}function x(e,t,n,i){var r=e.getChild(t+"Cal");if(r)if(r.setProperties({rawValue:n,range:e.range}),i===!0)r.on("change",j.bind(L,e,r,t))}function M(e){if(!this.isEndless)for(var t=e.target||e.srcElement,n=this.helper.getPartClasses("shortcut-item"),i=this.helper.getPartClasses("shortcut-item-disabled");t&&t!==document.body;){if(Y.hasClass(t,n[0])&&!Y.hasClass(t,i[0])){var r=t.getAttribute("data-index");return void w(this,r)}t=t.parentNode}}function L(e,t){var n=e.getRawValue();if(n){var i=this.view[t];i.setFullYear(n.getFullYear()),i.setMonth(n.getMonth()),i.setDate(n.getDate());var r=_(this,this.view);b(this,r)}}function T(e){var t=e,n=O("."+e.helper.getPartClassName("date")),i=O("."+e.helper.getPartClassName("minute")),a=O("."+e.helper.getPartClassName("seconds")),o=n.eq(0).html()+" "+i.eq(0).val()+":"+a.eq(0).val(),s=n.eq(1).html()+" "+i.eq(1).val()+":"+a.eq(1).val(),l={};l.begin=r(o,"begin"),l.end=r(s,"end");var u=n.length?l:t.view,d=u.begin,c=u.end;if(e.isEndless)c=null;var f=c-d;if(!c)f=d;var h;if(f>0)h={begin:d,end:c};else if(null!==c)h={begin:c,end:d};var p=t.fire("beforechange",{value:h});if(p.isDefaultPrevented())return!1;else return t.rawValue=h,t.value=t.convertToParam(h),C(t,h),m({calendar:t,commit:!0}),t.layer.hide(),void t.fire("change",h)}function C(e,t){var n=e.helper.getPart("text");n.innerHTML=D(e,t)}function D(e,t){var n=k(e,t);if(e.isEndless&&n)return n;if(!e.curMiniName&&null!==e.miniMode&&e.miniMode>=0&&e.miniMode<e.shortCutItems.length)e.curMiniName=e.shortCutItems[e.miniMode].name;if(n)return n;else return""}function k(e,t){t=t||e.getRawValue();var n=t.begin,i=t.end,r=e.dateFormat,a="";if(n&&i){a=N(n).format(r);var o=N(i).format(r);return a='<em data-type="begin">'+a.split(" ")[0]+"</em>"+("YYYY-MM-DD"===r?"":'<span data-type="begin">'+a.split(" ")[1])+"</span>",o='<em data-type="end">'+o.split(" ")[0]+"</em>"+("YYYY-MM-DD"===r?"":'<span data-type="end">'+o.split(" ")[1])+"</span>",a+" 至 "+o}else if(!i)return a=N(n).format(r),a=a.split(" ")[0]+"<span>"+a.split(" ")[1]+"</span>",a+" 起 ";return""}require("esui/Button"),require("esui/MonthView"),require("esui/CheckBox"),require("esui/Label");var Y=require("esui/lib"),S=require("esui/InputControl"),P=require("esui/controlHelper"),E=require("esui/Layer"),I=require("esui/main"),N=require("moment"),j=require("underscore"),O=require("jquery");return Y.inherits(e,E),e.prototype.render=function(e){function r(e,n){var r,o;if(t(e)){var s=(new Date).getHours();r=s,o=s}else r=23,o=g;if(isNaN(n)||0>n||n>r)n=o;e.val(i(n));var l=e.next();a(l,Number(l.val()))}function a(e,r){var a,o;if(t(e)&&n(e)){var s=(new Date).getMinutes();a=s,o=s}else a=59,o=g;if(isNaN(r)||0>r||r>a)r=o;e.val(i(r))}var o=this.control;document.body.appendChild(e),e.innerHTML=s(o),o.helper.initChildren(e);var l=o.helper.getPart("shortcut");P.addDOMEvent(o,l,"click",M),x(o,"begin",o.view.begin,!0),x(o,"end",o.view.end,!0);var u=_(o,o.view);b(o,u);var d=o.getChild("endlessCheck");if(d)if(d.on("change",Y.curry(v,o)),o.isEndless)d.setChecked(!0),o.helper.addPartClasses("shortcut-disabled",o.helper.getPart(o));var c=o.getChild("okBtn");c.on("click",Y.curry(T,o));var f=o.getChild("cancelBtn");f.on("click",j.bind(o.layer.hide,o.layer));var h=o.getChild("closeBtn");h.on("click",j.bind(o.layer.hide,o.layer));var g="00",y=O("."+o.helper.getPartClassName("date-time"));y.on("blur","input",function(e){var t=e.target.className,n=O(e.target);if(-1!==t.indexOf("minute"))r(n,Number(n.val()));else if(-1!==t.indexOf("seconds"))a(n,Number(n.val()))}),o.dateTime={oldTime:p(o),newTime:p(o)};var w=[o.children[0].children[1].layer,o.children[0].children[2].layer,o.children[1].children[1].layer,o.children[1].children[2].layer];O("#"+o.helper.getId("layer")).on("click",function(e){var t=O(e.target);if(!t.hasClass("ui-monthview-month-item-disabled")){if(t.hasClass("ui-monthview-month-item")){var n;if(t.parents(".ui-rangecalendar-begin").length>0)n="begin";else if(t.parents(".ui-rangecalendar-end").length>0)n="end";var a=t.attr("data-year"),s=i(parseInt(t.attr("data-month"),10)+1),l=i(t.attr("data-date")),u=[a,s,l].join("-");o.dateTime.newTime[n+"Date"]=u,m({calendar:o,commit:!1});var d=t.parents(".ui-monthview").parent().next().find(".ui-rangecalendar-minute");r(d,d.val())}if(!(t.parents(".ui-monthview-year-select").length||t.parents(".ui-monthview-month-select").length||t.hasClass("ui-monthview-year-select")||t.hasClass("ui-monthview-month-select")))for(var c=0,f=w.length;f>c;c++)w[c].hide()}})},e.prototype.toggle=function(e){var t=this.control,n=this.getElement();if(!n||this.control.helper.isPart(n,"layer-hidden")){var i=O("#"+t.helper.getId()).find(".ui-rangecalendar-text"),o=i.find("em"),s=i.find("span"),l=[];o.each(function(e){var t=o.eq(e).html()+" "+s.eq(e).html();l.push(t)});var u={};u.begin=r(l[0],"begin"),u.end=r(l[1],"end"),t.rawValue=u,m({calendar:t,commit:!0}),a(t,t.rawValue),this.show()}else this.hide()},o.prototype.convertToParam=function(e){var t=e.begin,n=e.end,i=[];if(i.push(N(t).format("YYYY-MM-DD")),n)i.push(N(n).format("YYYY-MM-DD"));return i.join(",")},o.prototype.convertToRaw=function(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:N(t[0],"YYYY-MM-DD").toDate(),end:N(t[1],"YYYY-MM-DD").toDate()}},o.defaultProperties={dateFormat:"YYYY/MM/DD",endlessCheck:!1,shortCutItems:[{name:"昨天",value:0,getValue:function(){var e=new Date(this.now.getTime());return e.setDate(e.getDate()-1),{begin:e,end:e}}},{name:"最近7天",value:1,getValue:function(){var e=N(this.now);return{begin:e.clone().subtract("day",7).toDate(),end:e.clone().subtract("day",1).toDate()}}},{name:"上周",value:2,getValue:function(){var e=this.now,t=new Date(e.getTime()),n=new Date(e.getTime()),i=1;if(t.getDay()<i%7)t.setDate(t.getDate()-14+i-t.getDay());else t.setDate(t.getDate()-7-t.getDay()+i%7);return t.setHours(0,0,0,0),n.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()+6),n.setHours(0,0,0,0),{begin:t,end:n}}},{name:"本月",value:3,getValue:function(){return{begin:N(this.now).startOf("month").toDate(),end:N(this.now).toDate()}}},{name:"上个月",value:4,getValue:function(){var e=N(this.now).subtract("month",1).startOf("month").toDate(),t=N(this.now).startOf("month").subtract("day",1).toDate();return{begin:e,end:t}}},{name:"上个季度",value:5,getValue:function(){var e=this.now,t=N(e).subtract("month",e.getMonth()%3+3).startOf("month").toDate(),n=N(e).subtract("month",e.getMonth()%3).startOf("month").subtract("day",1).toDate();return{begin:t,end:n}}}]},o.prototype.type="RangeCalendar",o.prototype.initOptions=function(e){var t=this.now,n={begin:t,end:t},i={range:{begin:new Date(1970,1,1),end:new Date},rawValue:n,view:j.clone(n),value:this.convertToParam(n),shownShortCut:"昨天,最近7天,上周,本月,上个月,上个季度"};if(Y.extend(i,o.defaultProperties),P.extractValueFromInput(this,e),e.value)e.rawValue=this.convertToRaw(e.value),e.view={begin:e.rawValue.begin,end:e.rawValue.end},e.miniMode=null;else if(e.rawValue)e.miniMode=null;else if(!e.rawValue&&null!=e.miniMode){var r=i.shortCutItems[e.miniMode];if(r)e.rawValue=r.getValue.call(this),e.miniMode=parseInt(e.miniMode,10);else e.miniMode=null}if(Y.extend(i,e),i.range&&"string"==typeof i.range)i.range=this.convertToRaw(i.range);if("false"===i.endlessCheck)i.endlessCheck=!1;if(i.endlessCheck){if("false"===i.isEndless)i.isEndless=!1}else if(!i.rawValue.end)i.endlessCheck=!0,i.isEndless=!0;if(i.isEndless)i.endlessCheck=!0,i.rawValue.end=null,i.view.end=null,i.view.value=this.convertToParam({begin:t,end:null});this.setProperties(i)},o.prototype.initStructure=function(){if(Y.isInput(this.main))P.replaceMain(this);var e=['<div class="${className}" id="${id}"></div>','<div class="${arrow}"></div>'];this.main.innerHTML=Y.format(e.join("\n"),{className:this.helper.getPartClassName("text"),id:P.getId(this,"text"),arrow:this.helper.getPartClassName("arrow")})},o.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"mousedown",j.bind(this.layer.toggle,this.layer))},o.prototype.repaint=P.createRepaint(S.prototype.repaint,{name:["rawValue","range"],paint:function(e,t,n){if(n){if("string"==typeof n)n=e.convertToRaw(n);if(!n.begin)n.begin=new Date(1983,8,3);else if(!n.end)n.end=new Date(2046,10,4);e.range=n}if(t)C(e,t);if(e.layer)a(e,t)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,n,i){if(t||n||i)e.layer.hide()}},{name:"isEndless",paint:function(e,t){if(!e.endlessCheck)e.isEndless=!1;else{var n=e.getChild("endlessCheck");if(n)n.setChecked(t)}}}),o.prototype.setRawValue=function(e){this.setProperties({rawValue:e})},o.prototype.getRawValue=function(){return this.rawValue},o.prototype.stringifyValue=function(e){return this.convertToParam(e)||""},o.prototype.parseValue=function(e){return this.convertToRaw(e)},o.prototype.dispose=function(){if(!P.isInStage(this,"DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;S.prototype.dispose.apply(this,arguments)}},Y.inherits(o,S),I.register(o),o});