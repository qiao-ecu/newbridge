define(function(require){function e(){i.apply(this,arguments)}function t(t){o.apply(this,arguments),this.layer=new e(this),this.dataKey=this.dataKey||"key",n.extend(s,t)}var n=require("underscore"),i=require("common/esuix/LayerX"),r=require("esui/main"),a=require("esui/lib"),o=require("esui/InputControl"),s={unit:"项",text:{all:"全部"}};require("common/esuix/MultiSelectList"),e.prototype.render=function(e){var t=this;if(this.multiSelectList)this.multiSelectList.dispose(),this.multiSelectList.main.remove(),delete this.multiSelectList;var n=r.create("MultiSelectList",{childName:n,datasource:this.control.datasource,firstItemTitle:this.control.firstItemTitle});n.appendTo(e),this.multiSelectList=n,this.multiSelectList.on("change",function(){t.control.setValue(n.getValue()),t.control.fire("change")})},e.prototype.initBehavior=function(){},e.prototype.dock={strictWidth:!0,width:!0},a.inherits(e,i),t.prototype.type="MultiSelect",t.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"click",n.bind(this.layer.toggle,this.layer))},t.prototype.getSelectedItems=function(){return n.filter(this.datasource,function(e){return e.selected})},t.prototype.getRawValue=function(){var e=this.getSelectedItems();return n.pluck(e,"value").join(",")},t.prototype.setValues=function(e){var t=this.datasource,n=t.length;e=e.sort();for(var i=0;n>i;i++)t[i].selected=!1;for(var r=0,a=0,o=e.length;o>a;a++)for(var s=r;n>s;s++)if(t[s].value===e[a]){t[s].selected=!0,r=s+1;break}this.repaint()},t.prototype.selectAll=function(){for(var e=this.datasource,t=e?e.length:0;t--;)e[t].selected=!0;this.repaint()};var l=require("esui/painters");t.prototype.repaint=l.createRepaint(o.prototype.repaint,l.style("width"),l.style("height"),{name:"datasource",paint:function(e){e.layer.repaint()}},{name:"rawValue",paint:function(e){var t="",n=e.getSelectedItems(),i=(n[0]||{}).text||"",r=n.length;if(0===r)t+="未选择";else if(1===r)t+=i;else if(r===e.datasource.length)if(s.text.all)t+=s.text.all;else t+=e.totalTitle||"全部";else t+=i+"&nbsp;等"+r+s.unit;e.main.innerHTML=t}},{name:["disabled","hidden","readOnly"],paint:function(e,t,n,i){if(t||n||i)e.layer.hide()}}),t.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;o.prototype.dispose.apply(this,arguments)}},a.inherits(t,o),r.register(t)});