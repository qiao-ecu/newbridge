define(function(require){function e(){r.apply(this,arguments),i.apply(this,arguments),this.datasource=this.datasource||[];var e=t.filter(this.datasource,function(e){return e.selected}),n=t.pluck(e,"value").join(",");this.setValue(n)}var t=require("underscore"),n=require("esui/lib"),i=require("esui/Panel"),r=require("esui/InputControl"),a=(require("common/util/util"),require("jquery"));return e.prototype.type="MultiSelectList",e.prototype.initStructure=function(){for(var e=this.helper.getPartClasses("multi-select-list-container"),t=this.helper.getPartClasses("item-select-all"),n="",i="",r="",a=0,o=this.datasource.length,s=0;o>s;s++){var l=this.datasource[s],t=this.helper.getPartClasses("item-input");if(l.disabled)t.push.apply(t,this.helper.getPartClasses("item-disabled"));if(n+='<li class="multi-select-list-item">',n+="<label>",l.selected)n+='<input type="checkbox" data-index="'+s+'" class="'+t.join(" ")+'" checked>',a++;else n+='<input type="checkbox" data-index="'+s+'" class="'+t.join(" ")+'">';n+="<span>",n+=l.text,n+="</span>",n+="</label>",n+="</li>"}if(o==a)r="checked";i+='<div class="select-all-row">',i+="<label>",i+='<input type="checkbox" class="'+t.join(" ")+' multi-select-select-all"'+r+">",i+="<span>"+(this.firstItemTitle||"全选")+"</span>",i+="</label>",i+="</div>",i+='<ul class="'+e.join(" ")+'">',i+=n,i+="</ul>",this.main.innerHTML=i},e.prototype.initEvents=function(){var e=this;a(".multi-select-list-item input",this.main).click(function(){var n=parseInt(a(this).data("index"),10),i=e.getValue(),r=e.datasource,o=!r[n].selected;r[n].selected=o,a(this).find("input").prop("checked",o);var s=t.filter(r,function(e){return e.selected});if(s.length===r.length)a(".select-all-row input").prop("checked",!0);else a(".select-all-row input").prop("checked",!1);var l=t.pluck(s,"value").join(",");if(e.setValue(l),i!==l)e.fire("change")}),a(".multi-select-select-all",this.main).click(function(){var n=e.getValue(),i=e.datasource,r=a(this).prop("checked"),o="";if(r)t.map(i,function(e){e.selected=!0}),a(".multi-select-list-item input",this.main).prop("checked",!0),o=t.pluck(i,"value").join(","),e.setValue(o);else t.map(i,function(e){e.selected=!1}),a(".multi-select-list-item input",this.main).prop("checked",!1),e.setValue(o);if(n!==o)e.fire("change")})},e.prototype.dock={strictWidth:!0},e.prototype.getSelectedItems=function(){return t.filter(this.datasource,function(e){return e.selected})},n.inherits(e,r),n.inherits(e,i),require("esui/main").register(e),e});