define(function(require,exports,module){function e(){n.apply(this,arguments)}var t=window.require,n=require("ef/UIView"),i=require("er/util"),r=require("jquery"),a=require("underscore"),o=require("im-editor"),s=(t("client-vm")(),require("common/util/globalData")),l=(require("nativeAbility/main"),require("common/util/util")),u=require("common/util/fileManager"),d=t("screencapture"),c=require("common/config");require("tpl!./main.tpl"),require("esui/Button"),require("esui/CommandMenu");var f=require("ef/ActionDialog"),h=null;return e.prototype.template="inputArea",e.prototype.uiProperties={commandMenu:{displayText:"",activeIndex:1,datasource:[{text:"ctrl+enter发送"},{text:"enter发送"}],dock:{strictWidth:!0,direction:{vertical:"up",horizon:"right"}}}},e.prototype.sendMode="enter",e.prototype.isEmpty=function(){return!this.editorInstance.getContent()},e.prototype.send=function(){this.fire("send"),this.hideFontBar(),this.hideFace()},e.prototype.uiEvents={"sendBtn:click":function(){this.send()},"commandMenu:select":function(e){if(0===e.index)this.sendMode="ctrlenter";else if(1===e.index)this.sendMode="enter"}},e.prototype.getContent=function(){return this.editorInstance.getContent()},e.prototype.clear=function(){this.editorInstance.clear()},e.prototype.restoreSettings=function(){var e=this.getContainerElement(),t=s.get("serviceId"),n=this.model.db.query("inputArea",{serviceId:t})[0];if(n){if(this.editorInstance.setStyles({fontFamily:n.fontFamily,fontSize:n.fontSize,fontWeight:n.fontWeight,textDecoration:n.textDecoration,fontStyle:n.fontStyle}),r(".input-area-font-family",e).val(n.fontFamily.replace(/\s/g,"")),r(".input-area-font-size",e).val(n.fontSize),this.editorInstance.isBold())r(".input-area-font-bold").addClass("input-area-font-bold-selected");else r(".input-area-font-bold").removeClass("input-area-font-bold-selected");if(this.editorInstance.isItalic())r(".input-area-font-italic").addClass("input-area-font-italic-selected");else r(".input-area-font-italic").removeClass("input-area-font-italic-selected");if(this.editorInstance.isUnderline())r(".input-area-font-underline").addClass("input-area-font-underline-selected");else r(".input-area-font-underline").removeClass("input-area-font-underline-selected")}},e.prototype.saveSettings=function(){var e=(this.getContainerElement(),s.get("serviceId")),t=this.editorInstance.getStyles();this.model.db.insertOrUpdate("inputArea",{serviceId:e},{serviceId:e,fontFamily:t.fontFamily,fontSize:t.fontSize,fontWeight:t.fontWeight,textDecoration:t.textDecoration,fontStyle:t.fontStyle}),this.model.db.commit()},e.prototype.toggleFontBar=function(){var e=this.getContainerElement();r(".input-area-font",e).toggle()},e.prototype.hideFontBar=function(){var e=this.getContainerElement();r(".input-area-font",e).hide()},e.prototype.showFontBar=function(){var e=this.getContainerElement();r(".input-area-font",e).show()},e.prototype.toggleFace=function(){var e=this.getContainerElement();r(".input-area-face-container",e).toggle()},e.prototype.hideFace=function(){var e=this.getContainerElement();r(".input-area-face-container",e).hide()},e.prototype.showFace=function(){var e=this.getContainerElement();r(".input-area-face-container",e).show()},e.prototype.hideWarning=function(){r(".not-in-chatting-warning").hide()},e.prototype.showWarning=function(){r(".not-in-chatting-warning").show()},e.prototype.toggleHistory=function(){},e.prototype.hideHistory=function(){},e.prototype.showHistory=function(){},e.prototype.preview=function(e){},e.prototype.updatePicStatus=function(e,t){var n=this.getContainerElement(),i=t?1:2,a=r(n).find("[data-bcsname="+e+"]").attr("data-uploaded",i);if(!a.length)this.fire("imageuploaded",{bcsName:e,status:t?0:1})},e.prototype.upload=function(e){var t=this;console.log("正在上传:"+e),u.upload(e).then(function(){console.log("上传成功:"+e),t.updatePicStatus(e,!0)},function(){console.log("上传失败:"+e),t.updatePicStatus(e,!1)})},e.prototype.disable=function(){var e=this.getContainerElement();r(".input-area-toolbar-btn-picture",e).addClass("input-area-toolbar-btn-picture-disabled"),this.get("sendBtn").disable(),this.get("commandMenu").disable(),this.showWarning()},e.prototype.enable=function(){var e=this.getContainerElement();r(".input-area-toolbar-btn-picture",e).removeClass("input-area-toolbar-btn-picture-disabled"),this.get("sendBtn").enable(),this.get("commandMenu").enable(),this.hideWarning()},e.prototype.insertHTML=function(e){this.editorInstance.insert("html",e)},e.prototype.enterDocument=function(){var e=this,t=this.getContainerElement();n.prototype.enterDocument.call(this,arguments);var i=r(".input-area-editor-container",t).get(0);this.editorInstance=o({main:i,styles:{fontSize:"9pt"}}),this.restoreSettings(),this.editorInstance.on("keydown",function(t){if(13===t.keyCode)if(t.stop(),t.ctrlKey&&"ctrlenter"===e.sendMode||!t.ctrlKey&&"enter"===e.sendMode)e.send();else e.editorInstance.insert("br")}),this.editorInstance.on("screenshotpaste",function(t){var n=l.uuid(),i=u.getFilePathByBcsName(n);u.saveBlob(n,t.blob,function(){e.editorInstance.insert("img","../../"+i,{"data-uploaded":0,"data-bcsName":n,id:n}),e.upload(n)})});var s=this.model.get("content")||[],p=s.shift()||{},m=p.content||"";this.editorInstance.setContent(m),r(".input-area-toolbar-btn-font",t).on("click",function(){e.hideFace(),e.toggleFontBar()}),r(".input-area-font-family",t).on("change",function(){e.editorInstance.setStyles({fontFamily:r(this).val()})}),r(".input-area-font-size",t).on("change",function(){e.editorInstance.setStyles({fontSize:r(this).val()})}),r(".input-area-font-bold",t).on("click",function(){var t="";if(e.editorInstance.isBold())r(this).removeClass("input-area-font-bold-selected"),t="normal";else r(this).addClass("input-area-font-bold-selected"),t="bold";e.editorInstance.setStyles({fontWeight:t})}),this.editorInstance.on("ctrlB",function(){if(e.editorInstance.isBold())r(".input-area-font-bold",t).addClass("input-area-font-bold-selected");else r(".input-area-font-bold",t).removeClass("input-area-font-bold-selected")}),r(".input-area-font-italic",t).on("click",function(){var t="";if(e.editorInstance.isItalic())r(this).removeClass("input-area-font-italic-selected"),t="normal";else r(this).addClass("input-area-font-italic-selected"),t="italic";e.editorInstance.setStyles({fontStyle:t})}),this.editorInstance.on("ctrlI",function(){if(e.editorInstance.isItalic())r(".input-area-font-italic",t).addClass("input-area-font-italic-selected");else r(".input-area-font-italic",t).removeClass("input-area-font-italic-selected")}),r(".input-area-font-underline",t).on("click",function(){var t="";if(e.editorInstance.isUnderline())r(this).removeClass("input-area-font-underline-selected"),t="none";else r(this).addClass("input-area-font-underline-selected"),t="underline";e.editorInstance.setStyles({textDecoration:t})}),this.editorInstance.on("ctrlU",function(){if(e.editorInstance.isUnderline())r(".input-area-font-underline",t).addClass("input-area-font-underline-selected");else r(".input-area-font-underline",t).removeClass("input-area-font-underline-selected")}),r(".input-area-toolbar-btn-face",t).on("click",function(){e.hideFontBar(),e.toggleFace()}),r(".input-area-toolbar-btn-history",t).on("click",function(){e.hideFontBar(),e.hideFace(),e.toggleHistory()}),r(".input-area-toolbar-btn-quick-reply",t).on("click",function(){r(this);if(!h)h=new f({id:"quickReply",title:"常用语",closeOnHide:!1,skin:"quick-reply",width:200,height:400,top:20,right:20,mask:!1,needFoot:!1,draggable:!0,url:"/quickReply"}),document.body.appendChild(h.main);h.show()}),r(".input-area-toolbar-btn-picture",t).on("click",function(){var t=r(this).hasClass("input-area-toolbar-btn-picture-disabled");if(!t)u.selectFile({filter:[".png",".jpg",".jpeg",".bmp"]}).then(function(t){a.map(t,function(t){console.log("选择文件: "+t);var n=l.uuid(),i='<img data-bcsname="'+n+'" data-uploaded="0"/>';e.fire("sendImageMessage",{content:i}),u.cacheFile(t,n).then(function(t){e.upload(t)})})})}),r(".input-area-toolbar-btn-screencapture",t).on("click",function(){var t=l.uuid(),n=u.getFilePathByBcsName(t,u.WRITABLE);d(n,function(n,i){if(!n)e.editorInstance.insert("img","../../"+i,{"data-uploaded":0,"data-bcsName":t,id:t}),e.upload(t)})}),r(".input-area-face-item",t).on("click",function(){var n=r(this),i=n.attr("face"),a=n.attr("extension"),o=n.attr("alt");console.log("选择了表情: "+o+" faceId: "+i+" extension: "+a),e.editorInstance.insert("face",i,{faceText:o,urlPrefix:c.faceUrl,extension:a}),r(".input-area-face-container",t).hide()}),r(".input-area-editor-container",t).on("click","img[data-bcsname]",function(){var t=r(this).attr("data-bcsname");console.log("您点击了图片:"+t),e.preview(t)});var g=this.model.get("displayNotChattingWarning");if(g)this.disable();else this.enable();if(!this.model.get("visitorId"))this.get("sendBtn").disable(),this.get("commandMenu").disable(),r(".input-area-toolbar-btn-picture").addClass("input-area-toolbar-btn-picture-disabled")},i.inherits(e,n),e});