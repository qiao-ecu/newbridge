define(function(require){function e(e,t){this.modelType=e,this.viewType=t,n.apply(this,arguments)}var t=(window.require,require("er/util")),n=require("er/Action"),i=require("underscore"),r=requireNode("client-vm")(),a=require("jquery"),o=require("common/util/globalData");return e.prototype.hide=function(){},e.prototype.show=function(){},e.prototype.login=function(){var e=a.Deferred(),t=this.view,n=this.model,i=n.db,s=t.get("username").getValue(),l=t.get("password").getValue(),u=t.get("captcha").getValue(),d=t.get("status").get("selectedIndex"),c=t.get("remenber").isChecked(),f=t.get("autologin").isChecked(),h=i.queryAll("loginUserInfo",{query:{username:s}});if(h.length)var p=h[0].eid;var m=requireNode(process.cwd()+"/package.json");return r.init(s,l,{captcha:u,config:m.clientVmConfig,status:d,eid:p}).then(function(t){if(console.log(t),o.set("serviceId",t.id),o.set("username",s),o.set("token",t.token),o.set("domain",t.domain),document.title="百度商桥 ("+s+")",!c)l="";i.insertOrUpdate("loginUserInfo",{username:s},{username:s,password:l,serviceid:t.id,status:d,remenber:c,autologin:f,eid:t.eid,logintime:+new Date}),i.commit(),e.resolve()},function(n){var i=require("common/config").loginErrorCode.needCaptcha;if(n.code===i){var r=n.source||{},a="http://"+r.captchaHost+"/chkcode/gen?userName="+s;t.showCaptcha(a)}e.reject(n)}),e.promise()},e.prototype.recoverLoginState=function(){var e=this.view.get("loginbtn");e.removeState("cancelable"),e.removeState("logining"),e.setContent("登录"),e.setDisabled(!1)},e.prototype.cancelLogin=function(){clearTimeout(this.cancelLoginPtr),clearTimeout(this.recoveryPtr),this.recoverLoginState()},e.prototype.delayLogin=function(e){e=e||2e3;var t=a.Deferred(),n=this,i=n.view,r=i.get("loginbtn");return r.setContent("点击取消登陆"),r.addState("cancelable"),n.recoveryPtr=setTimeout(function(){n.recoverLoginState()},1e4),n.cancelLoginPtr=setTimeout(function(){r.removeState("cancelable"),r.addState("logining"),r.setDisabled(!0),n.login().then(function(e){n.hide(),setTimeout(function(){n.show()},3e3),n.fire("redirect","/workBench"),clearTimeout(n.recoveryPtr),t.resolve(e)},function(e){i.showLoginValidity(e.reason),clearTimeout(n.recoveryPtr),n.recoverLoginState(),t.reject(e)})},e),t.promise()},e.prototype.initBehavior=function(){var e=this,t=e.view,n=e.model,a=n.get("userInfo");t.on("match",function(e){var t=i.findWhere(a,{username:e.data});if(t.remenber){var n=this.get("password");n.setValue(t.password)}this.get("status").set("selectedIndex",t.status),this.get("remenber").setChecked(t.remenber),this.get("autologin").setChecked(t.autologin)}),t.on("unmatch",function(){var e=this.get("password");e.setValue("")}),t.on("delete",function(e){var t=e.username,a=n.db,o=a.queryAll("loginUserInfo",{query:{username:t}});if(o.length){var s=o[0].serviceid;r.action("vm:system","user","localcache","delete",s)}a.deleteRows("loginUserInfo",{username:t}),a.commit();var o=a.queryAll("loginUserInfo"),l=i.map(o,function(e){return{text:e.username}});this.get("username").set("datasource",l)}),t.on("login",function(t){e.delayLogin()}),t.on("cancellogin",function(){e.cancelLogin()});var a=n.get("userInfo");if(a.length){var o=a[0];if(t.get("username").setValue(o.username),o.autologin)e.delayLogin()}},t.inherits(e,n),e});