define(function(require){function e(){for(var e=arguments.length,t=0,o=n(),r=[],i=0;e>i;i++){var a=arguments[i];!function(n){a.then(function(i){if(t++,r[n]=i,t===e)o.resolve.apply(o,r)},function(){o.reject()})}(i)}return o.promise()}var n=function(){function e(){for(var e=this,n=0;n<r.length;n++)!function(n){if(a&&a[0]&&a[0].then)a[0].then(function(){r[n].apply(e,arguments)});else setTimeout(function(){r[n].apply(e,a)},0)}(n)}function t(){for(var e=this,n=0;n<i.length;n++)!function(n){setTimeout(function(){i[n].apply(e,a)},0)}(n)}function o(e,t){var o=n();if(s===u.resolved){var l=this;setTimeout(function(){e.apply(l,a)},0)}else if(s===u.reject){var l=this;setTimeout(function(){t.call(l,f)},0)}else{if(e)r.push(function(){o.resolve(e.apply(l,arguments))});if(t)i.push(function(e){t(e),o.reject()})}return o.promise()}if(!this instanceof n)return new n;var r=[],i=[],a=[],f="",u={pendding:1,resolved:2,rejected:3},s=u.pendding,l={resolve:function(){var n=Array.prototype.slice.call(arguments,0);if(s===u.pendding)a=n,s=u.resolved,e.call(this)},reject:function(e){if(s===u.pendding)f=e,s=u.rejected,t.call(this)},then:o,promise:function(){return{then:o}}};return l};return{Deferred:n,when:e}});