define(function(require){function e(e,t){function n(n){if(t.dump)e.fill(n,c);else e.set(t.name,n,c);return{success:!0,name:t.name,options:t,value:n}}function r(e){return{success:!1,name:t.name,options:t,error:e}}try{var i=t.retrieve(e,t);if(f.isPromise(i)){if("function"==typeof i.abort)e.addPendingWorker(i);return i.then(n,function(t){t=r(t);try{var i=e.handleError(t);return n(i)}catch(o){if(console.log(o),o.success===!1)throw o;else throw r(o)}})}else{var o=n(i);return f.resolved(o)}}catch(s){console.log(s);var a=r(s);return f.rejected(a)}}function t(e,t){for(var n=f.resolved(),i=0;i<t.length;i++){var o=t[i],s=u.bind(r,null,e,o);n=n.then(s)}return n}function n(e,t){var n=[];for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];if("function"==typeof o)o={retrieve:o,name:i};else if("function"==typeof o.retrieve)o=u.mix({name:i},o);n.push(r(e,o))}return f.all(n)}function r(r,i){if(!i)return f.resolved();if("function"==typeof i){var o={retrieve:i,dump:!0};return e(r,o)}if(i instanceof Array)return t(r,i);if("function"==typeof i.retrieve)return e(r,i);else return n(r,i)}function i(e){if(this.store={},this.pendingWorkers=[],e)this.fill(e,c);this.initialize()}function o(e,t){for(var n=0;n<e.pendingWorkers.length;n++)if(e.pendingWorkers[n]===t)return void e.pendingWorkers.splice(n,1)}function s(){function e(e){var t={success:!1,name:"$prepare",options:{},error:e};throw t}try{var t=this.prepare();if(f.isPromise(t))return t.fail(e);else return t}catch(n){console.log(n),e(n)}}function a(e,t,n){var r=e.store.hasOwnProperty(t)?"change":"add",i=e.store[t];if(e.store[t]=n,i!==n)return{type:r,name:t,oldValue:i,newValue:n};else return null}var u=require("./util"),f=require("./Deferred"),c={silent:!0},l=require("mini-event/EventTarget");return i.prototype.initialize=u.noop,i.prototype.addPendingWorker=function(e){this.pendingWorkers.push(e),e.ensure(u.bind(o,null,this,e))},i.prototype.datasource=null,i.prototype.getDatasource=function(){return this.datasource},i.prototype.load=function(){try{var e=this.getDatasource(),t=r(this,e);return t.then(u.bind(s,this))}catch(n){return console.log(n),f.rejected(n)}},i.prototype.prepare=u.noop,i.prototype.get=function(e){return this.store[e]},i.prototype.set=function(e,t,n){n=n||{};var r=a(this,e,t);if(r&&!n.silent){var i={changes:[r]};this.fire("change",i)}return t},i.prototype.fill=function(e,t){t=t||{};var n=[];for(var r in e)if(e.hasOwnProperty(r)){var i=a(this,r,e[r]);if(i)n.push(i)}if(n.length&&!t.silent){var o={changes:n};this.fire("change",o)}return e},i.prototype.remove=function(e,t){if(this.store.hasOwnProperty(e)){t=t||{};var n=this.store[e];if(delete this.store[e],!t.silent){var r={changes:[{type:"remove",name:e,oldValue:n,newValue:void 0}]};this.fire("change",r)}return n}},i.prototype.getAsModel=function(e){var t=this.get(e);if(!t||"[object Object]"!=={}.toString.call(t))return new i;else return new i(t)},i.prototype.dump=function(){return u.mix({},this.store)},i.prototype.has=function(e){return this.store.hasOwnProperty(e)},i.prototype.hasValue=function(e){return this.has(e)&&null!=this.store[e]},i.prototype.hasReadableValue=function(e){return this.hasValue(e)&&""!==this.store[e]},i.prototype.valueOf=function(){return this.dump()},i.prototype.clone=function(){return new i(this.store)},i.prototype.handleError=function(e){throw e},i.prototype.dispose=function(){for(var e=0;e<this.pendingWorkers.length;e++){var t=this.pendingWorkers[e];if("function"==typeof t.abort)try{t.abort()}catch(n){console.log(n)}}this.pendingWorkers=null},u.inherits(i,l),i});