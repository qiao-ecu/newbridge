define(function(require){function e(e,t){for(var n=e?encodeURIComponent(e):"",r=[],i=0;i<t.length;i++){var o=t[i];r[i]=this.serializeData("",o)}return n?n+"="+r.join(","):r.join(",")}function t(e,t){if(1===arguments.length)t=e,e="";if(null==t)t="";var n=this.serializeData.getKey,r=e?encodeURIComponent(e):"",i=Object.prototype.toString.call(t);switch(i){case"[object Array]":return this.serializeArray(e,t);case"[object Object]":var o=[];for(var s in t){var a=n(s,e),u=this.serializeData(a,t[s]);o.push(u)}return o.join("&");default:return r?r+"="+encodeURIComponent(t):encodeURIComponent(t)}}function n(){this.hooks={serializeData:t,serializeArray:e},this.config={cache:!1,timeout:0,charset:""}}var r=require("./util"),i="_";t.getKey=function(e,t){return t?t+"."+e:e},r.inherits(n,require("mini-event/EventTarget")),n.prototype.request=function(e){if("function"==typeof this.hooks.beforeExecute)this.hooks.beforeExecute(e);var t=require("./assert");t.hasProperty(e,"url","url property is required");var n={method:"POST",data:{},cache:this.config.cache,timeout:this.config.timeout,charset:this.config.charset},r=require("./util");e=r.mix(n,e);var o=require("./Deferred"),s=new o;if("function"==typeof this.hooks.beforeCreate){var a=this.hooks.beforeCreate(e,s);if(a===!0){var u=s.promise;return u.abort=function(){},u.setRequestHeader=function(){},u}}var f=window.XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");r.mix(f,e.xhrFields);var u=s.promise,c={abort:function(){f.onreadystatechange=null;try{f.abort()}catch(e){console.log(e)}if(!u.status)u.status=0;u.readyState=f.readyState,u.responseText="",u.responseXML="",s.reject(u)},setRequestHeader:function(e,t){f.setRequestHeader(e,t)},getAllResponseHeaders:function(){return f.getAllResponseHeaders()},getResponseHeader:function(e){return f.getResponseHeader(e)},getRequestOption:function(t){return e[t]}};r.mix(u,c);var l={xhr:u,options:e};u.then(r.bind(this.fire,this,"done",l),r.bind(this.fire,this,"fail",l));var p=function(){if(4===f.readyState){var t=u.status||f.status;if(1223===t)t=204;if(u.status=u.status||t,u.readyState=f.readyState,u.responseText=f.responseText,u.responseXML=f.responseXML,"function"==typeof this.hooks.afterReceive)this.hooks.afterReceive(u,e);if(0!==t&&(200>t||t>=300&&304!==t))return void s.reject(u);var n=f.responseText;if("json"===e.dataType)try{n=r.parseJSON(n)}catch(i){return console.log(i),u.error=i,void s.reject(u)}if("function"==typeof this.hooks.afterParse)try{n=this.hooks.afterParse(n,u,e)}catch(i){return console.log(i),u.error=i,void s.reject(u)}s.resolve(n)}};f.onreadystatechange=r.bind(p,this);var h=e.method.toUpperCase(),d={};if("GET"===h)r.mix(d,e.data);if(e.cache===!1)d[i]=+new Date;var v=this.hooks.serializeData("",d,"application/x-www-form-urlencoded"),m=e.url;if(v){var g=m.indexOf("?")>=0?"&":"?";m+=g+v}if(f.open(h,m,!0),"function"==typeof this.hooks.beforeSend)this.hooks.beforeSend(u,e);if("GET"===h)f.send();else{var y=e.contentType||"application/x-www-form-urlencoded",v=this.hooks.serializeData("",e.data,y,u);if(e.charset)y+=";charset="+e.charset;f.setRequestHeader("Content-Type",y),f.send(v)}if(e.timeout>0){var w=function(){this.fire("timeout",{xhr:u,options:e}),u.status=408,u.abort()},b=setTimeout(r.bind(w,this),e.timeout);u.ensure(function(){clearTimeout(b)})}return u},n.prototype.get=function(e,t,n){var r={method:"GET",url:e,data:t,cache:n||this.config.cache};return this.request(r)},n.prototype.getJSON=function(e,t,n){var r={method:"GET",url:e,data:t,dataType:"json",cache:n||this.config.cache};return this.request(r)},n.prototype.post=function(e,t,n){var r={method:"POST",url:e,data:t,dataType:n||"json"};return this.request(r)},n.prototype.log=function(e,t){var n=new Image,r=window.ER_LOG_POOL||(window.ER_LOG_POOL={}),i=+new Date;r[i]=n,n.onload=n.onerror=n.onabort=function(){n.onload=n.onerror=n.onabort=null,r[i]=null,n=null};var o=this.hooks.serializeData("",t,"application/x-www-form-urlencoded");if(o){var s=e.indexOf("?")>=0?":":"?";e+=s+o}n.src=e};var o=new n;return o.Ajax=n,o});