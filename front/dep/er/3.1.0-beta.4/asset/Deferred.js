define(function(require){function e(e){function t(){for(var t=0;t<n.length;t++){var r=n[t];try{r.apply(e.promise,e._args)}catch(i){console.log(i)}}}if("pending"!==e.state){var n="resolved"===e.state?e._doneCallbacks.slice():e._failCallbacks.slice();if(e.syncModeEnabled)t();else o(t);e._doneCallbacks=[],e._failCallbacks=[]}}function t(e,t,r,i){return function(){if("function"==typeof r){var o=t.resolver;try{var s=r.apply(e.promise,arguments);if(n.isPromise(s))s.then(o.resolve,o.reject);else o.resolve(s)}catch(a){console.log(a),n.fire("exception",{deferred:e,args:[a],reason:a}),o.reject(a)}}else t[i].apply(t,e._args)}}function n(){this.state="pending",this._args=null,this._doneCallbacks=[],this._failCallbacks=[],this.promise={done:r.bind(this.done,this),fail:r.bind(this.fail,this),ensure:r.bind(this.ensure,this),then:r.bind(this.then,this)},this.promise.promise=this.promise,this.resolver={resolve:r.bind(this.resolve,this),reject:r.bind(this.reject,this)}}var r=require("./util"),i=require("./assert"),o="function"==typeof window.setImmediate?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)};return require("mini-event/EventTarget").enable(n),n.isPromise=function(e){return e&&"function"==typeof e.then},n.prototype.syncModeEnabled=!1,n.prototype.resolve=function(){if("pending"===this.state)this.state="resolved",this._args=[].slice.call(arguments),n.fire("resolve",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},n.prototype.reject=function(){if("pending"===this.state)this.state="rejected",this._args=[].slice.call(arguments),n.fire("reject",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},n.prototype.done=function(e){return this.then(e)},n.prototype.fail=function(e){return this.then(null,e)},n.prototype.ensure=function(e){return this.then(e,e)},n.prototype.then=function(r,i){var o=new n;return o.syncModeEnabled=this.syncModeEnabled,this._doneCallbacks.push(t(this,o,r,"resolve")),this._failCallbacks.push(t(this,o,i,"reject")),e(this),o.promise},n.all=function(){function e(e){s--,i.greaterThanOrEquals(s,0,"workingCount should be positive");var t=[].slice.call(arguments,1);if(t.length<=1)t=t[0];if(u[e]=t,0===s)c[a].apply(c,u)}function t(){a="reject",e.apply(this,arguments)}var o=[].concat.apply([],arguments),s=o.length;if(!s)return n.resolved();for(var a="resolve",u=[],c=new n,f=0;f<o.length;f++){var l=o[f];l.then(r.bind(e,l,f),r.bind(t,l,f))}return c.promise},n.resolved=function(){var e=new n;return e.resolve.apply(e,arguments),e.promise},n.rejected=function(){var e=new n;return e.reject.apply(e,arguments),e.promise},n.when=function(e){if(n.isPromise(e))return e;var t=new n;return t.syncModeEnabled=!0,t.resolve(e),t.promise},n.require=function(e){var t=new n;return window.require(e,t.resolver.resolve),t.promise.abort=t.resolver.reject,t.promise},n});