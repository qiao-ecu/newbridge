define(function(require){function e(){this.actionPathMapping={},this.childActionMapping={},this.currentURL=null,this.currentAction=null,this.globalActionLoader=null,this.childActionLoaders={}}function t(e,t,n){var r=e.childActionMapping[t.id];if(r){if(e.childActionMapping[t.id]=void 0,r.hijack)if(t.removeEventListener)t.removeEventListener("click",r.hijack,!1);else t.detachEvent("onclick",r.hijack);if(r.action){if(!n)n={url:null,referrer:r.url,container:t.id,isChildAction:!0};if(e.getEventBus().fire("leaveaction",{controller:e,action:r.action,to:n}),"function"==typeof r.action.leave)r.action.leave()}}}function n(e,n,r,i,o){if(t(e,n,o),n.addEventListener)n.addEventListener("click",i,!1);else n.attachEvent("onclick",i);var s={url:o.url,container:n.id,action:r,hijack:i};e.childActionMapping[n.id]=s;var a=require("mini-event/EventTarget");if(r instanceof a)r.on("leave",function(){t(e,n)})}var r=require("./Deferred"),i=require("./URL"),o=require("./config"),s=require("./util"),a=require("./assert");s.inherits(e,require("mini-event/EventTarget")),e.prototype.registerAction=function(e){if(!e.hasOwnProperty("length"))e=[e];for(var t=0;t<e.length;t++){var n=e[t];a.hasProperty(n,"path",'action config should contains a "path" property'),this.actionPathMapping[n.path]=n}},e.prototype.getDefaultTitle=function(){return this.defaultTitle},e.prototype.setDefaultTitle=function(e){this.defaultTitle=e},e.prototype.getRouter=function(){return this.router},e.prototype.setRouter=function(e){this.router=e},e.prototype.getLocator=function(){return this.locator},e.prototype.setLocator=function(e){this.locator=e},e.prototype.getEventBus=function(){return this.eventBus},e.prototype.setEventBus=function(e){this.eventBus=e},e.prototype.getPermissionProvider=function(){return this.permissionProvider},e.prototype.setPermissionProvider=function(e){this.permissionProvider=e},e.prototype.getMainContainer=function(){return this.mainContainer||o.mainElement},e.prototype.setMainContainer=function(e){this.mainContainer=e},e.prototype.getNoAuthorityLocation=function(){return this.noAuthorityLocation||o.noAuthorityLocation},e.prototype.setNoAuthorityLocation=function(e){this.noAuthorityLocation=e},e.prototype.getNotFoundLocation=function(){return this.notFoundLocation||o.notFoundLocation},e.prototype.setNotFoundLocation=function(e){this.notFoundLocation=e},e.prototype.start=function(){if(!this.getDefaultTitle())this.setDefaultTitle(o.systemName||document.title);this.getRouter().setBackup(s.bind(this.renderAction,this))},e.prototype.findActionConfig=function(e){var t=e.url.getPath(),n=this.actionPathMapping[t];return n},e.prototype.resolveActionConfig=function(e,t){return e},e.prototype.checkAuthority=function(e,t){var n=e.authority;if(!n)return!0;var r=this.getPermissionProvider();if("function"==typeof n)return n(t,e,r);if("string"==typeof n)n=n.split("|");for(var i=0;i<n.length;i++)if(r.isAllow(s.trim(n[i])))return!0;return!1},e.prototype.findEligibleActionConfig=function(e){var t=this.findActionConfig(e);if(t&&t.movedTo)return this.getEventBus().fire("actionmoved",{controller:this,url:e.url,config:t,movedTo:t.movedTo}),e.originalURL=e.url,e.url=i.parse(t.movedTo),this.findEligibleActionConfig(e);if(t&&t.childActionOnly&&!e.isChildAction)t=null;if(!t)if(this.getEventBus().fire("actionnotfound",s.mix({controller:this,failType:"NotFound",reason:"Not found"},e)),e.originalURL=e.url,e.url=i.parse(this.getNotFoundLocation()),!this.actionPathMapping[e.url.getPath()])return null;else return this.findEligibleActionConfig(e);var n=this.checkAuthority(t,e);if(!n){this.getEventBus().fire("permissiondenied",s.mix({controller:this,failType:"PermissionDenied",reason:"Permission denied",config:t},e));var r=t.noAuthorityLocation||this.getNoAuthorityLocation();return e.originalURL=e.url,e.url=i.parse(r),this.findEligibleActionConfig(e)}return t},e.prototype.loadAction=function(e){var t=this.findEligibleActionConfig(e);if(t=this.resolveActionConfig(t,e),!t){var n=new r;return n.syncModeEnabled=!1,n.reject("no action configured for url "+e.url.getPath()),n.promise}if(e.title=t.title,e.args.title=t.title,t.args)for(var i in t.args)if(t.args.hasOwnProperty(i)){if(!e.args.hasOwnProperty(i))e.args[i]=t.args[i];if(!e.hasOwnProperty(i))e[i]=t.args[i]}var o=new r;o.syncModeEnabled=!1;var a=o.promise,u=!1,c=function(){if(!u)u=!0,this.getEventBus().fire("actionabort",s.mix({controller:this},e))};if(a.abort=s.bind(c,this),!e.isChildAction)this.currentURL=e.url;var f=function(n){if(!u){if(!n){var i="No action implement for "+t.type,a=s.mix({controller:this,failType:"NoModule",config:t,reason:i},e);return this.getEventBus().fire("actionfail",a),this.getEventBus().notifyError(a),void o.reject(i)}if(this.getEventBus().fire("actionloaded",{controller:this,url:e.url,config:t,action:n}),"function"==typeof n)o.resolve(new n,e);else if("function"==typeof n.createRuntimeAction){var c=function(n){if(!n){var r="Action factory returns non-action",i=s.mix({controller:this,failType:"InvalidFactory",config:t,reason:r,action:n},e);this.getEventBus().fire("actionfail",i),this.getEventBus().notifyError(i),o.reject(r)}else o.resolve(n,e)};c=s.bind(c,this);var f=n.createRuntimeAction(e);r.when(f).then(c)}else o.resolve(n,e)}};if(f=s.bind(f,this),"string"==typeof t.type)window.esl([t.type],f);else f(t.type);return a},e.prototype.enterAction=function(e,t){if(!t.isChildAction){if(t.url!==this.currentURL)return;if(this.currentAction)if(this.getEventBus().fire("leaveaction",{controller:this,action:this.currentAction,to:s.mix({},t)}),"function"==typeof this.currentAction.leave)this.currentAction.leave();this.currentAction=e,document.title=t.title||t.documentTitle||this.getDefaultTitle()}this.getEventBus().fire("enteraction",s.mix({controller:this,action:e},t));var n=function(){this.getEventBus().fire("enteractioncomplete",s.mix({controller:this,action:e},t))};n=s.bind(n,this);var r=function(e){var n="";if(!e)n="Invoke action.enter() causes error";else if(e.message){if(n=e.message,e.stack)n+="\n"+e.stack}else if(window.JSON&&"function"==typeof JSON.stringify)try{n=JSON.stringify(e)}catch(r){n=e}else n=e;var i=s.mix({failType:"EnterFail",reason:n},t);this.getEventBus().fire("enteractionfail",i),this.getEventBus().notifyError(i)};r=s.bind(r,this);var i=e.enter(t);return i.then(n,r),i},e.prototype.forward=function(e,t,n,r){var i={url:e,container:t,isChildAction:!!r};if(r){var o=this.childActionMapping[t];i.referrer=o?o.url:null}else i.referrer=this.currentURL;s.mix(i,n),i.args=s.mix({},i),s.mix(i.args,e.getQuery()),this.getEventBus().fire("forwardaction",s.mix({controller:this},i));var u=this.loadAction(i);return a.has(u,"loadAction should always return a Promise"),u},e.prototype.renderAction=function(e){if("string"==typeof e)e=i.parse(e);if(this.globalActionLoader&&"function"==typeof this.globalActionLoader.abort)this.globalActionLoader.abort();if(this.currentAction&&"function"==typeof this.currentAction.filterRedirect&&this.currentAction.filterRedirect(e)===!1)return r.rejected("Redirect aborted by previous action");this.globalActionLoader=this.forward(e,this.getMainContainer(),null,!1);var t=this.getEventBus();return this.globalActionLoader.then(s.bind(this.enterAction,this)).fail(s.bind(t.notifyError,t))},e.prototype.enterChildAction=function(e,r){function i(e,n,i){n=n||{};var e=c.resolveURL(e,n);if(n.global){var o=document.getElementById(r.container),s=c.redirect(e,n);if(s&&o)t(f,o);return s}var a=f.childActionMapping[r.container],u=e.toString()!==a.url.toString(),l=u||n.force;if(l)if(n.silent)a.url=e;else f.renderChildAction(e,a.container,i);return l}function o(e){if(e.isChildActionRedirected)return!0;for(var t=e.target||e.srcElement;t&&(!t.id||!f.childActionMapping[t.id]);)t=t.parentNode;if(t.id!==r.container)return e.isChildActionRedirected=!0,!0;else return!1}function a(e){e=e||window.event;var t=e.target||e.srcElement;if("a"===t.nodeName.toLowerCase()){var n=t.getAttribute("href",2)||"";if("#"===n.charAt(0))if(!o(e)){if(e.preventDefault)e.preventDefault();else e.returnValue=!1;for(var r=n.substring(1),a=(t.getAttribute("data-redirect")||"").split(/[,\s]/),u={},c=0;c<a.length;c++){var f=s.trim(a[c]);u[f]=!0}i(r,u)}}}this.childActionLoaders[r.container]=null;var u=document.getElementById(r.container);if(u){var c=this.getLocator(),f=this;return e.redirect=i,e.reload=function(e){this.redirect(r.url,{force:!0},e)},e.back=function(e,t){var n=this.context&&this.context.referrer,r=n||e;this.redirect(r,null,t)},n(this,u,e,a,r),this.enterAction(e,r)}},e.prototype.renderChildAction=function(e,t,n){if(a.has(t),"string"==typeof e)e=i.parse(e);var o=this.childActionLoaders[t];if(o&&"function"==typeof o.abort)o.abort();var u=this.childActionMapping[t],c=u&&u.action;if(c&&"function"==typeof c.filterRedirect&&c.filterRedirect(e)===!1)return r.rejected("Redirect aborted by previous action");var f=this.forward(e,t,n,!0),l=this.getEventBus(),p=f.then(s.bind(this.enterChildAction,this)).fail(s.bind(l.notifyError,l));return p.abort=f.abort,this.childActionLoaders[t]=p,p};var u=new e;return u.setLocator(require("./locator")),u.setRouter(require("./router")),u.setEventBus(require("./events")),u.setPermissionProvider(require("./permission")),u.Controller=e,u});