define(function(require){function e(e,i){if(ne=e,J=i.rowIndex,Z=i.columnIndex,!Q)Q=A.layer.create(),document.body.appendChild(Q),Q.className=e.helper.getPartClassName("editor"),t();Q.style.zIndex=e.zIndex||"",n(i)}function t(){a(),i()}function i(){var e=L.init(Q);te=o(e,W),ie=o(e,z),te.on("click",c()),ie.on("click",g()),b(1)}function n(e){if(e.field&&re!==e.field){ee&&ee.dispose(),ee=null;var t=F+ae++,i=q+ae,n=V.g(j),r=V.g(_);n.innerHTML=V.format(X,{inputId:t}),r.innerHTML=V.format(G,{validId:i});var a={properties:{}};a.properties[t]=V.extend({id:t,width:145,height:20,validityLabel:q+ae},e.field.editRules),ee=L.init(n,a)[0],L.init(r),ee.on("enter",c()),re=e.field}}function r(e){if(e==ne){s(),ee.dispose(),te.dispose(),ie.dispose();try{Q&&document.body.removeChild(Q)}catch(t){}Q=null,ee=null,te=null,ie=null,ne=null,re=null}}function a(){Q.innerHTML=V.format(B,{inputFieldId:j,okId:W,cancelId:z,okText:Y,cancelText:U,optClass:ne.helper.getPartClassName("editor-opt"),errorClass:ne.helper.getPartClassName("editor-error"),errorId:_})}function o(e,t){for(var i=e.length-1;i>=0;i--){var n=e[i];if(n.id===t)return n}}function s(e){Q&&(Q.style.display="none")}function l(e){Q&&(Q.style.display="")}function d(e){if(e){var t=new H;t.addState("TableEditCustomRule",new $(!1,e)),ee.showValidity(t)}}function u(e){var t=new H;t.addState("TableEditCustomRule",new $(!0)),ee.showValidity(t)}function c(){return function(){h()}}function h(){if(ee.validate()){var e={value:P(),rowIndex:J,columnIndex:Z,field:ne.realFields[Z]};if(e=ne.fire("saveedit",e),D(ne,"saveedit",e),!e.isDefaultPrevented())f.call(ne,e);else p.call(ne,e)}}function f(e){if(this===ne)s(),K=0}function p(e){if(this===ne&&e.errorMsg)d(e.errorMsg)}function g(){return function(){x()}}function v(){if(this==ne)y(this)}function m(){if(this==ne)y(this)}function y(e){if(Q){var t=V.g(e.getBodyCellId(J,Z));if(t)A.layer.attachTo(Q,t)}}function x(){K=0,s(),b(1);var e={rowIndex:J,columnIndex:Z,field:ne.realFields[Z]};e=ne.fire("canceledit",e),D(ne,"canceledit",e)}function w(t,i){if(K&&ne)x();K=1,e(t,i),b(0),l();var n=V.g(t.getBodyCellId(i.rowIndex,i.columnIndex));A.layer.attachTo(Q,n),C(i.value),u()}function b(e){te.setDisabled(e),ie.setDisabled(e)}function C(e){ee.setValue(e)}function P(){return ee.getValue()}function I(e,t){var i=this;if(i.startEdit){var n=V.getAttribute(e,"data-row"),r=V.getAttribute(e,"data-col");i.startEdit(n,r,e)}}function T(e,t,i){if(this.editable){var n=this.realFields[t],r={rowIndex:e,columnIndex:t,field:n};if(r=this.fire("startedit",r),D(this,"startedit",r),!r.isDefaultPrevented()){var a=this.datasource[e],o=n.editContent,s="function"==typeof o?o.call(this,a,e,t):a[n.field];w(this,{field:n,rowIndex:e,columnIndex:t,element:i,value:s})}}}function E(){if(this==ne)x()}function S(){if(this===ne)s()}function M(){if(this===ne)l()}function N(e,t,i,n,r,a){if(e.editable&&i.editable)return{textClass:e.getClass("cell-editable"),html:V.format(oe,{className:e.getClass("cell-editentry"),row:n,col:r})};else return void 0}function D(e,t,i){var n=i.field["on"+t];if(n&&"[object Function]"==Object.prototype.toString.call(n))n.call(e,i)}function O(){k.apply(this,arguments)}require("../validator/MaxLengthRule"),require("../validator/MaxRule"),require("../validator/MinRule"),require("../validator/RequiredRule"),require("../validator/PatternRule");var k=require("../Extension"),V=require("../lib"),A=require("../controlHelper"),L=require("../main"),R=require("../Table"),$=require("../validator/ValidityState"),H=require("../validator/Validity"),B=['<div class="${optClass}">','<div id="${inputFieldId}"></div>','<div data-ui="id:${okId};type:Button;">${okText}</div>','<div data-ui="id:${cancelId};type:Button;">',"${cancelText}","</div>","</div>",'<div class="${errorClass}" id="${errorId}"></div>'].join(""),j="ctrl-table-editor-inputField",F="ctrl-table-editorInput",q="ctrl-table-editor-validityLabel",W="ctrl-table-editor-ok",z="ctrl-table-editor-cancel",_="ctrl-table-editor-error",Y="确定",U="取消",X='<input data-ui="type:TextBox;id:${inputId}"/>',G='<label data-ui="type:Validity;id:${validId}"></label>',J=-1,Z=-1,K=0,Q=null,ee=null,te=null,ie=null,ne=null,re=null,ae=1,oe='<div class="${className}" data-row="${row}" data-col="${col}"></div>';return O.prototype.type="TableEdit",O.prototype.activate=function(){var e=this.target;if(e instanceof R)e.startEdit=T,e.cancelEdit=E,e.hideEditLayer=S,e.showEditError=M,e.addRowBuilders([{index:3,getColHtml:N}]),e.addHandlers("click",{handler:I,matchFn:A.getPartClasses(e,"cell-editentry")[0]}),e.on("enddrag",v),e.on("resize",m),k.prototype.activate.apply(this,arguments)},O.prototype.inactivate=function(){var e=this.target;if(e instanceof R)delete e.startEdit,delete e.cancelEdit,e.un("enddrag",v),e.un("resize",m),r(e),k.prototype.inactivate.apply(this,arguments)},V.inherits(O,k),L.registerExtension(O),O});