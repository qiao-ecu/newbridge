define(function(require){function e(){s.apply(this,arguments)}function t(e){for(var t=e.target,i=t;i&&"li"!==i.nodeName.toLowerCase();)i=i.parentNode;if(i&&"li"===i.nodeName.toLowerCase())for(var n=i.parentNode,r=o.getChildren(n),a=0;a<r.length;a++)if(r[a]===i){if(this.helper.isPart(t,"close"))this.removeAt(a);else this.set("activeIndex",a);return}}function i(e,t,i,n){var r=document.createElement("li");if(e.helper.addPartClasses("item",r),i)e.helper.addPartClasses("item-active",r);return r.innerHTML=e.getContentHTML(t,n),r}function n(e){var t=e.helper.getPart("navigator"),n=t.parentNode,r=t.nextSibling;t.innerHTML="",t.parentNode.removeChild(t);for(var a=0;a<e.tabs.length;a++){var o=e.tabs[a],s=e.activeIndex===a,l=i(e,o,s,e.allowClose);t.appendChild(l)}n.insertBefore(t,r)}function r(e,t){for(var i=0;i<e.tabs.length;i++){var n=e.tabs[i];if(n.panel){var r=o.g(n.panel);if(r)r.style.display=i===t?"":"none"}var a=e.helper.getPart("navigator"),s=o.getChildren(a),l=s[i],u=i===t?"addPartClasses":"removePartClasses";e.helper[u]("item-active",l)}var d={activeIndex:t,tab:e.tabs[t]};e.fire("activate",d)}var a=require("underscore"),o=require("./lib"),s=require("./Control");return e.prototype.type="Tab",e.prototype.initOptions=function(e){var t={tabs:[],activeIndex:0,allowClose:!1,orientation:"horizontal"};a.extend(t,e),t.activeIndex=t.activeIndex||0;var i=o.getChildren(this.main);if(i.length){for(var n=[],r=0;r<i.length;r++){var s=i[r];if("navigator"===s.getAttribute("data-role")){t.tabs=[],this.navigatorElement=s;for(var i=o.getChildren(s),r=0;r<i.length;r++){var l=i[r],u={title:o.getText(l),panel:l.getAttribute("data-for")};t.tabs.push(u)}break}else{var u={title:s.getAttribute("title"),panel:s.id};n.push(u)}}if(!t.tabs.length)t.tabs=n}if("string"==typeof t.activeIndex)t.activeIndex=+t.activeIndex;this.setProperties(t)},e.prototype.initStructure=function(){var e=this.navigatorElement;if(this.navigatorElement=null,!e)e=document.createElement("ul"),this.main.insertBefore(e,this.main.firstChild||null);e.id=this.helper.getId("navigator"),this.helper.addPartClasses("navigator",e)},e.prototype.initEvents=function(){this.helper.addDOMEvent("navigator","click",t)},e.prototype.contentTemplate="<span>${title}</span>",e.prototype.getContentHTML=function(e,t){var i=o.format(this.contentTemplate,{title:a.escape(e.title)});if(t)i+='<span class="'+this.helper.getPartClassName("close")+'">关闭</span>';return i},e.prototype.setProperties=function(e){if(e.tabs){if(null==e.activeIndex){for(var t=this.tabs[this.activeIndex],i=-1,n=0;n<e.tabs.length;n++)if(e.tabs[n]===t){i=n;break}if(-1===i)this.activeIndex=-1,e.activeIndex=0;else this.activeIndex=i}if(null!=e.allowClose)this.allowClose=e.allowClose,delete e.allowClose}s.prototype.setProperties.apply(this,arguments)},e.prototype.repaint=require("./painters").createRepaint(s.prototype.repaint,{name:["tabs","allowClose"],paint:n},{name:"activeIndex",paint:r},{name:"orientation",paint:function(e,t){e.removeState("vertical"),e.removeState("horizontal"),e.addState(t)}}),e.prototype.activate=function(e){for(var t=0;t<this.tabs.length;t++)if(this.tabs[t]===e)this.set("activeIndex",t)},e.prototype.add=function(e){this.insert(e,this.tabs.length)},e.prototype.insert=function(e,t){t=Math.min(t,this.tabs.length),t=Math.max(t,0),this.tabs.splice(t,0,e);var n=i(this,e,!1,this.allowClose),a=this.helper.getPart("navigator"),s=o.getChildren(a);if(a.insertBefore(n,s[t]||null),1===this.tabs.length)this.activeIndex=0,r(this,0);else{if(t<=this.activeIndex)this.activeIndex++;if(e.panel){var l=o.g(e.panel);if(l)l.style.display="none"}}this.fire("add",{tab:e,index:t})},e.prototype.remove=function(e){for(var t=0;(t=a.indexOf(this.tabs,e,t))>=0;)this.removeAt(t)},e.prototype.removeAt=function(e){var t=this.tabs.splice(e,1)[0],i=this.helper.getPart("navigator");if(t){var n=o.getChildren(i),a=n[e];if(a.parentNode.removeChild(a),e<this.activeIndex)this.activeIndex--;else if(e===this.activeIndex)this.activeIndex=Math.min(this.activeIndex,this.tabs.length-1),r(this,this.activeIndex);if(t.panel){var s=o.g(t.panel);if(s)s.style.display="none"}this.fire("remove",{tab:t,index:e})}},e.prototype.getActiveTab=function(){return this.get("tabs")[this.get("activeIndex")]},o.inherits(e,s),require("./main").register(e),e});