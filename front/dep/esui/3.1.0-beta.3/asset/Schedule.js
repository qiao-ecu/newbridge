define(function(require){function e(e){$.apply(this,arguments)}function t(){function e(e){for(var t=[],i=0;7>i&&i<e.length;i++){t[i]=[];for(var n=0;24>n;n++)t[i][n]=e[i]}return t}return[{text:"全周投放",tip:"周一到周日全天投放",getValue:function(){return e([1,1,1,1,1,1,1])}},{text:"周一到周五投放",tip:"周一到周五全天投放",getValue:function(){return e([1,1,1,1,1,0,0])}},{text:"周末投放",tip:"周六、周日全天投放",getValue:function(){return e([0,0,0,0,0,1,1])}}]}function i(){for(var e=[],t=0;7>t;t++){var i=[];e.push(i);for(var n=0;24>n;n++)i.push(0)}return e}function n(e,t){return R.getPartClasses(e,t).join(" ")}function r(e,t){return R.getId(e,t)}function a(e){var t=e,i=[],r='<span class="${clazz}" data-item="${index}" >${text}</span>',a=n(t,"shortcut-text-item");i.push('<span class="'+a+'">快速设定：</span>');for(var o=t.shortcut,s=n(t,"shortcut-item"),l=0,u=o.length;u>l;l++){var d=o[l];i.push(A.format(r,{clazz:s,text:d.text,index:l}))}return i.join("")}function o(e){A.g(r(e,"body")).innerHTML=""+s(e)+l(e)+u(e)}function s(e){var t=e,i=[],a=n(t,"time-line"),o=r("body-head");i.push('<div class="',a,'" id="',o+'">');for(var s=n(t,"time-head"),l=0;24>=l;l+=2)i.push('<div class="',s,'" data-time="',l,'" ','id="',r(t,"time-head"+l),'">',l+":00","</div>");return i.push("</div>"),i.join("")}function l(e){var t=e,i=[],a=n(t,"day-head"),o=r(t,"day-head");i.push('<div id="',o,'" class="',a,'">');for(var s=n(t,"day"),l='<div class="'+s+'"><input type="checkbox" id="${dayId}" value="${value}">&nbsp;<label for="${dayId}">${dayWord}</label></div>',u=t.dayTexts,d=0;7>d;d++)i.push(A.format(l,{dayWord:u[d],dayId:r(t,"line-state"+d),value:d}));return i.push("</div>"),i.join("")}function u(e){var t=e,i=[],a='<div class="${timeClass}" id="${itemId}" data-day="${dayIndex}" data-time-item="1" data-time="${timeIndex}"></div>',o=n(t,"time-body"),s=r(t,"time-body");i.push('<div id="',s,'" class="',o,'">');for(var l=n(t,"line"),u=0;7>u;u++){var d=r(t,"line"+u);i.push('<div class="',l,'" id="',d,'">');for(var c=0;24>c;c++){var h=r(t,"time_"+u+"_"+c);i.push(A.format(a,{itemId:h,timeClass:n(t,"time"),dayIndex:u,timeIndex:c}))}i.push("</div>")}return i.push("</div>"),i.join("")}function d(e,t){for(var i=e,n=R.getPartClasses(i,"time-selected"),a=R.getPartClasses(i,"time-hover"),o=0;7>o;o++){var s=[],l=A.g(r(i,"line"+o));f(e,l);for(var u=0;24>u;u++){var d=A.g(r(i,"time_"+o+"_"+u)),h=t[o][u];if(h)A.addClasses(d,n);else A.removeClasses(d,n);A.removeClasses(d,a),s.push(h)}c(i,s,l,o)}}function c(e,t,i,a){var o=e,s=a,l=A.g(r(o,"line-state"+s));l.checked=!1;for(var u,d=/1{3,}/g,c=t.join(""),f=n(o,"continue-covertimes"),p='<div class="${coverClass}"><strong>${text}</strong></div>';null!=(u=d.exec(c));){var g=u[0].length,v=u.index,m=v+g,y=document.createElement("aside"),x=";width:"+25*g+"px;top:0;left:"+25*v+"px;";l.checked=24==g?!0:!1,y.setAttribute("data-start-time",v),y.setAttribute("data-end-time",m),y.setAttribute("data-day",s),y.className=f,y.style.cssText+=x,y.innerHTML=A.format(p,{start:v,end:m,text:24==g?"全天投放":v+".00-"+m+".00",coverClass:n(o,"covertimes-tip")}),i.appendChild(y),R.addDOMEvent(o,y,"mouseover",A.curry(h,y))}}function h(e){e.style.display="none"}function f(e,t){for(var i=t.getElementsByTagName("aside"),n=i.length;n;){var r=i[0];if(null!=r.getAttribute("data-day"))R.clearDOMEvents(e,r),t.removeChild(r);n--}}function p(e,t,i,a){var o=e;t=t||r(o,"tip");var s=A.g(t);if(s)s.style.top=i.y+"px",s.style.left=i.x+"px",s.innerHTML=a;else{var l=";position:absolute;z-index:50;background:#fff6bd;top:"+i.y+"px;left:"+i.x+"px;display:none;",u=n(o,"shortcut-item-tip");s=document.createElement("div"),s.style.cssText=l,s.id=t,s.className=u,s.innerHTML=a,document.body.appendChild(s),o.followTip[t]=s}return o.tipElementTime=setTimeout(function(){s.style.display="block"},100),s}function g(e,t){clearTimeout(e.tipElementTime);var i=A.g(t);i&&(i.style.display="none")}function v(e){var t=A.event.getTarget(e);if("input"==t.nodeName.toLowerCase()){for(var i=this,n=t,r=parseInt(n.value,10),a=n.checked,o=k(i.rawValue),s=o[r],l=0,u=s.length;u>l;l++)s[l]=a?1:0;i.setRawValue(o)}}function m(e){var t=A.event.getTarget(e);if(t&&A.hasAttribute(t,"data-item")){var i=t.getAttribute("data-item"),n=this.shortcut[i].getValue;"function"==typeof n&&n.call(this);var r;if("function"==typeof n)r=n.call(this);else r=n;this.setRawValue(r)}}function y(e){var t=A.event.getTarget(e);if(t&&t.getAttribute("data-item")){var i=t,n=this;A.event.getMousePosition(e);var a={};a.y=e.pageY+20,a.x=e.pageX+10;var o=i,s=o.getAttribute("data-item"),l=r(n,"shortcut-item")+s;setTimeout(function(){var e=A.g(l);if(e)e.style.top=a.y+"px",e.style.left=a.x+"px"},0)}}function x(e,t){var i=A.event.getTarget(t);if(i&&i.getAttribute("data-item")){var n=i;A.event.getMousePosition(t);var a={};a.y=t.pageY+20,a.x=t.pageX+10;var o=this,s=n,l=s.getAttribute("data-item"),u=r(o,"shortcut-item")+l,d=R.getPartClasses(o,"shortcut-item-hover");if(e){A.addClasses(s,d);var c=o.shortcut[l].tip;p(o,u,a,c)}else A.removeClasses(s,d),g(o,u)}}function w(e){var t=A.event.getTarget(e);if(t&&t.getAttribute("data-time-item")){var i=t;A.addClasses(i,R.getPartClasses(this,"time-hover")),A.event.getMousePosition(e);var a={};a.y=e.pageY+20,a.x=e.pageX+10;var o=this,s=parseInt(i.getAttribute("data-time"),10),l=parseInt(i.getAttribute("data-day"),10),u=A.format(j,{time:"<strong>"+s+":00</strong>&nbsp;—&nbsp;<strong>"+(s+1)+":00</strong>",text:"点击/拖动鼠标选择",timeId:r(o,"timeitem-tip-head"),textId:r(o,"timeitem-tip-body"),timeClass:n(o,"timeitem-tip-head"),textClass:n(o,"timeitem-tip-body")}),d=r(o,"timeitem-tip");p(o,d,a,u);for(var c=A.g(r(o,"time-body")),h=c.getElementsByTagName("aside"),f=0,g=h.length;g>f;f++){var v=h[f],m=parseInt(v.getAttribute("data-start-time"),10),y=parseInt(v.getAttribute("data-end-time"),10),x=parseInt(v.getAttribute("data-day"),10);if(s>=m&&y>s&&l==x)v.style.display="none";else v.style.display="block"}}}function b(e){var t=A.event.getTarget(e);if(t&&t.getAttribute("data-time-item"))A.removeClasses(t,R.getPartClasses(this,"time-hover")),g(this,r(this,"timeitem-tip"))}function C(e){var t=this,i=document;L=A.bind(P,t),B=A.bind(E,t),A.on(i,"mousemove",L),A.on(i,"mouseup",B),A.event.getMousePosition(e),this.dragStartPos={x:e.pageX,y:e.pageY};var n=A.g(r(t,"time-body"));t.dragRange=[];var a=A.getOffset(n).top,o=A.getOffset(n).left;t.dragRange.push(a),t.dragRange.push(o+n.offsetWidth),t.dragRange.push(a+n.offsetHeight),t.dragRange.push(o),V(n);var s=S(this,{x:e.pageX,y:e.pageY}),l=r(t,"timeitem-tip");A.g(l)&&(A.g(l).style.display="none"),T(this,s)}function P(e){A.event.getMousePosition(e);var t=S(this,{x:e.pageX,y:e.pageY});T(this,t)}function E(e){var t=this;M(A.g(r(t,"time-body")));var i=A.g(r(t,"follow-item"));i.style.display="none",A.event.getMousePosition(e);var n=S(t,{x:e.pageX,y:e.pageY});setTimeout(function(){I(t,n)},10);var a=document;A.un(a,"mousemove",L),A.un(a,"mouseup",B)}function I(e,t){for(var i=e,n=t.startcell,r=t.endcell,a=Math.min(n.x,r.x),o=Math.min(n.y,r.y),s=Math.max(n.x,r.x),l=Math.max(n.y,r.y),u=k(i.rawValue),d=o;l>=d;d++)for(var c=a;s>=c;c++)if(u[d][c])u[d][c]=0;else u[d][c]=1;i.setRawValue(u)}function S(e,t){var i=e,n=i.dragRange,r=i.dragStartPos,a={};if(t.x<=n[1]&&t.x>=n[3])a.x=t.x;else a.x=t.x-r.x<0?n[3]:n[1];if(t.y<=n[2]&&t.y>=n[0])a.y=t.y;else a.y=t.y-r.y<0?n[0]:n[2];var o={startcell:{},endcell:{}};if(o.startcell.x=Math.floor((r.x-i.dragRange[3])/25),o.startcell.y=Math.floor((r.y-i.dragRange[0])/25),o.endcell.x=Math.floor((a.x-i.dragRange[3])/25),o.endcell.y=Math.floor((a.y-i.dragRange[0])/25),o.endcell.x>=23)o.endcell.x=23;if(o.endcell.y>=6)o.endcell.y=6;return o}function T(e,t){var i=e,a=r(e,"follow-item"),o=A.g(a);if(!o)o=document.createElement("div"),o.className=n(i,"follow-item"),o.id=a,A.g(r(i,"time-body")).appendChild(o);var s,l,u,d,c=t.startcell,h=t.endcell,f=c.x,p=c.y,g=h.x,v=h.y;if(v>=p)s=25*p,u=25*(v-p+1)-2;else s=25*v,u=25*(p-v+1)-2;if(g>=f)l=25*f,d=25*(g-f+1)-2;else l=25*g,d=25*(f-g+1)-2;var m=";display:block;;width:"+d+"px;height:"+u+"px;top:"+s+"px;left:"+l+"px;background:#faffbe";o.style.cssText+=m}function V(e){var t=document;if(A.on(t,"selectstart",D),e.setCapture)e.setCapture();else if(window.captureEvents)window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP);if(document.selection)document.selection.empty&&document.selection.empty();else if(window.getSelection)window.getSelection().removeAllRanges()}function M(e){var t=document;if(e.releaseCapture)e.releaseCapture();else if(window.releaseEvents)window.releaseEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP);A.un(t,"selectstart",D)}function D(e){A.event.preventDefault(e)}function k(e){for(var t=[],i=0,n=e.length;n>i;i++)t.push([].slice.call(e[i],0));return t}function O(e,t,i){for(var n=A.g(r(e,"day-head")),a=n.getElementsByTagName("input"),o=0,s=a.length;s>o;o++)a[o][t]=i}function N(e,t,i){for(var n=k(e.rawValue),r=0,a=i.length;a>r;r++){var o=i[r];if(null!=n[o[0]]&&null!=n[o[0]][o[1]])n[o[0]][o[1]]=t?1:0}e.setRawValue(n)}var A=require("./lib"),$=require("./InputControl"),R=require("./controlHelper");e.defaultProperties={helpSelectedText:"投放时间段",helpText:"暂停时间段",dayTexts:["星期一","星期二","星期三","星期四","星期五","星期六","星期日"],shortcut:t()};var L,B,j='<div id="${timeId}" class="${timeClass}">${time}</div><div id="${textId}" class="${textClass}">${text}</div>';return e.prototype={constructor:e,type:"Schedule",createMain:function(e){if(!e.tagName)return $.prototype.createMain.call(this);else return document.createElement(e.tagName)},initOptions:function(t){var n={};if(A.extend(n,e.defaultProperties,t),this.setProperties(n),null==this.rawValue)this.setRawValue(i());this.followTip={}},initStructure:function(){var e=this;this.main.tabIndex=0;var t='<input type="hidden" name="${name}" id="${inputId}"/><div class="${bodyClass}" id="${bodyId}"></div><div class="${headClass}"><div class="${helpClass}"><div class="${helpSelectedClass}"></div><div class="${helpTextClass}">${helpSelected}</div><div class="${helpUnselectedClass}"></div><div class="${helpTextClass}">${help}</div></div><div class="${shortcutClass}" id="${shortcutId}">${shortcutHtml}</div></div>';this.main.innerHTML=A.format(t,{name:this.name,inputId:r(e,"value-input"),headClass:n(e,"head"),bodyClass:n(e,"body"),helpClass:n(e,"help"),helpSelectedClass:n(e,"help-selected"),helpUnselectedClass:n(e,"help-unselected"),helpTextClass:n(e,"help-text"),shortcutClass:n(e,"shortcut"),shortcutId:r(e,"shortcut"),bodyId:r(e,"body"),helpSelected:e.helpSelectedText,help:e.helpText,shortcutHtml:a(e)}),o(e)},initEvents:function(){var e=A.g(r(this,"time-body"));this.helper.addDOMEvent(e,"mousedown",C),this.helper.addDOMEvent(e,"mouseover",w),this.helper.addDOMEvent(e,"mouseout",b),this.helper.addDOMEvent(A.g(r(this,"day-head")),"click",v);var t=this.helper.getPart("shortcut");this.helper.addDOMEvent(t,"click",m),this.helper.addDOMEvent(t,"mouseover",A.curry(x,!0)),this.helper.addDOMEvent(t,"mouseout",A.curry(x,!1)),this.helper.addDOMEvent(t,"mousemove",y)},setProperties:function(e){var t=$.prototype.setProperties.call(this,e),i=t.rawValue;if(i&&this.stringifyValue(i.oldValue)!==this.stringifyValue(i.newValue))this.fire("change",{rawValue:this.rawValue})},repaint:R.createRepaint($.prototype.repaint,{name:"rawValue",paint:function(e,t){var i=e.stringifyValue(t);A.g(r(e,"value-input")).value=null==i?"":i,d(e,t)}},{name:"disabled",paint:function(e,t){O(e,"disabled",t)}},{name:"readonly",paint:function(e,t){O(e,"readonly",t)}}),parseValue:function(e){for(var t=[],i=24,n=0,r=e.length;r>n;n+=i){for(var a=e.substring(n,n+i).split(""),o=[],s=0;s<a.length;s++)o.push(a[s]-0);t.push(o)}return t},stringifyValue:function(e){var t=[];if(!e)return null;for(var i=0,n=e.length;n>i;i++)t.push(e[i].join(""));return t.join("")},setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},select:function(e){N(this,1,[].slice.call(arguments))},unselect:function(e){N(this,0,[].slice.call(arguments))},dispose:function(){R.beforeDispose(this);var e=this.followTip;for(var t in e)if(e[t])document.body.removeChild(e[t]);R.dispose(this),R.afterDispose(this)}},A.inherits(e,$),require("./main").register(e),e});