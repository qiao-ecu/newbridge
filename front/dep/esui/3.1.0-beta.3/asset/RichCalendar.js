define(function(require){function e(e){C.apply(this,arguments)}function t(e){for(var t=e.displayNum,n='<div id="${id}" class="${className}">${monthView}</div>',r=[],a=0;t>a;a++)r.push(w.format(n,{id:b.getId(e,"month-"+a),className:b.getPartClasses(e,"month-container"),monthView:i(e,a)}));return r.join("")}function i(e,t){var i='<div data-ui-type="MonthView" data-ui-child-name="${calName}" data-ui-mode="multi"></div>';return w.format(i,{calName:"monthView"+t})}function n(e){var t=e.layer;t.style.zIndex=b.layer.getZIndex(e.main),b.layer.attachTo(t,e.main,{top:"bottom",left:"left",spaceDetection:"both"}),b.removePartClasses(e,"layer-hidden",e.layer),e.addState("active")}function r(e){if(e.layer)b.addPartClasses(e,"layer-hidden",e.layer),e.removeState("active")}function a(e){for(var t=e.target||e.srcElement;t&&t!=document.body;){if(t==this.layer)return;var i=this.getChild("modifyBtn").main;if(t==i)return;t=t.parentNode}r(this)}function o(e){var i=e.layer;if(!i)i=b.layer.create("div"),b.addPartClasses(e,"layer",i),i.innerHTML=t(e),e.layer=i,r(e),document.body.appendChild(i),e.initChildren(i);u(e,!0),n(e)}function s(e,t){for(var i=this.getRawValue(),n=e.displayNum,r=0;n>r;r++)if(r!==t){var a=e.getChild("monthView"+r);a.setRawValueWithoutFireChange(i)}e.rawValue=i,c(e,i)}function l(e,t){for(var i=e.displayNum,n=new Date(this.year,this.month,1),r=0;i>r;r++)if(r!==t){var a=e.getChild("monthView"+r);a.un("changemonth"),a.un("changeyear");var o,s=t-r;if(s>0)o=E(n).subtract("month",s);else o=E(n).add("month",-s);a.setProperties({month:o.month()+1,year:o.year()}),a.on("changeyear",w.curry(l,e,r)),a.on("changemonth",w.curry(l,e,r))}}function u(e,t){for(var i=e.displayNum,n=e.startMonth,r=e.startYear,a=0;i>a;a++){var o,s,l,u=e.range.begin,c=e.range.end,h=u.getFullYear(),f=u.getMonth(),p=c.getFullYear(),g=c.getMonth();if(0===a)s=new Date(p,g-i+2,0),o={begin:e.range.begin,end:s};else if(a==i-1)l=new Date(h,f+i-1,1),o={begin:l,end:e.range.end};else l=new Date(h,f+a,1),s=new Date(p,g-i-a+2,0),o={begin:l,end:s};var v={year:r,month:n+a,rawValue:e.rawValue,range:e.range,viewRange:o};d(e,v,a,t)}}function d(e,t,i,n){var r=e.getChild("monthView"+i);if(r.setProperties(t),n===!0)r.on("change",w.curry(s,e,i)),r.on("changeyear",w.curry(l,e,i)),r.on("changemonth",w.curry(l,e,i))}function c(e,t){var i=b.getId(e,"param-value");w.g(i).value=e.stringifyValue(t);var n=e.getChild("textInput"),r=m(e,t);n.setProperties({rawValue:r}),h(e,t),e.fire("change")}function h(e,t){var i=w.g(b.getId(e,"total-num"));i.innerHTML=t.length}function f(e){e.set("rawValue",[])}function p(e){if(!e.disabled)if(!e.layer)o(e);else{var t=e.layer,i=b.getPartClasses(e,"layer-hidden");if(w.hasClass(t,i[0]))o(e);else r(e)}}function g(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:v(t[0]),end:v(t[1])}}function v(e){function t(e){var t=e.split("-");if(t)return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10));else return null}if(!e)return null;e+="";var i=e.split(" "),n=t(i[0]);if(i[1]){var r=i[1].split(":");n.setHours(r[0]),n.setMinutes(r[1]),n.setSeconds(r[2])}return n}function m(e,t){for(var i=[],n=[],r=0,a=864e5,o=0;o<t.length;o++)if(0===o)i.push(w.date.format(t[o],e.paramFormat)),n.push(t[o]),r++;else if(t[o]-t[o-1]>a){if(t[o-1]-n[r-1]!==0)i.push("至"),i.push(w.date.format(t[o-1],e.paramFormat)),n.push(t[o-1]),r++;i.push("\n"),i.push(w.date.format(t[o],e.paramFormat)),n.push(t[o]),r++}else if(o==t.length-1)i.push("至"),i.push(w.date.format(t[o],e.paramFormat));else continue;return i.join("")}function y(e){for(var t=this.getValue(),i=t.replace(/\n{2,}/g,"\n").split("\n"),n=[],r={},a=!1,o=0,s=i.length;s>o;o++){var l=w.trim(i[o]);if(0!==l.length&&!r[l]){r[l]=1;var u=l.split("至"),d=u[0],c=d;if(u.length>1)c=u[1];if(x(d)&&x(c))n.push(d),n.push(c);else a=!0}else;}var h=n.join(",");e.rawValue=e.parseValue(h),this.setProperties({rawValue:m(e,e.rawValue)}),e.fire("change")}function x(e){var t=/^(\d{4})(-)(\d{2})\2(\d{2})$/,i=e.match(t);if(null==i)return!1;var n=new Date(i[1],i[3]-1,i[4]),r=""+n.getFullYear()+i[2]+(n.getMonth()+1)+i[2]+n.getDate();return e=i[1]+i[2]+(i[3]-1+1)+i[2]+(i[4]-1+1),r==e}require("./Button"),require("./MonthView"),require("./TextBox");var w=require("./lib"),b=require("./controlHelper"),C=require("./InputControl"),P=require("./main"),E=require("moment");return e.prototype={type:"RichCalendar",initOptions:function(e){var t=new Date,i={now:t,range:{begin:new Date(1983,8,3),end:new Date(2046,10,4)},paramFormat:"YYYY-MM-DD",rawValue:[],displayNum:2,startYear:t.getFullYear(),startMonth:t.getMonth()+1};if(b.extractValueFromInput(this,e),e.range&&"string"==typeof e.range)e.range=g(e.range);w.extend(i,e),this.setProperties(i)},setProperties:function(e){if(null==e.rawValue||0===e.rawValue.length)if(e.value)e.rawValue=this.parseValue(e.value);if(e.rawValue&&e.rawValue.length){var t=e.rawValue[0];e.startYear=t.getFullYear(),e.startMonth=t.getMonth()+1}var i=C.prototype.setProperties.apply(this,arguments);return i},initStructure:function(){if(w.isInput(this.main))b.replaceMain(this);var e=['<div class="${className}" id="${id}">','<textarea data-ui-type="TextBox"',' data-ui-mode="textarea"',' data-ui-height="100"',' data-ui-child-name="textInput"></textarea>','<div data-ui-type="Panel" class="${generalPanelClass}"',' data-ui-child-name="generalPanel">','共<span id="${totalNumId}" ','class="${totalNumClass}"></span>天,','<span data-ui-type="Button" data-ui-skin="link"',' data-ui-child-name="deleteBtn">全部删除</span>',"</div>",'<div data-ui-type="Button" data-ui-skin="calendar"',' data-ui-child-name="modifyBtn">修改时间</div>',"</div>",'<input type="hidden" id="${inputId}" name="${name}"',' value="" />'],t=b.getPartClasses;this.main.innerHTML=w.format(e.join("\n"),{className:t(this,"text").join(" "),id:b.getId(this,"text"),name:this.name,inputId:b.getId(this,"param-value"),generalPanelClass:t(this,"general-info").join(" "),totalNumId:b.getId(this,"total-num"),totalNumClass:t(this,"total-num").join(" ")}),this.initChildren(this.main)},initEvents:function(){var e=this.getChild("modifyBtn");e.on("click",w.curry(p,this));var t=this.getChild("generalPanel").getChild("deleteBtn");t.on("click",w.curry(f,this));var i=this.getChild("textInput");i.on("blur",w.curry(y,this)),b.addDOMEvent(this,document,"mousedown",a)},repaint:b.createRepaint(C.prototype.repaint,{name:["rawValue","range"],paint:function(e,t,i){if(i){if("string"==typeof i)i=g(i);if(!i.begin)i.begin=new Date(1983,8,3);else if(!i.end)i.end=new Date(2046,10,4);e.range=i}if(t)c(e,t);if(e.layer)u(e)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)r(e)}}),setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},stringifyValue:function(e){for(var t=[],i=864e5,n=0;n<e.length;n++){if(0===n)t.push(w.date.format(e[n],this.paramFormat));else if(e[n]-e[n-1]>i)t.push(w.date.format(e[n-1],this.paramFormat)),t.push(w.date.format(e[n],this.paramFormat));if(n===e.length-1)t.push(w.date.format(e[n],this.paramFormat))}return t.join(",")},getRanges:function(){for(var e=this.rawValue,t=this.stringifyValue(e).split(","),i=[],n=0;n<t.length-1;n+=2){var r=v(t[n]),a=v(t[n+1]);i.push({begin:r,end:a})}return i},setRanges:function(e){for(var t={},i=0;i<e.length;i++){var n,r=e[i].begin,a=e[i].end;if(r&&a)if(r-a===0)t[r]=r;else for(n=r;a>=n;)t[n]=n,n=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1);else;}var o=[];for(var s in t)o.push(t[s]);o.sort(function(e,t){return e-t}),this.set("rawValue",o)},parseValue:function(e){for(var t=e.split(","),i={},n=0;n<t.length-1;n+=2){var r,a=v(t[n]),o=v(t[n+1]);if(a&&o)if(a-o===0)i[a]=a;else for(r=a;o>=r;)i[r]=r,r=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1);else;}var s=[];for(var l in i)s.push(i[l]);return s.sort(function(e,t){return e-t}),s},dispose:function(){if(!b.isInStage(this,"DISPOSED")){var e=this.layer;if(e)e.parentNode.removeChild(e),this.layer=null;C.prototype.dispose.apply(this,arguments)}}},w.inherits(e,C),P.register(e),e});