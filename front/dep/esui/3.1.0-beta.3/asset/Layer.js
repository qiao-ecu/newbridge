define(function(require){function e(e){this.control=e}function t(e){var t=e.target,n=this.getElement(this),i=this.control.main;if(n){for(;t&&t!==n&&t!==i;)t=t.parentNode;if(t!==n&&t!==i)this.hide()}}function n(e){var t=e.control.helper.getPartClasses("layer-hidden");return t.unshift(a.getConfig("uiClassPrefix")+"-layer-hidden"),t}function i(e,t){var n=o.clone(t||{});if(n.hasOwnProperty("top")&&n.hasOwnProperty("bottom"))n.height=n.bottom-n.top,delete n.bottom;if(n.hasOwnProperty("left")&&n.hasOwnProperty("right"))n.width=n.right-n.left,delete n.right;if(n.hasOwnProperty("top")||n.hasOwnProperty("bottom"))e.style.top="",e.style.bottom="";if(n.hasOwnProperty("left")||n.hasOwnProperty("right"))e.style.left="",e.style.right="";for(var i in n)if(n.hasOwnProperty(i))e.style[i]=n[i]+"px"}var r=require("underscore"),o=require("./lib"),a=require("./main");e.prototype.nodeName="div",e.prototype.create=function(){var e=this.control.helper.createPart("layer",this.nodeName);return o.addClass(e,a.getConfig("uiClassPrefix")+"-layer"),e},e.prototype.render=function(e){},e.prototype.syncState=function(e){},e.prototype.repaint=function(){var e=this.getElement(!1);if(e)this.render(e)},e.prototype.initBehavior=function(e){},e.prototype.getElement=function(e){var i=this.control.helper.getPart("layer");if(!i&&e!==!1)if(i=this.create(),this.render(i),o.addClasses(i,n(this)),this.initBehavior(i),this.control.helper.addDOMEvent(document,"mousedown",r.bind(t,this)),this.control.helper.addDOMEvent(i,"mousedown",function(e){e.stopPropagation()}),this.syncState(i),!i.parentElement)document.body.appendChild(i);return i},e.prototype.hide=function(){var e=n(this),t=this.getElement();o.addClasses(t,e),this.control.removeState("active")},e.prototype.show=function(){var e=this.getElement();e.style.zIndex=this.getZIndex(),this.position();var t=n(this);o.removeClasses(e,t),this.control.addState("active")},e.prototype.toggle=function(){var e=this.getElement();if(!e||this.control.helper.isPart(e,"layer-hidden"))this.show();else this.hide()},e.prototype.position=function(){var t=this.getElement();e.attachTo(t,this.control.main,this.dock)},e.prototype.getZIndex=function(){return e.getZIndex(this.control.main)},e.prototype.dispose=function(){var e=this.getElement(!1);if(e)e.innerHTML="",o.removeNode(e);this.control=null};var s=1e3;return e.create=function(e){var t=document.createElement(e||"div");return t.style.position="absolute",t},e.getZIndex=function(e){return 10},e.moveToTop=function(e){e.style.zIndex=++s},e.moveTo=function(e,t,n){i(e,{top:t,left:n})},e.resize=function(e,t,n){i(e,{width:t,height:n})},e.attachTo=function(e,t,n){n=n||{strictWidth:!1};var r=o.page.getViewWidth(),a=o.page.getViewHeight(),s=o.page.getScrollTop(),u=o.page.getScrollLeft(),l=o.getOffset(t),c=e.style.display;if(e.style.display="block",e.style.top="-5000px",e.style.left="-5000px",n.strictWidth)e.style.minWidth=l.width+"px";var f=o.getOffset(e);e.style.top="",e.style.left="",e.style.display=c;var h={};if(n.direction){if("up"===n.direction.vertical)h.top=l.top-f.height;else h.top=l.bottom;if("left"===n.direction.horizon)h.left=l.left;else h.left=l.right-f.width}else{var p=a-(l.bottom-s),d=l.top-s;if(p<=f.height&&d>f.height)h.top=l.top-f.height;else h.top=l.bottom;var v=r-(l.left-u),g=l.right-u;if(v<=f.width&&g>f.width)h.left=l.right-f.width;else h.left=l.left}i(e,h)},e.centerToView=function(e,t){var n=t?o.clone(t):{};if("number"!=typeof n.width)n.width=this.width;if("number"!=typeof n.height)n.height=this.height;n.left=(o.page.getViewWidth()-n.width)/2;var i=o.page.getViewHeight();if(n.height>=i&&t.hasOwnProperty("minTop"))n.top=t.minTop;else n.top=Math.floor((i-n.height)/2);var r=o.page.getViewWidth();if(n.height>=r&&t.hasOwnProperty("minLeft"))n.left=t.minLeft;else n.left=Math.floor((r-n.width)/2);n.top+=o.page.getScrollTop(),this.setProperties(n)},e});