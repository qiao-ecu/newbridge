define(function(require){function e(e,t){if("function"==typeof e){var i=e.prototype.type;if(i in t)throw new Error(i+" is exists!");t[i]=e}}function t(e,t,i){var n=i[e];if(n)return delete t.type,new n(t);else return null}var i=require("./lib"),n={};n.version="3.1.0-beta.3";var r=require("./ViewContext"),a=new r("default");n.getViewContext=function(){return a};var o={uiPrefix:"data-ui",extensionPrefix:"data-ui-extension",customElementPrefix:"esui",instanceAttr:"data-ctrl-id",viewContextAttr:"data-ctrl-view-context",uiClassPrefix:"ui",skinClassPrefix:"skin",stateClassPrefix:"state"};n.config=function(e){i.extend(o,e)},n.getConfig=function(e){return o[e]},n.parseAttribute=function(e,t){if(!e)return{};for(var n={},r=0,a=0;a<e.length;){for(;a<e.length&&":"!==e.charAt(a);)a++;if(a>=e.length)break;var o=i.trim(e.slice(r,a));for(a++,r=a;a<e.length&&";"!==e.charAt(a);)a++;for(var s=a+1;s<e.length;){var l=e.charAt(s);if(";"===l)a=s;if(":"===l)break;s++}var d=i.trim(e.slice(r,a));n[o]=t?t(d):d,a++,r=a}return n},n.getControlByDOM=function(e){if(!e)return null;var t,i=n.getConfig,a=e.getAttribute(i("instanceAttr")),o=e.getAttribute(i("viewContextAttr"));if(a&&o&&(t=r.get(o)))return t.get(a);else return null};var s={};n.register=function(t){e(t,s)},n.create=function(e,i){return t(e,i,s)},n.get=function(e){return a.get(e)},n.getSafely=function(e){return a.getSafely(e)};var l=require("./ControlCollection");n.wrap=function(){for(var e=new l,t=0;t<arguments.length;t++)e.add(arguments[t]);return e},n.init=function(e,t){function i(e){function t(e){return e.toUpperCase()}for(var i=1,n=e.length;n>i;i++)e[i]=e[i].replace(/^[a-z]/,t);return e.join("")}function r(e,t){for(var i in t)if(!(i in e))e[i]=t[i]}function a(e,t,a){if(0===t.length)r(e,n.parseAttribute(a,s));else e[i(t)]=s(a)}e=e||document.body,t=t||{};for(var s=t.valueReplacer||function(e){return e},l=e.getElementsByTagName("*"),d=[],u=0,c=l.length;c>u;u++)if(1===l[u].nodeType)d.push(l[u]);for(var h=n.getConfig("uiPrefix"),f=n.getConfig("extensionPrefix"),p=n.getConfig("customElementPrefix"),g=h.length,v=f.length,m=t.properties||{},y=[],u=0,c=d.length;c>u;u++){var x=d[u];if(!x.getAttribute(o.instanceAttr)){for(var b=x.attributes,w={},C={},P=0,I=b.length;I>P;P++){var T=b[P],E=T.name,S=T.value;if(0===E.indexOf(f)){var M=E.slice(v+1).split("-"),D=M[0];M.shift();var N=C[D];if(!N)N=C[D]={};a(N,M,S)}else if(0===E.indexOf(h)){var M=E.length==g?[]:E.slice(g+1).split("-");a(w,M,S)}}var O=w.type;if(!O){var k=x.nodeName.toLowerCase(),V=k.indexOf(p);if(0===V){var A=k.replace(/-(\S)/g,function(e,t){return t.toUpperCase()});A=A.slice(p.length),w.type=A,O=A}}if(O){var L=w.id,R=L?m[L]:{};for(var $ in R)w[$]=s(R[$]);var H=w.extensions||[];w.extensions=H;for(var $ in C){var N=C[$],B=n.createExtension(N.type,N);B&&H.push(B)}w.viewContext=t.viewContext,w.renderOptions=t,w.main=x;var j=n.create(O,w);if(j){if(y.push(j),t.parent)t.parent.addChild(j);try{j.render()}catch(F){var q=new Error('Render control "'+(j.id||"anonymous")+'" of type '+j.type+" failed because: "+F.message);throw q.actualError=F,q}}}}else;}return y};var d={};n.registerExtension=function(t){e(t,d)},n.createExtension=function(e,i){return t(e,i,d)};var u={};n.attachExtension=function(e,t){u[e]=t},n.createGlobalExtensions=function(){for(var e=u,t=[],i=0,r=e.length;r>i;i++){var a,o=e[i],s=o.type;if(s)a=n.create(s,o);a&&t.push(a)}return t};var c=[];return n.registerRule=function(e,t){c.push({type:e,priority:t}),c.sort(function(e,t){return e.priority-t.priority})},n.createRulesByControl=function(e){for(var t=[],i=0;i<c.length;i++){var n=c[i].type;if(null!=e.get(n.prototype.type))t.push(new n)}return t},n});