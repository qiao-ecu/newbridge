define(function(require){function e(e){u.apply(this,arguments)}function t(e){var t=e.main;if(t){for(var i,n=l.getChildren(t),r=n.length,a={};r--;)if(i=n[r].getAttribute("data-role"))a[i]=n[r];e.roles=a}}function i(e,t){if(t)e.title=t.innerHTML;else if(t=document.createElement("h3"),e.main.firstChild)l.insertBefore(t,e.main.firstChild);else e.main.appendChild(t);var i=[].concat(d.getPartClasses(e,"title"));l.addClasses(t,i);var n={main:t,childName:"title"},r=h.create("Label",n);return r.render(),e.addChild(r),r}function n(e,t,i){if(i)e.content=i.innerHTML;else if(i=document.createElement("div"),"body"==t){var n=e.getChild("title");if(n)l.insertAfter(i,n.main);else if(e.main.firstChild)l.insertBefore(i,n,e.main.firstChild);else e.main.appendChild(i)}else e.main.appendChild(i);l.addClasses(i,d.getPartClasses(e,t+"-panel"));var r={main:i,renderOptions:e.renderOptions},a=h.create("Panel",r);return a.render(),e.addChild(a,t),a}function r(e,t,i){if(e.isShow)e.autoPosition(t,i)}function a(e,t,i,n){if(t)clearTimeout(e.showTimeout),clearTimeout(e.hideTimeout),e.showTimeout=setTimeout(l.bind(e.show,e,i,n),t);else e.show(i,n)}function o(e,t){clearTimeout(e.showTimeout),clearTimeout(e.hideTimeout),e.hideTimeout=setTimeout(l.bind(e.hide,e),t)}function s(e,t){if("string"==typeof t)t=e.viewContext.get(t);return t.main}require("./Button"),require("./Label"),require("./Panel");var l=require("./lib"),d=require("./controlHelper"),u=require("./Control"),h=require("./main"),c=require("./painters");return e.prototype={type:"TipLayer",initOptions:function(e){t(e);var i={roles:{}};l.extend(i,e),this.setProperties(i)},initStructure:function(){var e=this.main;if(e.parentNode&&"body"!==e.parentNode.nodeName.toLowerCase())document.body.appendChild(e);if(this.main.style.left="-10000px",this.title||this.roles.title)i(this,this.roles.title);if(n(this,"body",this.roles.content),this.foot||this.roles.foot)n(this,"foot",this.roles.foot);if(this.arrow){var t=document.createElement("div");t.id=d.getId(this,"arrow"),t.className=d.getPartClasses(this,"arrow").join(" "),this.main.appendChild(t)}},repaint:d.createRepaint(u.prototype.repaint,c.style("width"),c.style("height"),{name:"title",paint:function(e,t){var n=e.getHead();if(null==t){if(n)e.removeChild(n)}else{if(!n)n=i(e);n.setText(t)}}},{name:"content",paint:function(e,t){var i='<div class="${class}" id="${id}">${content}</div>',n=e.getBody(),r=d.getId(e,"body"),a=d.getPartClasses(e,"body"),o={"class":a.join(" "),id:r,content:t};n.setContent(l.format(i,o))}},{name:"foot",paint:function(e,t){var i='<div class="${class}" id="${id}">${content}</div>',r=d.getId(e,"foot"),a=d.getPartClasses(e,"foot"),o=e.getFoot();if(null==t){if(o)e.removeChild(o)}else{var s={"class":a.join(" "),id:r,content:t};if(!o)o=n(e,"foot");o.setContent(l.format(i,s))}}},{name:["targetDOM","targetControl","showMode","positionOpt","delayTime"],paint:function(e,t,i,n,r,a){var o={targetDOM:t,targetControl:i,showMode:n,delayTime:a};if(r)r=r.split("|"),o.positionOpt={top:r[0]||"top",right:r[1]||"left"};e.attachTo(o)}}),autoPosition:function(e,t){var i=this,n=this.main;t=t||{left:"right",top:"top"};var r=e.getBoundingClientRect(),a=l.getOffset(e),o={top:r.top,right:r.right,bottom:r.bottom,left:r.left,width:r.right-r.left,height:r.bottom-r.top},s=n.style.display;n.style.display="block";var u=n.offsetHeight,h=n.offsetWidth;n.style.display="none";var c=l.clone(t),f=l.page.getViewWidth(),p=l.page.getViewHeight(),g=o.left-h,v=f-o.right-h,m=p-o.top-u,y=o.bottom-u;if(g>=0)if(v>=0){if(!c.right&&!c.left)if(g>v)c.left="right",c.right=null;else c.right="left",c.left=null}else c.left="right",c.right=null;else c.right="left",c.left=null;if(m>=0)if(y>=0){if(!c.bottom&&!c.top)if(m>y)c.top="top",c.bottom=null;else c.bottom="bottom",c.top=null}else c.top="top",c.bottom=null;else c.bottom="bottom",c.top=null;var x,w={};if(c.right)if(w.left=a.right,c.top)x="lt";else x="lb";else if(c.left)if(w.left=a.left-h,c.top)x="rt";else x="rb";if(c.top)w.top=a.top;else if(c.bottom)w.top=a.bottom-u;n.style.display=s,n.className=""+d.getPartClasses(i).join(" ")+" "+d.getPartClasses(i,x).join(" ");var b=l.g(d.getId(i,"arrow"));if(b)b.className=""+d.getPartClasses(i,"arrow").join(" ")+" "+d.getPartClasses(i,"arrow-"+x).join(" ");i.renderLayer(n,w)},renderLayer:function(e,t){var i=l.clone(t||{});if(i.hasOwnProperty("top")&&i.hasOwnProperty("bottom"))i.height=i.bottom-i.top,delete i.bottom;if(i.hasOwnProperty("left")&&i.hasOwnProperty("right"))i.width=i.right-i.left,delete i.right;if(i.hasOwnProperty("top")||i.hasOwnProperty("bottom"))e.style.top="",e.style.bottom="";if(i.hasOwnProperty("left")||i.hasOwnProperty("right"))e.style.left="",e.style.right="";for(var n in i)if(i.hasOwnProperty(n))e.style[n]=i[n]+"px"},attachTo:function(e){var t,i,n=e.showMode||"over";if("over"===n)t="mouseover",i="mouseout";else if("click"===n)t="click",i="click";var r;if(e.targetDOM)r=l.g(e.targetDOM);else if(e.targetControl)r=s(this,e.targetControl);if(r){if("auto"===n)this.show(r,e);else d.addDOMEvent(this,r,t,l.curry(a,this,e.delayTime,r,e.positionOpt)),d.addDOMEvent(this,this.main,"mouseover",l.bind(this.show,this,r,e.positionOpt)),d.addDOMEvent(this,this.main,"mouseout",l.curry(o,this,150));if("mouseout"===i)d.addDOMEvent(this,r,i,l.curry(o,this,150))}},getHead:function(){return this.getChild("title")},getBody:function(){return this.getChild("body")},getFoot:function(){return this.getChild("foot")},show:function(e,t){if(d.isInStage(this,"INITED"))this.render();else if(d.isInStage(this,"DISPOSED"))return;clearTimeout(this.hideTimeout),d.addDOMEvent(this,window,"resize",l.curry(r,this,e,t)),this.main.style.zIndex=d.layer.getZIndex(e),this.removeState("hidden"),this.autoPosition(e,t),this.fire("show"),this.isShow=!0},hide:function(){if(this.isShow)this.addState("hidden");this.fire("hide"),this.isShow=!1},setTitle:function(e){this.setProperties({title:e})},setContent:function(e){this.setProperties({content:e})},setFoot:function(e){this.setProperties({foot:e})},dispose:function(){if(!d.isInStage(this,"DISPOSED")){this.hide();var e=this.main.id;l.removeNode(e),u.prototype.dispose.apply(this,arguments)}}},e.onceNotice=function(e){function t(e){var t=e.onok,i="function"==typeof t;if(i)t(e);e.fire("ok"),e.dispose()}var i="tipLayer-once-notice",n="tipLayer-notice-ok",r=l.encodeHTML(e.content)||"",a={type:"onceNotice",skin:"onceNotice",arrow:!0};l.extend(a,e);var o=document.createElement("div");document.body.appendChild(o);var s=d.getGUID(i);a.id=s,a.main=o,a.type=null;var u=h.create("TipLayer",a);u.setContent(r);var c=e.okText||"知道了";u.setFoot('<div data-ui="type:Button;childName:okBtn;id:'+s+"-"+n+';width:50;"class="'+d.getPartClasses(u,"once-notice")+'">'+c+"</div>"),u.render();var f=u.getFoot().getChild("okBtn");return f.on("click",l.curry(t,u,"ok")),u.attachTo({targetDOM:e.targetDOM,targetControl:e.targetControl,showMode:"auto",positionOpt:{top:"top",right:"left"}}),u},l.inherits(e,u),h.register(e),e});