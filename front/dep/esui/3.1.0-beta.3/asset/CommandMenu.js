define(function(require){function e(e){for(var t=e.target;t!==e.currentTarget&&!i.hasAttribute(t,"data-index");)t=t.parentNode;var n=+t.getAttribute("data-index"),r=this.datasource[n];if(!r.disabled)if(this.layer.hide(),t!==e.currentTarget){if(r)if("function"==typeof r.handler)r.handler.call(this,r,n);this.fire("select",{item:r,index:n}),this.set("activeIndex",n)}}function t(){a.apply(this,arguments),this.dock=this.control.dock||this.dock}function n(){o.apply(this,arguments),this.layer=new t(this)}var r=require("underscore"),i=require("./lib"),o=require("./Control"),a=require("./Layer");i.inherits(t,a),t.prototype.nodeName="ul",t.prototype.dock={strictWidth:!0},t.prototype.render=function(e){for(var t="",n=0;n<this.control.datasource.length;n++){var r=this.control.helper.getPartClasses("node");if(n===this.control.activeIndex)r.push.apply(r,this.control.helper.getPartClasses("node-active"));if(this.control.datasource[n].disabled)r.push.apply(r,this.control.helper.getPartClasses("node-disabled"));t+='<li data-index="'+n+'" class="'+r.join(" ")+'">',t+=this.control.getItemHTML(this.control.datasource[n])}e.innerHTML=t},t.prototype.initBehavior=function(t){this.control.helper.addDOMEvent(t,"click",e)},n.prototype.type="CommandMenu",n.prototype.itemTemplate="<span>${text}</span>",n.prototype.getItemHTML=function(e){var t={text:r.escape(e.text)};return i.format(this.itemTemplate,t)},n.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"click",r.bind(this.layer.toggle,this.layer)),this.resizeHideLayerEvent=r.bind(this.layer.hide,this.layer),this.helper.addDOMEvent(window,"resize",this.resizeHideLayerEvent)};var s=require("./painters");return n.prototype.repaint=s.createRepaint(o.prototype.repaint,s.style("width"),s.style("height"),{name:"datasource",paint:function(e){e.layer.repaint()}},{name:"activeIndex",paint:function(e){e.layer.repaint()}},s.text("displayText"),{name:["disabled","hidden","readOnly"],paint:function(e,t,n,r){if(t||n||r)e.layer.hide()}}),n.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;this.helper.removeDOMEvent(window,"resize",this.resizeHideLayerEvent),o.prototype.dispose.apply(this,arguments)}},i.inherits(n,o),require("./main").register(n),n});