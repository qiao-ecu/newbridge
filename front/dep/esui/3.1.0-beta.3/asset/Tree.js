define(function(require){function e(){m.apply(this,arguments)}function t(){p.apply(this,arguments)}function i(e,t,i,n,r){var a=r-n,o=0===a?"current":1===a?"previous":"far-previous",s=[].concat(v.getPartClasses(e,"node-indicator"),v.getPartClasses(e,"node-indicator-"+i),v.getPartClasses(e,"node-indicator-level-"+n),v.getPartClasses(e,"node-indicator-"+o)),l=0===a?y[i||"collapsed"]:"第"+n+"级",d="<span ";if(0===a)d+='id="'+v.getId(e,"indicator-"+t.id)+'" ';return d+='class="'+s.join(" ")+'">'+l+"</span>"}function n(e,t,n,r){var o=v.getPartClasses(e,"content-wrapper");if(e.selectedNodeIndex[t.id])o=o.concat(v.getPartClasses(e,"content-wrapper-selected"));if(e.strategy.isLeafNode(t))o.push("leaf-node");else o.push("folder-node");o=o.join(" ");for(var s=v.getId(e,"content-wrapper-"+t.id),l='<div id="'+s+'" class="'+o+'">',d=e.strategy.isLeafNode(t)?"empty":r?"expanded":"collapsed",u=0;n>=u;u++)l+=i(e,t,d,u,n);var c=v.getPartClasses(e,"item-content");if(r&&e.strategy.isLeafNode(t))c.push("leaf-node");if(l+='<div class="'+c.join(" ")+'">'+e.getItemHTML(t)+"</div>",l+="</div>",r&&!e.strategy.isLeafNode(t)){var h=[].concat(v.getPartClasses(e,"sub-root"),v.getPartClasses(e,"sub-root-"+d));l+='<ul class="'+h.join(" ")+'">';for(var u=0;u<t.children.length;u++){var f=t.children[u];l+=a(e,f,n+1,e.strategy.shouldExpand(f))}l+="</ul>"}return l}function r(e,t,i,n){var r=e.strategy.isLeafNode(t)?"empty":n?"expanded":"collapsed",a=[].concat(v.getPartClasses(e,"node"),v.getPartClasses(e,"node-"+r),v.getPartClasses(e,"node-level-"+i));if(t===e.datasource)a=[].concat(v.getPartClasses(e,"root"),v.getPartClasses(e,"root-"+r),a);return a}function a(e,t,i,a,o){o=o||"li";var s=r(e,t,i,a),l="<"+o+' class="'+s.join(" ")+'" id="'+v.getId(e,"node-"+t.id)+'" data-id="'+t.id+'" data-level="'+i+'">';return l+=n(e,t,i,a),l+="</"+o+">"}function o(e){var t=e.target,i=v.getPartClasses(this,"node-indicator")[0],n=g.hasClass(t,i),r=!n;if(!n){for(var a=v.getPartClasses(this,"content-wrapper")[0];t&&t!==this.main&&!g.hasClass(t,a);)t=t.parentNode;if(g.hasClass(t,a))n=this.wideToggleArea,r=r&&!0}if(n||r){for(;t&&t!==this.main&&!g.hasAttribute(t,"data-id");)t=t.parentNode;if(g.hasClass(t.firstChild,"folder-node"))n=!0,r=!1;else n=!1,r=!0;var o=t.getAttribute("data-id");if(n)this.triggerToggleStrategy(o);if(r)this.triggerSelectStrategy(o)}}function s(e){for(var t=e.target;t&&t!==this.main&&!g.hasAttribute(t,"data-id");)t=t.parentNode;var i=t.getAttribute("data-id");if(g.hasClass(t.firstChild,"leaf-node")){var n=this.nodeIndex[i];this.fire("dbclickLeafNode",{node:n})}}function l(e,t){if(t=t||{},t[e.id]=e,e.children)for(var i=0;i<e.children.length;i++)l(e.children[i],t);return t}function d(e,t){if(e.selectedNodeIndex[t.id])return!1;else return e.selectedNodes.push(t),e.selectedNodeIndex[t.id]=t,!0}function u(e,t){if(e.selectedNodeIndex[t.id]){delete e.selectedNodeIndex[t.id];for(var i=0;i<e.selectedNodes.length;i++)if(e.selectedNodes[i]===t)e.selectedNodes.splice(i,1);return!0}return!1}function c(e,t,i){if(i.force||e.allowUnselectNode){var n=e.nodeIndex[t];if(n){var r=u(e,n);if(r){if(i.modifyDOM){var a=g.g(v.getId(e,"content-wrapper-"+t));v.removePartClasses(e,"content-wrapper-selected",a)}if(!i.silent)e.fire("unselectnode",{node:n}),e.fire("selectionchange")}}}}function h(e,t){var i=v.getPartClasses(e,"node-empty")[0];return g.hasClass(t,i)}function f(e,t){var i=v.getPartClasses(e,"node-expanded")[0];return g.hasClass(t,i)}var p=require("./Control"),g=require("./lib"),v=require("./controlHelper"),m=require("./TreeStrategy");e.prototype.attachTo=function(){},g.inherits(e,m),t.prototype.type="Tree",t.defaultProperties={selectMode:"single",hideRoot:!1},t.prototype.initOptions=function(i){var n={datasource:{},strategy:new e,selectedNodes:[],selectedNodeIndex:{}},r=g.extend(n,t.defaultProperties,i);if(null==r.allowUnselectNode)r.allowUnselectNode="single"!==r.selectMode;this.setProperties(r)},t.prototype.itemTemplate="<span>${text}</span>",t.prototype.getItemHTML=function(e){var t={id:g.encodeHTML(e.id),text:g.encodeHTML(e.text)};return g.format(this.itemTemplate,t)};var y={collapsed:"展开",expanded:"收起",busy:"加载中",empty:"无内容"};return t.prototype.clickNode=function(e){o.apply(this,arguments)},t.prototype.dbclickNode=function(e){s.apply(this,arguments)},t.prototype.initStructure=function(){this.strategy.attachTo(this)},t.prototype.initEvents=function(){v.addDOMEvent(this,this.main,"click",this.clickNode),v.addDOMEvent(this,this.main,"dblclick",this.dbclickNode)},t.prototype.repaint=v.createRepaint(p.prototype.repaint,{name:"datasource",paint:function(e,t){e.selectedNodes=[],e.selectedNodeIndex={},e.nodeIndex=l(t),e.main.innerHTML=a(e,t,0,!0,"div")}},{name:"hideRoot",paint:function(e,t){var i=t?"addState":"removeState";e[i]("hide-root")}}),t.prototype.triggerSelectStrategy=function(e){var t=this.nodeIndex[e];if(t)if(this.selectedNodeIndex[e])this.fire("unselect",{node:t});else this.fire("select",{node:t})},t.prototype.getSelectedNodes=function(){return this.selectedNodes.slice()},t.prototype.toggleNodeSelection=function(e){var t=this.selectedNodeIndex[e]?"unselectNode":"selectNode";this[t](e)},t.prototype.selectNode=function(e,t){var i=this.nodeIndex[e];if(i){var n=d(this,i);if(n){if("single"===this.selectMode&&this.selectedNodes.length>1)c(this,this.selectedNodes[0].id,{force:!0,silent:!0,modifyDOM:!0});var r=g.g(v.getId(this,"content-wrapper-"+e));if(v.addPartClasses(this,"content-wrapper-selected",r),!t)this.fire("selectnode",{node:i}),this.fire("selectionchange")}}},t.prototype.unselectNode=function(e){c(this,e,{force:!0,silent:!1,modifyDOM:!0})},t.prototype.expandNode=function(e,t){var i=g.g(v.getId(this,"node-"+e));if(i){var a=+g.getAttribute(i,"data-level");if(t||"ul"!==i.lastChild.nodeName.toLowerCase()){var o=this.nodeIndex[e];if(!o)return;if(t){if(o.children)for(var s=0;s<o.children.length;s++)c(this,o.children[s].id,{force:!0,silent:!0,modifyDOM:!1}),this.nodeIndex[o.children[s].id]=void 0;o.children=t,l(o,this.nodeIndex)}i.innerHTML=n(this,o,a,!0)}else{var d=g.g(v.getId(this,"indicator-"+e));d.innerHTML=y.expanded;var u=[].concat(v.getPartClasses(this,"node-indicator"),v.getPartClasses(this,"node-indicator-level-"+a),v.getPartClasses(this,"node-indicator-current"),v.getPartClasses(this,"node-indicator-expanded"));d.className=u.join(" ");var h=[].concat(v.getPartClasses(this,"sub-root"),v.getPartClasses(this,"sub-root-expanded"));i.lastChild.className=h.join(" ")}var o=this.nodeIndex[e],f=r(this,o,a,!0);i.className=f.join(" ")}},t.prototype.collapseNode=function(e,t){var i=g.g(v.getId(this,"node-"+e));if(i){var n=this.nodeIndex[e],a=i.getElementsByTagName("ul")[0];if(a)if(t){if(a.parentNode.removeChild(a),n.children)for(var o=0;o<n.children.length;o++)c(this,n.children[o].id,{force:!0,silent:!1,modifyDOM:!1})}else{var s=[].concat(v.getPartClasses(this,"sub-root"),v.getPartClasses(this,"sub-root-collapsed"));a.className=s.join(" ")}var l=+g.getAttribute(i,"data-level"),d=r(this,n,l,!1);i.className=d.join(" ");var u=g.g(v.getId(this,"indicator-"+e)),h=[].concat(v.getPartClasses(this,"node-indicator"),v.getPartClasses(this,"node-indicator-level-"+l),v.getPartClasses(this,"node-indicator-current"),v.getPartClasses(this,"node-indicator-collapsed"));u.className=h.join(" "),u.innerHTML=y.collapsed}},t.prototype.toggleNode=function(e,t,i){if(this.nodeIndex[e]){var n=g.g(v.getId(this,"node-"+e));if(n)if(!h(this,n))if(f(this,n))this.collapseNode(e,i);else this.expandNode(e,t)}},t.prototype.triggerToggleStrategy=function(e){var t=this.nodeIndex[e];if(t){var i=g.g(v.getId(this,"node-"+e));if(i)if(!h(this,i))if(f(this,i))this.fire("collapse",{node:t});else this.fire("expand",{node:t})}},t.prototype.indicateNodeLoading=function(e){var t=g.g(v.getId(this,"node-"+e));if(t){for(var i=g.getChildren(t),n=0;!this.helper.isPart(i[n],"item-content");)n++;var r=i[n];r.innerHTML=y.busy;var a=[].concat(v.getPartClasses(this,"node-indicator"),v.getPartClasses(this,"node-indicator-level-"+n),v.getPartClasses(this,"node-indicator-current"),v.getPartClasses(this,"node-indicator-busy"));r.className=a.join(" ")}},t.prototype.dispose=function(){p.prototype.dispose.apply(this,arguments),this.nodeIndex=null,this.selectedNodes=null,this.selectedNodeIndex=null},require("./main").register(t),g.inherits(t,p),t});