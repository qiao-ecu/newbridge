define(function(require){function e(e,t){e.setAttribute("contentEditable",t?"true":"false")}function t(e){return"true"==e.getAttribute("contentEditable")}function i(t){return e(t,!0),t.innerHTML=v,t}function n(e,t){var i=e.innerHTML,n=document.createElement("div");return n.innerHTML=i.replace(/\r|\n/gi,"").replace(/<p[^>]*><br\/?><\/p>/gi,"<faketag></faketag>").replace(/<br\/?>/gi,"</p><p>").replace(/<p[^>]*>\s*<\/p>/gi,"<p><br/></p>").replace(/<faketag><\/faketag>/gi,"<p><br/></p>").replace(y,""),t.setStyles({},n),n.innerHTML}function r(e,t){e.innerHTML=t}function a(e){var t=[];return c(e,function(e,i){e=e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),t.push(e+":"+i)}),t.join(";")}function o(e){var t={};return e=e.split(";"),c(e,function(e){if(e){e=e.split(":");var i=e[0],n=e[1];i=i.replace(/-+(.)?/g,function(e,t){return t=t.replace(/^\s+|\s+$/g,""),t?t.toUpperCase():""}),t[i]=n}}),t}function s(e,t){c(t,function(t,i){e.style[t]=i})}function l(e,t){try{var i=new FileReader;i.onload=function(i){e.emit("screenshotpaste",{src:i.target.result,blob:t})},i.readAsDataURL(t)}catch(n){}}function u(e){function t(e){if(!e.stopPropagation)e.stopPropagation=function(){this.cancelBubble=!0};if(!e.preventDefault)e.preventDefault=function(){this.returnValue=!1};return e.stop=function(){this.stopPropagation(),this.preventDefault()},e}function i(i){if(i=t(i||window.event),i.ctrlKey)switch(i.keyCode){case 66:var n=e.isBold(),r=n?"normal":"bold";e.setStyles({fontWeight:r}),e.emit("ctrlB",!n),i.stop();break;case 73:var a=e.isItalic(),r=a?"normal":"italic";e.setStyles({fontStyle:r}),e.emit("ctrlI",!a),i.stop();break;case 85:var o=e.isUnderline(),r=o?"none":"underline";e.setStyles({textDecoration:r}),e.emit("ctrlU",!o),i.stop()}if(8===i.keyCode&&e.main.innerHTML===v)i.stop();e.emit("keydown",i)}function n(i){if(i=t(i||window.event),i.clipboardData&&i.clipboardData.getData)if(/Files/.test(i.clipboardData.types)){var n=i.clipboardData.items[0].getAsFile();l(e,n)}else{var r=i.clipboardData.getData("text/plain");i.clipboardData.getData("text/html");if(""===r)i.stop();else{var a=p.staticHTMLFilter(r);e.insert("text",a),i.stop()}}else if(window.clipboardData)if(clipboardData.files&&clipboardData.files.length>0){i.stop();var n=clipboardData.files[0];l(e,n)}}function r(t){e._cursor=g.getRange(e.main)}function a(t){e._cursor=null}var o=e.main;o.addEventListener("keydown",i,!1),o.addEventListener("paste",n,!1),o.addEventListener("blur",r,!1),o.addEventListener("focus",a,!1),o.ondrop=function(){return!1}}function d(e){f.mixin(this),this.styles={},this.plugins={text:require("./plugins/text"),html:require("./plugins/html"),face:require("./plugins/face"),br:require("./plugins/br"),img:require("./plugins/img")},this.main=i(e.main),u(this),this.setStyles(h(m,e.styles||{})),c(e.plugins||[],function(e){this.plugin(e)},this)}var c=require("im-lib/lang/each"),h=require("im-lib/lang/extend"),f=require("im-lib/Emitter"),p=require("im-filter"),g=require("./selection"),v="<p><br></p>",m={fontFamily:"宋体",fontSize:"14px"},y=new RegExp("(^(<p[^>]*>(<br/?>|\\s*&nbsp;\\s*)*</p>)+)|((<p[^>]*>(<br/?>|\\s*&nbsp;\\s*)*</p>)+$)","ig");return d.prototype.setStyles=function(e,t){e=e||{},this.styles=h(this.styles,e);for(var i=t||this.main,n=0;n<i.childNodes.length;n++)if("P"===i.childNodes[n].tagName)s(i.childNodes[n],this.styles);s(this.main,e)},d.prototype.getStyles=function(){return h({},this.styles)},d.prototype.isBold=function(){var e=this.getStyles(),t=e.fontWeight;return"bold"===t},d.prototype.isItalic=function(){var e=this.getStyles(),t=e.fontStyle;return"italic"===t},d.prototype.isUnderline=function(){var e=this.getStyles(),t=e.textDecoration;return"underline"===t},d.prototype.getContent=function(){var e=[n(this.main,this)];if(e[0])e.unshift('<div style="'+a(this.styles)+'">'),e.push("</div>");return e.join("")},d.prototype.setContent=function(e){if(e){var t=document.createDocumentFragment();t.innerHTML=e;var i=t.firstChild||this.main,n=o(i.style.cssText),a=this;c(n,function(e,t){if(a.styles[e]!=t)a.emit("stylechange",e,t,a.styles[e])}),this.setStyles(n),r(this.main,e)}},d.prototype.plugin=function(e){this.plugins[e.name]=e},d.prototype.insertElements=function(e,t){if(!(e instanceof Array))e=[e];if(e.length)g.insertNodes(this.main,e,t,this._cursor)},d.prototype.insert=function(e,t,i){var n=this.plugins[e];if(n&&"function"==typeof n.insert)n.insert(this,t,i),this.setStyles()},d.prototype.focus=function(){var e=this.main;e.focus();var t=e.getElementsByTagName("p")[0];g.setRange(t.firstChild||t)},d.prototype.clear=function(){r(this.main,v),this.setStyles(),this.main.blur(),this.main.focus()},d.prototype.enable=function(){e(this.main,!0)},d.prototype.disable=function(){e(this.main,!1)},d.prototype.isEnabled=function(){return t(this.main)},d});