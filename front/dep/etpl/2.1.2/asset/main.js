!function(e){function t(e,t){for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i];return e}function i(){this.raw=[],this.length=0}function n(){return"___"+O++}function r(e,t){var i=new Function;i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}function a(e){return N[e]}function o(e){return'"'+e.replace(/\x5C/g,"\\\\").replace(/"/g,'\\"').replace(/\x0A/g,"\\n").replace(/\x09/g,"\\t").replace(/\x0D/g,"\\r")+'"'}function s(e){var t=arguments;return e.replace(/\{([0-9]+)\}/g,function(e,i){return t[i-0+1]})}function l(e){return e=e.replace(/^\s*\*/,""),s('gv({0},["{1}"])',o(e),e.replace(/\[['"]?([^'"]+)['"]?\]/g,function(e,t){return"."+t}).split(".").join('","'))}function d(e,t,i,n,r,a){for(var o=i.length,s=e.split(t),l=0,d=[],u=0,c=s.length;c>u;u++){var h=s[u];if(u){var f=1;for(l++;;){var p=h.indexOf(i);if(0>p){d.push(l>1&&f?t:"",h);break}if(l=n?l-1:0,d.push(l>0&&f?t:"",h.slice(0,p),l>0?i:""),h=h.slice(p+o),f=0,0===l)break}if(0===l)r(d.join("")),a(h),d=[]}else h&&a(h)}if(l>0&&d.length>0)a(t),a(d.join(""))}function u(e,t,i){var n,r=[],a=t.options,s="",c="",h="",f="";if(i)s="ts(",c=")",h=A,f=L,n=a.defaultFilter;return d(e,a.variableOpen,a.variableClose,1,function(e){if(i&&e.indexOf("|")<0&&n)e+="|"+n;var a=e.indexOf("|"),o=(a>0?e.slice(0,a):e).replace(/^\s+/,"").replace(/\s+$/,""),d=a>0?e.slice(a+1):"",p=0===o.indexOf("*"),g=[p?"":s,l(o),p?"":c];if(d){d=u(d,t);for(var v=d.split("|"),m=0,y=v.length;y>m;m++){var x=v[m];if(/^\s*([a-z0-9_-]+)(\((.*)\))?\s*$/i.test(x)){if(g.unshift('fs["'+RegExp.$1+'"]('),RegExp.$3)g.push(",",RegExp.$3);g.push(")")}}}r.push(h,g.join(""),f)},function(e){r.push(h,i?o(e):e,f)}),r.join("")}function c(e,t){this.value=e,this.engine=t}function h(e,t){this.value=e,this.engine=t,this.children=[]}function f(e,t){var i=e.stack,n=t?i.find(function(e){return e instanceof t}):i.bottom();if(n){var r;do{if(r=i.top(),!r.autoClose)throw new Error(r.type+" must be closed manually: "+r.value);r.autoClose(e)}while(r!==n)}return n}function p(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.master=RegExp.$3,this.name=RegExp.$1,h.call(this,e,t),this.contents={}}function g(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.master=RegExp.$3,this.name=RegExp.$1,h.call(this,e,t),this.contents={}}function v(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,h.call(this,e,t)}function m(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,h.call(this,e,t)}function y(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,h.call(this,e,t)}function x(e,t){if(!/^\s*([a-z0-9_]+)\s*=([\s\S]*)$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.expr=RegExp.$2,h.call(this,e,t)}function b(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(([\s\S]*)\))?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.args=RegExp.$3,h.call(this,e,t)}function w(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(([\s\S]*)\))?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.args=RegExp.$3,h.call(this,e,t)}function C(e,t){if(!/^\s*(\$\{[\s\S]+\})\s+as\s+\$\{([0-9a-z_]+)\}\s*(,\s*\$\{([0-9a-z_]+)\})?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.list=RegExp.$1,this.item=RegExp.$2,this.index=RegExp.$4,h.call(this,e,t)}function P(e,t){h.call(this,e,t)}function I(e,t){P.call(this,e,t)}function E(e,t){h.call(this,e,t)}function T(e,t){t.targetOrMaster=e;var i=t.engine,n=e.name,r=e instanceof p,a=r?"targets":"masters";if(i[a][n])switch(i.options.namingConflict){case"override":i[a][n]=e,r&&t.targets.push(n);case"ignore":break;default:throw new Error((r?"Target":"Master")+" is exists: "+n)}else i[a][n]=e,r&&t.targets.push(n)}function S(e,t){B[e]=t,t.prototype.type=e}function M(e){this.options={commandOpen:"<!--",commandClose:"-->",variableOpen:"${",variableClose:"}",defaultFilter:"html"},this.config(e),this.masters={},this.targets={},this.filters=t({},k)}function D(e,t){function n(){if(p.length>0){var e=p.join(""),i=new c(e,t);if(i.beforeAdd(u),l.top().addTextNode(i),p=[],t.options.strip&&u.current instanceof h)i.value=e.replace(/^[\x20\t\r]*\n/,"");u.current=i}}function r(e){return e instanceof a}var a,o=t.options.commandOpen,s=t.options.commandClose,l=new i,u={engine:t,targets:[],stack:l},p=[];return d(e,o,s,0,function(e){var i=/^\s*(\/)?([a-z]+)\s*(:([\s\S]*))?$/.exec(e);if(i&&(a=B[i[2].toLowerCase()])&&"function"==typeof a){n();var d=u.current;if(t.options.strip&&d instanceof c)d.value=d.value.replace(/\r?\n[\x20\t]*$/,"\n");if(i[1])d=l.find(r),d&&d.close(u);else{if(d=new a(i[4],t),"function"==typeof d.beforeOpen)d.beforeOpen(u);d.open(u)}u.current=d}else if(!/^\s*\/\//.test(e))p.push(o,e,s);a=null},function(e){p.push(e)}),n(),f(u),u.targets}i.prototype={push:function(e){this.raw[this.length++]=e},pop:function(){if(this.length>0){var e=this.raw[--this.length];return this.raw.length=this.length,e}},top:function(){return this.raw[this.length-1]},bottom:function(){return this.raw[0]},find:function(e){for(var t=this.length;t--;){var i=this.raw[t];if(e(i))return i}}};var O=178245,N={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},k={html:function(e){return e.replace(/[&<>"']/g,a)},url:encodeURIComponent,raw:function(e){return e}},V='var r="";',A="r+=",L=";",R="return r;";if("undefined"!=typeof navigator&&/msie\s*([0-9]+)/i.test(navigator.userAgent)&&RegExp.$1-0<8)V="var r=[],ri=0;",A="r[ri++]=",R='return r.join("");';c.prototype={getRendererBody:function(){var e=this.value,t=this.engine.options;if(!e||t.strip&&/^\s*$/.test(e))return"";else return u(e,this.engine,1)},getContent:function(){return this.value}},h.prototype={addChild:function(e){this.children.push(e)},open:function(e){var t=e.stack.top();this.parent=t,t&&t.addChild(this),e.stack.push(this)},close:function(e){for(;e.stack.pop().constructor!==this.constructor;);},addTextNode:function(e){this.addChild(e)},getRendererBody:function(){for(var e=[],t=this.children,i=0;i<t.length;i++)e.push(t[i].getRendererBody());return e.join("")}};var $='data=data||{};var v={},fs=engine.filters,hg=typeof data.get=="function",gv=function(n,ps){var p=ps[0],d=v[p];if(d==null){if(hg){return data.get(n);}d=data[p];}for(var i=1,l=ps.length;i<l;i++)if(d!=null)d = d[ps[i]];return d;},ts=function(s){if(typeof s==="string"){return s;}if(s==null){s="";}return ""+s;};';r(p,h),r(g,h),r(v,h),r(m,h),r(y,h),r(x,h),r(b,h),r(w,h),r(C,h),r(P,h),r(I,P),r(E,h);var H={READING:1,READED:2,APPLIED:3,READY:4};g.prototype.close=g.prototype.autoClose=p.prototype.close=p.prototype.autoClose=function(e){h.prototype.close.call(this,e),this.state=this.master?H.READED:H.APPLIED,e.targetOrMaster=null},p.prototype.applyMaster=g.prototype.applyMaster=function(){if(this.state>=H.APPLIED)return 1;var e=this.engine.masters[this.master];if(e&&e.applyMaster()){this.children=[];for(var t=0,i=e.children.length;i>t;t++){var n=e.children[t];if(n instanceof m)this.children.push.apply(this.children,(this.contents[n.name]||n).children);else this.children.push(n)}return this.state=H.APPLIED,1}},p.prototype.isReady=function(){function e(n){for(var r=0,a=n.children.length;a>r;r++){var o=n.children[r];if(o instanceof y){var s=t.targets[o.name];i=i&&s&&s.isReady(t)}else if(o instanceof h)e(o)}}if(this.state>=H.READY)return 1;var t=this.engine,i=1;if(this.applyMaster())return e(this),i&&(this.state=H.READY),i;else return void 0},p.prototype.getRenderer=function(){if(this.renderer)return this.renderer;if(this.isReady()){var e=new Function("data","engine",[$,V,this.getRendererBody(),R].join("\n")),t=this.engine;return this.renderer=function(i){return e(i,t)},this.renderer}return null},p.prototype.getContent=function(){if(this.isReady()){for(var e=[],t=this.children,i=0;i<t.length;i++)e.push(t[i].getContent());return e.join("")}return""},p.prototype.open=g.prototype.open=function(e){f(e),h.prototype.open.call(this,e),this.state=H.READING,T(this,e)},y.prototype.open=x.prototype.open=w.prototype.open=function(e){var t=e.stack.top();this.parent=t,t.addChild(this)},w.prototype.beforeOpen=y.prototype.beforeOpen=x.prototype.beforeOpen=C.prototype.beforeOpen=b.prototype.beforeOpen=P.prototype.beforeOpen=c.prototype.beforeAdd=function(e){if(!e.stack.bottom()){var t=new p(n(),e.engine);t.open(e)}},w.prototype.close=y.prototype.close=E.prototype.close=x.prototype.close=function(){},y.prototype.getContent=function(){var e=this.engine.targets[this.name];return e.getContent()},y.prototype.getRendererBody=function(){var e=this.engine.targets[this.name];return e.getRendererBody()},w.prototype.getRendererBody=function(){return s("{0}engine.render({2},{{3}}){1}",A,L,o(this.name),u(this.args,this.engine).replace(/(^|,)\s*([a-z0-9_]+)\s*=/gi,function(e,t,i){return(t||"")+o(i)+":"}))},x.prototype.getRendererBody=function(){if(this.expr)return s("v[{0}]={1};",o(this.name),u(this.expr,this.engine));else return""},P.prototype.getRendererBody=function(){var e=s("if({0}){{1}}",u(this.value,this.engine),h.prototype.getRendererBody.call(this)),t=this["else"];if(t)return[e,s("else{{0}}",t.getRendererBody())].join("");else return e},C.prototype.getRendererBody=function(){return s('var {0}={1};if({0} instanceof Array)for (var {4}=0,{5}={0}.length;{4}<{5};{4}++){v[{2}]={4};v[{3}]={0}[{4}];{6}}else if(typeof {0}==="object")for(var {4} in {0}){v[{2}]={4};v[{3}]={0}[{4}];{6}}',n(),u(this.list,this.engine),o(this.index||n()),o(this.item),n(),n(),h.prototype.getRendererBody.call(this))},b.prototype.getRendererBody=function(){var e=this.args;return s("{2}fs[{5}]((function(){{0}{4}{1}})(){6}){3}",V,R,A,L,h.prototype.getRendererBody.call(this),o(this.name),e?","+u(e,this.engine):"")},v.prototype.open=function(e){f(e,v),h.prototype.open.call(this,e),e.targetOrMaster.contents[this.name]=this},m.prototype.open=function(e){f(e,m),h.prototype.open.call(this,e)},v.prototype.autoClose=P.prototype.autoClose=h.prototype.close,m.prototype.autoClose=function(e){var t=this.parent.children;t.push.apply(t,this.children),this.children.length=0,this.close(e)},P.prototype.addChild=function(e){var t=this["else"];(t?t.children:this.children).push(e)},I.prototype.open=function(e){var t=new E;t.open(e);var i=f(e,P);i.addChild(this),e.stack.push(this)},E.prototype.open=function(e){var t=f(e,P);t["else"]=this,e.stack.push(t)};var B={};S("target",p),S("master",g),S("content",v),S("contentplaceholder",m),S("import",y),S("use",w),S("var",x),S("for",C),S("if",P),S("elif",I),S("else",E),S("filter",b),M.prototype.config=function(e){t(this.options,e)},M.prototype.compile=M.prototype.parse=function(e){if(e){var t=D(e,this);if(t.length)return this.targets[t[0]].getRenderer()}return new Function('return ""')},M.prototype.getRenderer=function(e){var t=this.targets[e];if(t)return t.getRenderer();else return void 0},M.prototype.get=function(e){var t=this.targets[e];if(t)return t.getContent();else return""},M.prototype.render=function(e,t){var i=this.getRenderer(e);if(i)return i(t);else return""},M.prototype.addFilter=function(e,t){if("function"==typeof t)this.filters[e]=t};var j=new M;if(j.Engine=M,"object"==typeof exports&&"object"==typeof module)exports=module.exports=j;else if("function"==typeof define&&define.amd)define(j);else e.etpl=j}(this);